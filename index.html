<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#111827">
    <title>Gym PWA</title>
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        :root {
            --bg: #0b1220;
            --card: #121a2b;
            --muted: rgba(255,255,255,0.6);
            --text: #fff;
            --primary: #2e7d32;
            --accent: #4f46e5;
            --danger: #dc3545;
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            background: linear-gradient(180deg, #0b1220 0%, #0d1626 100%);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container { padding: 16px 16px 96px; }
        .page { display: none; }
        .page.active { display: block; }

        .header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; position: sticky; top: 0; z-index: 10;
            background: rgba(11,18,32,0.7); backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .header h1 { margin: 0; font-size: 1.25rem; letter-spacing: 0.3px; }
        .header .actions { display: flex; gap: 8px; }
        .icon-btn { border: 0; background: #18233a; color: #cfd7ff; padding: 8px 10px; border-radius: 10px; cursor: pointer; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .card {
            background: radial-gradient(120% 120% at 100% 0%, rgba(79,70,229,0.08) 0%, rgba(255,255,255,0) 60%),
                       linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px; padding: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.25);
        }
        .card h3 { margin: 0 0 8px 0; font-size: 0.95rem; opacity: 0.8; }
        .card .big { font-size: 1.8rem; font-weight: 800; letter-spacing: 0.5px; }

        /* Pesquisas/inputs */
        .search {
            display: grid; grid-template-columns: 1fr auto auto; gap: 10px; margin: 10px 0 16px;
        }
        .input {
            width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.04); color: var(--text); outline: none;
        }
        .btn { border: 0; padding: 10px 12px; border-radius: 12px; color: #fff; cursor: pointer; font-weight: 700; }
        .btn.primary { background: var(--primary); }
        .btn.accent  { background: var(--accent); }
        .btn.ghost { background: rgba(255,255,255,0.08); }
        .btn.danger { background: var(--danger); }

        /* Listas */
        .list { display: grid; gap: 10px; }
        .list-item {
            display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 10px;
            padding: 12px; background: #111b30; border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px;
        }
        .list-item .title { font-weight: 800; }
        .list-item .subtitle { font-size: 0.9rem; opacity: 0.7; }
        .kebab { border: 0; background: rgba(255,255,255,0.08); color: #cfd7ff; padding: 6px 8px; border-radius: 10px; cursor: pointer; }

        /* Navbar */
        .navbar {
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 20;
            display: grid; grid-template-columns: repeat(5,1fr); gap: 4px; align-items: end;
            background: rgba(11,18,32,0.86); backdrop-filter: blur(10px);
            padding: 6px 10px 12px; border-top: 1px solid rgba(255,255,255,0.08);
        }
        .nav-item { text-align: center; font-size: 0.7rem; opacity: 0.8; }
        .nav-icon { font-size: 1.2rem; display: block; margin-bottom: 4px; }
        .nav-item.active { opacity: 1; color: #fff; }

        /* TOAST - Alterado para fora do ecrã inicialmente */
        .toast { 
            position: fixed; 
            left: 50%; 
            transform: translateX(-50%); 
            top: -100px; /* Inicialmente fora do ecrã */
            background: #1f2937; 
            color: #fff; 
            padding: 10px 14px; 
            border-radius: 10px;
            opacity: 0; 
            transition: all .3s ease; 
            z-index: 50;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .toast.show { 
            opacity: 1;
            top: 70px; /* Posição quando mostra */
        }

        /* MODAIS */
        .weight-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.55); z-index: 2000; overflow-y: auto; }
        .weight-modal-content { max-width: 420px; margin: 40px auto; background: #fff; color: #111; border-radius: 18px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.35); position: relative; }
        .modal-title { margin: 0 0 12px; font-size: 1.3rem; font-weight: 800; text-align: center; }
        .form-group { margin: 10px 0; }
        .form-label { font-weight: 700; font-size: 0.9rem; color: #111; margin-bottom: 6px; display: block; }
        .form-input, .form-select { width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; }
        .modal-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .modal-btn { padding: 10px 12px; border: 0; border-radius: 12px; font-weight: 800; cursor: pointer; }
        .btn-cancel { background: #f3f4f6; }
        .btn-save { background: #2e7d32; color: #fff; }
        .btn-danger { background: #fee2e2; color: #b00020; }
        .modal-exercise-select {
            width: 100%;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0,12);
            background: rgba(255, 255, 255, 0,04);
            color: black;
            outline: none;
            margin-bottom: 12px;
        }

        /* Página EXERCÍCIO - Detalhes */
        .exercise-detail-header { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; width: 100%; }
        .back-button { border: none; background: #18233a; color: #cfd7ff; padding: 8px 10px; border-radius: 10px; cursor: pointer; }
        .exercise-detail-title { margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; padding-right: 8px; /* Espaço para evitar que encoste no botão */}
        .edit-exercise-button { border: none; background: #f5f5f5; border-radius: 12px; padding: 8px 12px; font-size: 1.1rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .edit-exercise-button i { pointer-events: none; }
        .exercise-media-card { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin: 14px 0 10px; }
        .media-box { position: relative; border: 2px dashed #e0e0e0; border-radius: 16px; height: 160px; display: flex; align-items: center; justify-content: center; background: #fafafa; }
        .media-label { font-weight: 600; opacity: 0.7; }
        .media-menu { position: absolute; top: 8px; right: 8px; border: none; background: white; border-radius: 12px; padding: 6px 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.12); cursor: pointer; }

        .plan-day-exercises-list { margin-top: 8px; }
        .exercise-row { display: flex; align-items: center; justify-content: space-between; background: #fff; color:#111; border-radius: 14px; padding: 10px 12px; margin: 8px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
        .exercise-row-main { display: flex; flex-direction: column; gap: 2px; }
        .exercise-row-name { font-weight: 800; }
        .exercise-row-meta { font-size: 0.9rem; opacity: 0.7; }
        .exercise-row-options { border: none; background: #f3f3f3; border-radius: 12px; padding: 6px 8px; cursor: pointer; }
        .add-exercise-inline { width: 100%; border: none; border-radius: 14px; padding: 10px 12px; background: #f7f7f7; color:#111; margin-top: 8px; cursor: pointer; }

        .plan-detail-footer { display: grid; gap: 12px; margin-top: 12px; position: static; bottom: 92px; }
        .btn-remove-plan { flex: 1; background: #ffe7e7; color: #b00020; border: none; padding: 12px; border-radius: 14px; font-weight: 800; cursor: pointer; }
        .btn-save-plan { flex: 2; background: #2e7d32; color: white; border: none; padding: 12px; border-radius: 14px; font-weight: 800; cursor: pointer; }

        .exercise-media-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin: 14px 0 10px;
        }

        .exercise-media-box {
            position: relative;
            border: 2px dashed #e0e0e0;
            border-radius: 16px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
            overflow: hidden;
        }

        .exercise-media-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .exercise-media-label {
            font-weight: 600;
            opacity: 0.7;
            position: absolute;
            z-index: 1;
        }

        .exercise-media-menu {
            position: absolute;
            top: 8px;
            right: 8px;
            border: none;
            background: white;
            border-radius: 12px;
            padding: 6px 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            cursor: pointer;
            z-index: 2;
        }

        .exercise-media-options {
            position: absolute;
            top: 35px;
            right: 5px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }

        .exercise-media-option {
            padding: 10px 14px;
            cursor: pointer;
            color: #111;
            border-bottom: 1px solid #f0f0f0;
        }

        .exercise-media-option:last-child {
            border-bottom: none;
        }

        .exercise-media-option:hover {
            background: #f5f5f5;
        }

        /* Estilo para a lista de exercícios com miniaturas */
        .exercise-list-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #111b30;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px;
        }

        .exercise-thumbnail {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            background: #18233a;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .exercise-thumbnail i {
            font-size: 1.2rem;
            opacity: 0.7;
        }

        /* Garante que modais personalizados não aparecem no fim das páginas */
        .plan-modal { display: none; }

        #weightCard {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        #weightCard button {
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
        }
        
        /* Estilo para a lista de pesos */
        #weightList {
            margin-top: 20px;
            display: grid;
            gap: 10px;
        }
        #weightList li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--card);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            color: var(--text);
        }
        .delete-weight-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
        }

        /* estilo simples para os day-cards - MODIFICADO para usar a cor original */
        .day-card {
            padding: 14px;
            margin-bottom: 16px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
            background: var(--card);
            position: relative;
            cursor: default;
            border: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .day-card h5 { margin: 0 0 6px 0; font-weight: 700; color: var(--text); }
        .day-card small { color: var(--muted); }

        /* Quadrado do dia - NOVO */
        .day-number-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            background: var(--accent);
            border-radius: 8px;
            font-weight: bold;
        }
        .day-number-box div:first-child {
            font-size: 0.7rem;
            opacity: 0.8;
        }
        .day-number-box div:last-child {
            font-size: 1.2rem;
        }

        /* Estilo para a lista de seleção de planos */
        .plan-selection-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            color: white;
        }
        .plan-selection-item:hover {
            background: rgba(255,255,255,0.05);
        }
        .plan-selection-item:last-child {
            border-bottom: none;
        }
        .plan-selection-item .title {
            font-weight: 700;
            margin-bottom: 4px;
        }
        .plan-selection-item .subtitle {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Espaçamento na página de peso */
        #weightPage .card {
            margin-bottom: 16px;
        }

        /* Página de detalhes do dia - REDESENHADA conforme a imagem */
        .day-detail-exercise {
            background: var(--card);
            color: var(--text);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .day-detail-exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .day-detail-exercise-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin: 0;
        }
        .day-detail-exercise-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .day-detail-exercise-sets {
            font-weight: 600;
        }
        .day-detail-exercise-weight {
            font-weight: 600;
            color: var(--primary);
        }
        .start-workout-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 1.1rem;
            width: 100%;
            margin-top: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Página de treinos (histórico) - MODIFICADO conforme solicitado */
        .workout-item-compact {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            cursor: pointer;
        }
        .workout-header-compact {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .workout-title-compact {
            font-weight: 700;
            font-size: 1rem;
            margin: 0;
        }
        .workout-date-compact {
            opacity: 0.7;
            font-size: 0.85rem;
            text-align: right;
        }
        .workout-details-compact {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
        }
        .workout-day-compact {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .workout-duration-compact {
            font-size: 0.9rem;
            opacity: 0.8;
            text-align: right;
        }

        .workout-exercise {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .workout-exercise:last-child {
            border-bottom: none;
        }

        /* Modal para alterar mídia */
        .media-options {
            position: absolute;
            top: 35px;
            right: 5px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }
        .media-option {
            padding: 10px 14px;
            cursor: pointer;
            color: #111;
            border-bottom: 1px solid #f0f0f0;
        }
        .media-option:last-child {
            border-bottom: none;
        }
        .media-option:hover {
            background: #f5f5f5;
        }

        /* NOVAS PÁGINAS PARA O FLUXO DE TREINO */
        /* Página de exercícios do treino */
        .workout-exercise-item {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .workout-exercise-info {
            flex: 1;
        }
        .workout-exercise-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin: 0 0 4px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        .workout-exercise-details {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        .workout-exercise-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
        }
        .workout-exercise-btn:disabled {
            background: var(--muted);
            cursor: not-allowed;
        }
        .finish-workout-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 1.1rem;
            width: 100%;
            margin-top: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Página de execução do exercício - MODIFICADO conforme solicitado */
        .exercise-execution-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            position: relative;
        }
        .exercise-execution-title {
            font-weight: 700;
            font-size: 1.3rem;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        .exercise-info-btn {
            border: none;
            background: var(--accent);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
        }
        .timer-btn-small {
            border: none;
            background: var(--primary);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }
        .timer-active {
            background: var(--accent);
        }
        .series-grid {
            display: grid;
            gap: 8px;
            margin-bottom: 20px;
        }
        .series-item {
            background: var(--card);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            align-items: center;
        }
        .series-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            grid-column: 1 / 3;
        }
        .series-number {
            font-weight: 700;
        }
        .series-inputs {
            display: contents;
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        .input-label {
            font-size: 0.8rem;
            margin-bottom: 4px;
            opacity: 0.7;
            text-align: center;
        }
        .series-input {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.04);
            color: var(--text);
            outline: none;
            text-align: center;
            font-size: 0.9rem;
        }
        .warmup-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .finish-exercise-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 1.1rem;
            width: 100%;
            margin-top: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .finish-exercise-btn:disabled {
            background: var(--muted);
            cursor: not-allowed;
        }

        /* Página de resumo do treino */
        .workout-summary-item {
            background: linear-gradient(135deg, rgba(79,70,229,0.15) 0%, rgba(46,125,50,0.15) 100%);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }

        .summary-title {
            font-weight: 800;
            font-size: 1.4rem;
            margin: 0;
            background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .summary-duration {
            font-size: 1rem;
            opacity: 0.9;
            background: rgba(255,255,255,0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .summary-exercise {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            transition: all 0.3s ease;
        }

        .summary-exercise:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .summary-exercise:last-child {
            margin-bottom: 0;
        }

        .summary-exercise-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--text);
        }

        .summary-exercise-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 0.9rem;
        }

        .summary-exercise-details div {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
        }

        /* Modal de detalhes do treino - MODIFICADO conforme solicitado */
        .workout-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            overflow-y: auto;
        }
        .workout-detail-content {
            max-width: 500px;
            margin: 40px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .workout-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            position: relative;
        }
        .workout-detail-title {
            font-weight: 700;
            font-size: 1.2rem;
            margin: 0;
        }
        .workout-detail-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 3001;
        }
        .workout-detail-info {
            margin-bottom: 16px;
            display: grid;
            gap: 8px;
        }
        .workout-detail-info-item {
            display: flex;
            justify-content: space-between;
        }
        .workout-detail-info-label {
            font-weight: 600;
            opacity: 0.8;
        }
        .workout-detail-info-value {
            text-align: right;
        }
        .workout-detail-exercises {
            margin-top: 16px;
        }
        .workout-detail-exercise {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .workout-detail-exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .workout-detail-exercise-name {
            font-weight: 700;
            margin-bottom: 8px;
        }
        .workout-detail-exercise-details {
            display: none;
            margin-top: 8px;
        }
        .workout-detail-exercise.expanded .workout-detail-exercise-details {
            display: block;
        }
        .workout-detail-exercise-sets {
            opacity: 0.8;
            margin-bottom: 4px;
        }
        .workout-detail-set {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }
        .workout-detail-set-header {
            font-weight: 600;
            opacity: 0.7;
        }

        /* ===== ESTILOS ADICIONADOS PARA AS CORREÇÕES ===== */
        
        /* Espaçamento na página de treinos */
        #workoutsPage .card {
            margin-bottom: 16px; /* Adiciona espaçamento entre o card e a lista */
        }
        
        /* Estilo para a lista de histórico de treinos na página de exercícios */
        .exercise-history-list {
            margin-top: 16px;
            display: grid;
            gap: 12px;
        }
        
        .exercise-history-item {
            background: linear-gradient(135deg, rgba(79,70,229,0.08) 0%, rgba(46,125,50,0.08) 100%);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255,255,255,0.08);
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        .exercise-history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .exercise-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .exercise-history-date {
            font-weight: 700;
            font-size: 1rem;
            margin: 0;
        }

        .exercise-history-avg {
            font-weight: 700;
            color: var(--primary);
            background: rgba(46,125,50,0.15);
            padding: 4px 8px;
            border-radius: 8px;
        }

        .exercise-history-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .exercise-history-detail-item {
            display: flex;
            flex-direction: column;
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
        }

        .exercise-history-detail-label {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-bottom: 4px;
        }

        .exercise-history-detail-value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .exercise-history-expand-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .exercise-history-expand-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(180deg);
        }
        
        .exercise-history-sets {
            margin-top: 12px;
            font-size: 0.85rem;
            opacity: 0.7;
            display: none;
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
        }

        .exercise-history-sets.expanded {
            display: block;
        }
        
        .exercise-history-set {
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
        }

        .exercise-history-set:last-child {
            border-bottom: none;
        }
        
        /* Botão de eliminar treino no modal */
        .delete-workout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            width: 100%;
        }

        /* NOVOS ESTILOS PARA AS CORREÇÕES SOLICITADAS */
        
        /* Modal para adicionar exercício */
        .add-exercise-modal-content {
            max-width: 420px;
            margin: 40px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
            position: relative;
        }
        
        /* Modal para editar nome do exercício */
        .edit-exercise-name-modal-content {
            max-width: 420px;
            margin: 40px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
            position: relative;
        }
        
        /* Modal para confirmar remoção de exercício */
        .confirm-delete-modal-content {
            max-width: 420px;
            margin: 40px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
            position: relative;
            text-align: center;
        }
        
        /* Botão de remover exercício na página de detalhes */
        .delete-exercise-button {
            border: none;
            background: #ffebee;
            color: #d32f2f;
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-left: 8px;
        }
        
        .exercise-detail-header-buttons {
            display: flex;
            gap: 8px;
            flex-shrink: 0; /* Impede que os botões diminuam */
        }

        /* NOVOS ESTILOS PARA A MODAL DE GESTÃO DO DIA */
        .day-management-modal-content {
            max-width: 500px;
            margin: 40px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
            position: relative;
        }
        
        .day-management-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .day-management-title {
            font-weight: 700;
            font-size: 1.2rem;
            margin: 0;
        }
        
        .day-management-exercise-list {
            margin: 16px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .day-management-exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: move;
        }
        
        .day-management-exercise-info {
            flex: 1;
        }
        
        .day-management-exercise-name {
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .day-management-exercise-details {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .day-management-exercise-remove {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
        }
        
        .day-management-footer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        /* NOVO ESTILO PARA OS DIAS NA PÁGINA DE DETALHES DO PLANO */
        .plan-day-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--card);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        
        .plan-day-info {
            flex: 1;
        }
        
        .plan-day-name {
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .plan-day-exercises-count {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .plan-day-options {
            background: rgba(255,255,255,0.08);
            color: #cfd7ff;
            border: none;
            border-radius: 8px;
            padding: 8px 10px;
            cursor: pointer;
        }

        /* Estilo para modais sobrepostas - CORREÇÃO DO PROBLEMA */
        .day-options-modal-active {
            z-index: 2001 !important;
        }
        
        /* CORREÇÃO: Aumentar z-index da modal de edição do nome do dia */
        #editDayNameModal {
            z-index: 2001 !important;
        }

        /* NOVOS ESTILOS PARA FILTROS E ORDENAÇÃO */
        .filter-modal-content {
            max-width: 420px;
            margin: 40px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .filter-options {
            display: grid;
            gap: 16px;
            margin-bottom: 20px;
        }

        .filter-option-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(255,255,255,0.05);
            padding: 16px;
            border-radius: 12px;
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        .filter-checkbox:last-child {
            border-bottom: none;
        }

        .filter-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
        }

        .filter-checkbox label {
            font-weight: 500;
        }
        
        /* Estilo para a página de gestão de dia (nova página) */
        .day-management-page-content {
            padding: 16px;
        }
        
        .day-management-page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .day-management-page-title {
            font-weight: 700;
            font-size: 1.2rem;
            margin: 0;
        }
        
        .day-management-page-exercise-list {
            margin: 16px 0;
        }
        
        .day-management-page-exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--card);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(255,255,255,0.08);
            cursor: grab;
        }
        
        .day-management-page-exercise-item:active {
            cursor: grabbing;
        }
        
        .day-management-page-exercise-info {
            flex: 1;
        }
        
        .day-management-page-exercise-name {
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .day-management-page-exercise-details {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .day-management-page-exercise-edit {
            background: rgba(255,255,255,0.08);
            color: #cfd7ff;
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            margin-right: 8px;
        }
        
        .day-management-page-exercise-remove {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
        }
        
        .day-management-page-add-exercise {
            width: 100%;
            margin-top: 16px;
        }

        /* Estilo para a página de treinos com pesquisa */
        .workouts-search {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        /* Estilo para o botão de retomar treino */
        .resume-workout-card {
            background: var(--accent);
            color: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .resume-workout-info {
            flex: 1;
        }
        
        .resume-workout-title {
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .resume-workout-details {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .resume-workout-btn {
            background: white;
            color: var(--accent);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-weight: 700;
            cursor: pointer;
        }

        /* Botão Iniciar Treino na Home */
        .start-workout-btn-home {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-left: auto;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-date {
            font-size: 0.7rem;
            opacity: 0.6;
        }

        .stat-subtext {
            font-size: 0.7rem;
            opacity: 0.6;
        }

        /* Confirmation Modal css */
        #confirmExitModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3002 !important;
        }

        #confirmExitModal .weight-modal-content {
            max-width: 400px;
            margin: 100px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        #confirmExitModal p {
            margin: 15px 0;
            text-align: center;
            line-height: 1.5;
        }

        #confirmExitModal .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        #deletePlanConfirmModal {
            z-index: 3003 !important;
        }

        #deleteExerciseConfirmModal {
            z-index: 3004 !important;
        }

        /* Add this CSS for the delete confirmation modal */
        #deleteWorkoutConfirmModal {
            z-index: 3001 !important;
        }

        #deleteWorkoutConfirmModal .weight-modal-content {
            max-width: 400px;
            background: var(--card);
            color: var(--text);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }

        #deleteWorkoutConfirmModal p {
            margin: 15px 0;
            line-height: 1.5;
        }

        #dayManagementPage .exercise-detail-header {
            grid-template-columns: auto minmax(0, 1fr) auto;
        }

        #dayManagementPage .exercise-detail-title {
            max-width: 65vw; /* Limita a largura máxima para garantir espaço para os botões */
        }

        /* Adicionar estes estilos para destacar objetivos atualizados */
        .plan-updated {
            animation: highlightUpdate 2s ease;
            border-left: 4px solid var(--primary) !important;
        }

        .plan-option:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .plan-options-menu {
            backdrop-filter: blur(10px);
        }

        @keyframes highlightUpdate {
            0% { background-color: rgba(46, 125, 50, 0.3); }
            100% { background-color: transparent; }
        }

        .updated-badge {
            background-color: var(--primary);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* NOVOS ESTILOS PARA AS MODIFICAÇÕES SOLICITADAS */
        
        /* Modal para mostrar detalhes do exercício concluído */
        .exercise-completed-modal-content {
            max-width: 500px;
            margin: 40px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
            position: relative;
        }
        
        .exercise-completed-details {
            margin: 16px 0;
        }
        
        .exercise-completed-set {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .exercise-completed-set:last-child {
            border-bottom: none;
        }
        
        .exercise-completed-target {
            margin: 16px 0;
            padding: 12px;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
        }
        
        .target-updated {
            background: rgba(46,125,50,0.2);
            border-left: 4px solid var(--primary);
        }
        
        .target-old {
            color: var(--muted);
            text-decoration: line-through;
            margin-right: 8px;
        }
        
        .target-new {
            color: var(--primary);
            font-weight: 700;
        }
        
        /* Estilo para exercícios concluídos na workoutPage */
        .workout-exercise-completed {
            background: rgba(46,125,50,0.1);
            border-left: 4px solid var(--primary);
        }
        
        .workout-exercise-options-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text);
            border-radius: 8px;
            padding: 8px 10px;
            cursor: pointer;
        }
        
        /* Modal de confirmação para terminar exercício com séries em falta */
        #confirmFinishExerciseModal .weight-modal-content,
        #confirmFinishWorkoutModal .weight-modal-content {
            max-width: 400px;
            background: var(--card);
            color: var(--text);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }
        
        #confirmFinishExerciseModal p,
        #confirmFinishWorkoutModal p {
            margin: 15px 0;
            line-height: 1.5;
        }
        
        .missing-exercises-list {
            text-align: left;
            margin: 16px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .missing-exercise-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .missing-exercise-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 500px) {
             .series-inputs {
                grid-template-columns: 1fr 1fr !important;
                gap: 4px;
            }
            
            .series-item {
                padding: 8px;
                grid-template-columns: 1fr;
            }
            
            .input-group {
                margin-bottom: 0;
            }
            
            .input-label {
                font-size: 0.7rem;
            }
            
            .series-input {
                padding: 6px 4px;
                font-size: 0.8rem;
            }
            
            /* Garantir que o cabeçalho da série ocupe a largura total */
            .series-header {
                grid-column: 1 / 3;
                margin-bottom: 6px;
            }
            
            .header .actions {
                display: none;
            }
        }
        /* Adicionar estas regras CSS para corrigir o layout em ecrãs pequenos */
        @media (max-width: 430px) {
            .series-item {
                padding: 6px;
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .series-inputs {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 4px;
                width: 100%;
            }
            
            .input-group {
                margin-bottom: 0;
                min-width: 0; /* Permite que os inputs se ajustem melhor */
            }
            
            .input-label {
                font-size: 0.65rem;
                margin-bottom: 2px;
            }
            
            .series-input {
                padding: 4px 4px;
                font-size: 0.75rem;
                width: 100%;
                box-sizing: border-box;
            }
            
            /* Garantir que o cabeçalho da série ocupe a largura total */
            .series-header {
                grid-column: 1 / 3;
                margin-bottom: 4px;
                font-size: 0.75rem;
            }
            
            /* Ajustar o padding geral do card para economizar espaço */
            .card {
                padding: 10px;
            }
        }

        @media (max-width: 360px) {
            #dayManagementPage .exercise-detail-title {
                max-width: 55vw;
            }
            
            .exercise-detail-header-buttons {
                gap: 4px;
            }
            
            .edit-exercise-button, 
            .delete-exercise-button {
                padding: 6px 8px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>GYM</h1>
        <div class="actions">
            <!-- Removido conforme solicitado -->
        </div>
    </div>

    <div class="container">
        <!-- HOME - Adicionado card de retomar treino -->
        <div id="mainPage" class="page active">
            <div id="resumeWorkoutCard" class="resume-workout-card" style="display: none;" onclick="resumeWorkout()">
                <div class="resume-workout-info">
                    <div class="resume-workout-title">Treino em Progresso</div>
                    <div class="resume-workout-details" id="resumeWorkoutDetails">Clique para retomar</div>
                </div>
                <button class="resume-workout-btn">Retomar</button>
            </div>

            <div class="stats-grid">
                <div class="card">
                    <h3>Peso Atual</h3>
                    <div class="big" id="currentWeightLabel">0 kg</div>
                    <div class="big">
                        <button class="btn ghost" onclick="openWeightModal()"><i class="bi bi-plus-circle"></i> Adicionar Peso</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Plano Selecionado</h3>
                    <div class="big" id="selectedPlanLabel">—</div>
                    <div class="big">
                        <button class="btn accent" onclick="openPlanSelection()"><i class="bi bi-list-check"></i> Escolher Plano</button>
                    </div>
                </div>
            </div>

            <div id="selectedPlanDays" style="margin-top:16px;"></div>

        </div>

        <!-- EXERCÍCIOS - Adicionado botão de filtro -->
        <div id="exercisesPage" class="page">
            <div class="search">
                <input id="exerciseSearch" class="input" placeholder="Procurar exercício..." oninput="renderExercises()" />
                <button class="btn accent" onclick="openAddExerciseModal()"><i class="bi bi-plus-circle"></i></button>
                <button class="btn ghost" onclick="openExerciseFilterModal()"><i class="bi bi-funnel"></i></button>
            </div>
            <div id="exercisesList" class="list">
                <!-- Mensagem será mostrada aqui via JavaScript -->
            </div>
        </div>

        <!-- DETALHES DO EXERCÍCIO -->
        <div id="exerciseDetailPage" class="page">
            <div class="exercise-detail-header">
                <button class="back-button" onclick="closeExerciseDetail()"><i class="bi bi-arrow-left"></i></button>
                <h1 class="exercise-detail-title" id="exerciseDetailTitle">Nome do Exercício</h1>
                <div class="exercise-detail-header-buttons">
                    <button class="edit-exercise-button" onclick="openEditExerciseNameModal()"><i class="bi bi-pencil"></i></button>
                    <button class="delete-exercise-button" onclick="openDeleteExerciseModal()"><i class="bi bi-trash"></i></button>
                </div>
            </div>

            <div class="exercise-media-container">
                <div class="exercise-media-box" id="exerciseImageBox">
                    <span class="exercise-media-label">Imagem</span>
                    <button class="exercise-media-menu" onclick="openExerciseMediaMenu('image', event)">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <div class="exercise-media-options" id="imageOptions">
                        <div class="exercise-media-option" onclick="changeExerciseMedia('image')">Alterar Imagem</div>
                        <div class="exercise-media-option" onclick="removeExerciseMedia('image')">Remover Imagem</div>
                    </div>
                </div>
                <div class="exercise-media-box" id="exerciseGifBox">
                    <span class="exercise-media-label">GIF</span>
                    <button class="exercise-media-menu" onclick="openExerciseMediaMenu('gif', event)">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <div class="exercise-media-options" id="gifOptions">
                        <div class="exercise-media-option" onclick="changeExerciseMedia('gif')">Alterar GIF</div>
                        <div class="exercise-media-option" onclick="removeExerciseMedia('gif')">Remover GIF</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Notas</h3>
                <textarea id="exerciseNotes" class="input" rows="4" placeholder="Notas sobre execução, dicas, etc."></textarea>
                <div style="text-align:right; margin-top:8px;"><button class="btn primary" onclick="saveExerciseNotes()">Guardar Notas</button></div>
            </div>

            <div class="card" style="margin-bottom: 14px; margin-top: 14px;">
                <h3>Estatísticas do Exercício</h3>
                <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                    <div class="stat-item">
                        <div class="stat-label">Peso Máximo</div>
                        <div class="stat-value" id="statMaxWeight">0 kg</div>
                        <div class="stat-date" id="statMaxWeightDate">—</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total de Sessões</div>
                        <div class="stat-value" id="statTotalSessions">0</div>
                        <div class="stat-subtext">vezes realizado</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Média de Peso</div>
                        <div class="stat-value" id="statAvgWeight">0 kg</div>
                        <div class="stat-subtext">por repetição</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Volume Total</div>
                        <div class="stat-value" id="statTotalVolume">0 kg</div>
                        <div class="stat-subtext">carga acumulada</div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:14px;">
                <h3>Histórico</h3>
                <canvas id="exerciseChart" height="180"></canvas>
            </div>
            
            <!-- Lista de histórico de treinos adicionada -->
            <div class="card" style="margin-top:14px;">
                <h3>Detalhes dos Treinos</h3>
                <div id="exerciseHistoryList" class="exercise-history-list"></div>
            </div>
        </div>

        <!-- PLANOS -->
        <div id="plansPage" class="page">
            <div style="display:flex; justify-content:end; margin-bottom: 10px;">
                <button class="btn primary" onclick="openPlanModal()"><i class="bi bi-plus-circle"></i> Adicionar Plano de Treino</button>
            </div>
            <div id="plansList" class="list"></div>
        </div>

        <!-- DETALHE DO PLANO -->
        <div id="planDetailPage" class="page">
            <div class="exercise-detail-header" style="margin-bottom:8px;">
                <button class="back-button" onclick="closePlanDetail()"><i class="bi bi-arrow-left"></i></button>
                <h1 class="exercise-detail-title" id="planDetailTitle">Plano</h1>
                <button class="edit-exercise-button" onclick="openEditPlanNameModal()"><i class="bi bi-pencil"></i></button>
            </div>

            <div class="card" style="margin-bottom:10px;">
                <div style="display:flex; gap:8px;">
                    <button class="btn accent" onclick="openAddDayModal()"><i class="bi bi-plus-circle"></i> Adicionar Dia</button>
                </div>
            </div>

            <div id="planDaysDetail" class="list"></div>
            <div class="plan-detail-footer">
                <button class="btn-remove-plan" onclick="removePlan()">Remover</button>
                <button class="btn-save-plan" onclick="savePlanChanges()">Guardar</button>
            </div>
        </div>

        <!-- NOVA PÁGINA: Gestão do Dia -->
        <div id="dayManagementPage" class="page">
            <div class="exercise-detail-header" style="margin-bottom:16px;">
                <button class="back-button" onclick="closeDayManagementPage()"><i class="bi bi-arrow-left"></i></button>
                <h1 class="exercise-detail-title" id="dayManagementPageTitle">Gestão do Dia</h1>
                <button class="edit-exercise-button" onclick="openEditDayNameModalFromPage()"><i class="bi bi-pencil"></i></button>
            </div>

            <div class="day-management-page-content">
                <button class="btn accent day-management-page-add-exercise" onclick="openAddExerciseToDayModal(currentDayManagementIndex)">
                    <i class="bi bi-plus-circle"></i> Adicionar Exercício
                </button>
                <div id="dayManagementPageExerciseList" class="day-management-page-exercise-list"></div>
            </div>
        </div>

        <!-- DETALHES DO DIA - REDESENHADO conforme a imagem -->
        <div id="dayDetailPage" class="page">
            <div class="exercise-detail-header" style="margin-bottom:16px;">
                <button class="back-button" onclick="closeDayDetail()"><i class="bi bi-arrow-left"></i></button>
                <h1 class="exercise-detail-title" id="dayDetailTitle">Dia do Treino</h1>
            </div>

            <div id="dayExercisesList"></div>

            <button class="start-workout-btn" onclick="startWorkout()">Iniciar Treino</button>
        </div>

        <!-- Weight Page -->
        <div id="weightPage" class="page">
            <div class="card" id="weightCard">
                <div>
                    <h3>Peso Atual:</h3>
                    <div class="big" id="currentWeightPageLabel">0 kg</div>
                </div>
                <button class="btn ghost" onclick="openWeightModal()"><i class="bi bi-plus-circle"></i> Adicionar Peso</button>
            </div>
            <div class="card">
                <canvas id="weightChart" height="200"></canvas>
            </div>
            <ul id="weightList" class="weight-list"></ul>
        </div>

        <!-- Página de Treinos (Histórico) - MODIFICADA com barra de pesquisa -->
        <div id="workoutsPage" class="page">
            <div class="workouts-search">
                <input id="workoutSearch" class="input" placeholder="Procurar treino..." oninput="renderWorkouts()" />
                <button class="btn ghost" onclick="openWorkoutFilterModal()"><i class="bi bi-funnel"></i></button>
            </div>

            <div id="workoutsCard" class="card">
                <h3>Histórico de Treinos</h3>
                <p>Aqui podes ver todos os teus treinos realizados.</p>
            </div>

            <div id="workoutsList" class="list"></div>
        </div>

        <!-- NOVAS PÁGINAS PARA O FLUXO DE TREINO -->
        <!-- Página de exercícios do treino -->
        <div id="workoutPage" class="page">
            <div class="exercise-detail-header" style="margin-bottom:16px;">
                <button class="back-button" onclick="closeWorkoutPage()"><i class="bi bi-arrow-left"></i></button>
                <h1 class="exercise-detail-title" id="workoutTitle">Treino</h1>
            </div>

            <div id="workoutExercisesList"></div>

            <button id="finishWorkoutBtn" class="finish-workout-btn" onclick="finishWorkout()">Terminar Treino</button>
        </div>

        <!-- Página de execução do exercício - MODIFICADA conforme solicitado -->
        <div id="exerciseWorkoutPage" class="page">
            <div class="exercise-execution-header">
                <button class="back-button" onclick="closeExerciseWorkout()"><i class="bi bi-arrow-left"></i></button>
                <h1 class="exercise-execution-title" id="exerciseWorkoutTitle">Exercício</h1>
                <div>
                    <button class="timer-btn-small" id="timerBtnSmall" onclick="startTimer()"><i class="bi bi-stopwatch"></i></button>
                    <button class="exercise-info-btn" onclick="showExerciseInfo()"><i class="bi bi-info-circle"></i></button>
                </div>
            </div>

            <div class="card">
                <h3 id="exerciseWorkoutTarget"></h3>
                
                <div class="warmup-checkbox">
                    <input type="checkbox" id="warmupCheckbox" onchange="toggleWarmupSet()">
                    <label for="warmupCheckbox">Adicionar série de aquecimento</label>
                </div>
                
                <div id="seriesGrid" class="series-grid"></div>
            </div>

            <button id="finishExerciseBtn" class="finish-exercise-btn" onclick="finishExercise()">Terminar Exercício</button>
        </div>

        <!-- Página de resumo do treino -->
        <div id="workoutSummaryPage" class="page">
            <div class="exercise-detail-header" style="margin-bottom:16px;">
                <button class="back-button" onclick="closeWorkoutSummary()"><i class="bi bi-arrow-left"></i></button>
                <h1 class="exercise-detail-title">Resumo do Treino</h1>
            </div>

            <div class="workout-summary-item">
                <div class="summary-header">
                    <h2 class="summary-title" id="summaryPlanName"></h2>
                    <div class="summary-duration" id="summaryDuration"></div>
                </div>
                <div id="summaryExercisesList"></div>
            </div>

            <button class="start-workout-btn" onclick="closeWorkoutSummary()">Voltar ao Início</button>
        </div>

        <!-- MODAL PESO -->
        <div id="weightModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Adicionar Peso</h2>
                <div class="form-group"><label class="form-label">Peso (kg)</label><input id="weightInput" type="number" step="0.1" class="form-input"></div>
                <div class="form-group"><label class="form-label">Data</label><input id="weightDate" type="date" class="form-input"></div>
                <div classmodal-buttons><button class="modal-btn btn-cancel" onclick="closeWeightModal()">Cancelar</button><button class="modal-btn btn-save" onclick="saveWeight()">Guardar</button></div>
            </div>
        </div>

        <!-- MODAL ADICIONAR EXERCICIO AO DIA -->
        <div id="addExerciseToDayModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Adicionar Exercício</h2>
                <div class="form-group">
                    <label class="form-label">Exercício</label>
                    <select id="exerciseSelect" class="modal-exercise-select">
                        <option value="">Selecione um exercício</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Séries</label>
                    <input type="number" id="exerciseSets" class="form-input" min="1" placeholder="Ex: 3">
                </div>
                <div class="form-group">
                    <label class="form-label">Repetições</label>
                    <input type="number" id="exerciseReps" class="form-input" min="1" placeholder="Ex: 10">
                </div>
                <div class="form-group">
                    <label class="form-label">Peso (kg)</label>
                    <input type="number" id="exerciseWeight" class="form-input" step="0.5" min="0" placeholder="Opcional">
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeAddExerciseToDayModal()">Cancelar</button>
                    <button class="modal-btn btn-save" onclick="saveExerciseToDay()">Salvar</button>
                </div>
            </div>
        </div>

        <!-- MODAL SELEÇÃO DE PLANO -->
        <div id="planSelectionModal" class="weight-modal">
            <div class="weight-modal-content" style="color: white; background: var(--card);">
                <h2 class="modal-title">Escolher Plano</h2>
                <div id="planSelectionList" class="list"></div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closePlanSelection()">Cancelar</button>
                </div>
            </div>
        </div>
        
        <!-- MODAL FILTRO DE EXERCÍCIOS -->
        <div id="exerciseFilterModal" class="weight-modal">
            <div class="filter-modal-content">
                <h2 class="modal-title">Filtrar e Ordenar Exercícios</h2>
                
                <div class="filter-options">
                    <div class="filter-option-group">
                        <label class="form-label" style="color: white;">Filtrar por Grupo Muscular</label>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterChest" value="Peito">
                            <label for="filterChest">Peito</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterBack" value="Costas">
                            <label for="filterBack">Costas</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterLegs" value="Pernas">
                            <label for="filterLegs">Pernas</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterShoulders" value="Ombros">
                            <label for="filterShoulders">Ombros</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterArms" value="Braços">
                            <label for="filterArms">Braços</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterOther" value="Outro">
                            <label for="filterOther">Outro</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" style="color: white;">Ordenar por</label>
                        <select class="form-select" id="exerciseSort">
                            <option value="name">Nome (A-Z)</option>
                            <option value="nameDesc">Nome (Z-A)</option>
                            <option value="mostPerformed">Mais Realizados</option>
                            <option value="leastPerformed">Menos Realizados</option>
                            <option value="recent">Mais Recentes</option>
                        </select>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeExerciseFilterModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="clearExerciseFilters()">Limpar</button>
                    <button class="modal-btn btn-save" onclick="applyExerciseFilters()">Aplicar</button>
                </div>
            </div>
        </div>

        <!-- MODAL FILTRO DE TREINOS -->
        <div id="workoutFilterModal" class="weight-modal">
            <div class="filter-modal-content">
                <h2 class="modal-title">Filtrar Treinos</h2>
                
                <div class="filter-options">
                    <div class="form-group">
                        <label class="form-label" style="color: white;"> Data Inicial</label>
                        <input type="date" id="workoutFilterDateStart" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" style="color: white;"> Data Final</label>
                        <input type="date" id="workoutFilterDateEnd" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" style="color: white;"> Plano de Treino</label>
                        <select class="form-select" id="workoutFilterPlan">
                            <option value="">Todos os planos</option>
                        </select>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeWorkoutFilterModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="clearWorkoutFilters()">Limpar</button>
                    <button class="modal-btn btn-save" onclick="applyWorkoutFilters()">Aplicar</button>
                </div>
            </div>
        </div>

        <!-- MODAL CRIAR PLANO -->
        <div id="planModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title" id="modalPlanTitle">Criar Plano de Treino</h2>
                <div class="form-group"><label class="form-label">Nome do Plano</label><input id="planNameInput" class="form-input" placeholder="Ex: Push/Pull/Legs"></div>
                <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closePlanModal()">Cancelar</button><button class="modal-btn btn-save" onclick="savePlan()">Salvar Plano</button></div>
            </div>
        </div>

        <!-- MODAL ADICIONAR DIA -->
        <div id="addDayModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Adicionar Dia</h2>
                <div class="form-group"><label class="form-label">Nome do Dia</label><input id="dayNameInput" class="form-input" placeholder="Ex: Segunda-feira - Peito"></div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeAddDayModal()">Cancelar</button>
                    <button class="modal-btn btn-save" onclick="saveDay()">Salvar</button></div>
            </div>
        </div>

        <!-- MODAL EDITAR NOME DO PLANO -->
        <div id="editPlanNameModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Editar Nome do Plano</h2>
                <div class="form-group"><label class="form-label">Nome do Plano</label><input type="text" class="form-input" id="editPlanNameInput" placeholder="Ex: Plano de Força"></div>
                <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closeEditPlanNameModal()">Cancelar</button><button class="modal-btn btn-save" onclick="savePlanName()">Salvar</button></div>
            </div>
        </div>

        <!-- MODAL: Opções do Dia (renomear/apagar) - MODIFICADA para ter apenas remoção -->
        <div id="dayOptionsModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Remover Dia</h2>
                <p>Tem a certeza que deseja remover o dia <span id="dayNameToDelete"></span>?</p>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeDayOptionsModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="removeDay()">Remover Dia</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Editar Exercício do Dia - MODIFICADO (removido campo de nome) -->
        <div id="editExerciseModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Editar Exercício</h2>
                <div class="form-group">
                    <label class="form-label">Exercício</label>
                    <div class="form-input" style="background: #f3f4f6; padding: 10px 12px; border-radius: 10px; border: 1px solid #e5e7eb;" id="editExerciseNameStatic">Nome do Exercício</div>
                </div>
                <div class="form-group"><label class="form-label">Séries</label><input type="number" class="form-input" id="editExerciseSets" min="1"></div>
                <div class="form-group"><label class="form-label">Repetições</label><input type="number" class="form-input" id="editExerciseReps" min="1"></div>
                <div class="form-group"><label class="form-label">Peso (kg)</label><input type="number" class="form-input" id="editExerciseWeight" step="0.5" min="0"></div>
                <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closeEditExerciseModal()">Cancelar</button><button class="modal-btn btn-danger" onclick="removeExerciseFromDay()">Remover Exercício</button><button class="modal-btn btn-save" onclick="saveEditedExercise()">Guardar</button></div>
            </div>
        </div>

        <!-- MODAL: Informações do Exercício -->
        <div id="exerciseInfoModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title" id="exerciseInfoTitle">Informações do Exercício</h2>
                <div id="exerciseInfoContent" style="max-height: 300px; overflow-y: auto;"></div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeExerciseInfo()">Fechar</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Detalhes do Treino - MODIFICADO conforme solicitado -->
        <div id="workoutDetailModal" class="workout-detail-modal">
            <div class="workout-detail-content">
                <div class="workout-detail-header">
                    <h2 class="workout-detail-title">Detalhes do Treino</h2>
                    <button class="workout-detail-close" onclick="closeWorkoutDetailModal()">&times;</button>
                </div>
                <div id="workoutDetailInfo" class="workout-detail-info"></div>
                <div id="workoutDetailExercises" class="workout-detail-exercises"></div>
                <!-- Botão para eliminar treino no modal -->
                <button class="delete-workout-btn" onclick="deleteWorkout()">Eliminar Treino</button>
            </div>
        </div>

        <!-- MODAL: Alterar Mídia -->
        <input type="file" id="mediaInput" accept="image/*" style="display: none;">

        <!-- NOVOS MODAIS ADICIONADOS PARA AS CORREÇÕES -->
        
        <!-- MODAL: Adicionar Exercício (substitui o prompt) -->
        <div id="addExerciseModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Adicionar Exercício</h2>
                <div class="form-group">
                    <label class="form-label">Nome do Exercício</label>
                    <input type="text" class="form-input" id="newExerciseName" placeholder="Ex: Supino Reto">
                </div>
                <div class="form-group">
                    <label class="form-label">Grupo Muscular</label>
                    <select class="form-select" id="newExerciseMuscle">
                        <option value="Peito">Peito</option>
                        <option value="Costas">Costas</option>
                        <option value="Pernas">Pernas</option>
                        <option value="Ombros">Ombros</option>
                        <option value="Bicep">Bicep</option>
                        <option value="Tricep">Tricep</option>
                        <option value="Antebraço">Antebraço</option>
                        <option value="Lombar">Lombar</option>
                        <option value="Trapézio">Trapézio</option>
                        <option value="Gémeos">Gémeos</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeAddExerciseModal()">Cancelar</button>
                    <button class="modal-btn btn-save" onclick="saveNewExercise()">Salvar</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Editar Nome do Exercício (substitui o prompt) -->
        <div id="editExerciseNameModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Editar Nome do Exercício</h2>
                <div class="form-group">
                    <label class="form-label">Nome do Exercício</label>
                    <input type="text" class="form-input" id="editExerciseName" placeholder="Ex: Supino Reto">
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeEditExerciseNameModal()">Cancelar</button>
                    <button class="modal-btn btn-save" onclick="saveExerciseName()">Salvar</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Confirmar Remoção de Exercício -->
        <div id="deleteExerciseModal" class="weight-modal">
            <div class="confirm-delete-modal-content">
                <h2 class="modal-title">Remover Exercício</h2>
                <p>Tem a certeza que deseja remover o exercício <span id="exerciseNameToDelete"></span>?</p>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeDeleteExerciseModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="deleteExercise()">Remover</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Confirmar Remoção de Plano -->
        <div id="deletePlanConfirmModal" class="weight-modal">
            <div class="weight-modal-content" style="background: var(--card); color: var(--text);">
                <h2 class="modal-title">Remover Plano</h2>
                <p style="margin: 15px 0; text-align: center;">Tem a certeza que deseja remover permanentemente este plano de treino?</p>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeDeletePlanConfirmModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="confirmRemovePlan()">Remover</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Confirmar Remoção de Exercicio do Plano -->
        <div id="deleteExerciseConfirmModal" class="weight-modal">
            <div class="weight-modal-content" style="background: var(--card); color: var(--text);">
                <h2 class="modal-title">Remover Exercício</h2>
                <p style="margin: 15px 0; text-align: center;">Tem a certeza que deseja remover este exercício do dia?</p>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeDeleteExerciseConfirmModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="confirmRemoveExerciseFromDay()">Remover</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Confirmarçao de eliminaçao do treino -->
        <div id="deleteWorkoutConfirmModal" class="weight-modal">
            <div class="weight-modal-content" style="background: var(--card); color: var(--text);">
                <h2 class="modal-title">Eliminar Treino</h2>
                <p style="margin: 15px 0; text-align: center;">Tem a certeza que deseja eliminar permanentemente este treino?</p>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeDeleteWorkoutConfirmModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="confirmDeleteWorkout()">Eliminar</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Gestão do Dia (NOVA) -->
        <div id="dayManagementModal" class="weight-modal">
            <div class="day-management-modal-content">
                <div class="day-management-header">
                    <h2 class="day-management-title" id="dayManagementTitle">Gestão do Dia</h2>
                    <button class="edit-exercise-button" onclick="openEditDayNameModal()"><i class="bi bi-pencil"></i></button>
                </div>
                
                <div id="dayManagementExerciseList" class="day-management-exercise-list"></div>
                
                <button class="btn accent" style="width:100%; margin-bottom:16px;" onclick="openAddExerciseToDayModalFromManagement()">Adicionar Exercício</button>
                
                <div class="day-management-footer">
                    <button class="modal-btn btn-danger" onclick="openDayOptionsModal()">Remover Dia</button>
                    <button class="modal-btn btn-save" onclick="saveDayManagement()">Guardar</button>
                </div>
            </div>
        </div>

        <!-- NOVA MODAL: Editar Nome do Dia (semelhante à de editar nome do plano) - MOVIDA PARA DEPOIS DA MODAL DE GESTÃO DO DIA -->
        <div id="editDayNameModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Editar Nome do Dia</h2>
                <div class="form-group"><label class="form-label">Nome do Dia</label><input type="text" class="form-input" id="editDayNameInput" placeholder="Ex: Segunda - Peito"></div>
                <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closeEditDayNameModal()">Cancelar</button><button class="modal-btn btn-save" onclick="saveDayName()">Salvar</button></div>
            </div>
        </div>

        <!-- MODAL DE CONFIRMAÇÃO PERSONALIZADO -->
        <div id="confirmExitModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Sair do Treino</h2>
                <p>Tem a certeza que deseja sair do treino? Todo o progresso não guardado será perdido.</p>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeConfirmExitModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="confirmExitWorkout()">Sair do Treino</button>
                </div>
            </div>
        </div>

        <!-- NOVOS MODAIS PARA AS MODIFICAÇÕES SOLICITADAS -->
        
        <!-- MODAL: Detalhes do Exercício Concluído -->
        <div id="exerciseCompletedModal" class="weight-modal">
            <div class="exercise-completed-modal-content">
                <h2 class="modal-title" id="completedExerciseTitle">Exercício Concluído</h2>
                <div id="completedExerciseContent">
                    <!-- Conteúdo será preenchido via JavaScript -->
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-save" onclick="closeExerciseCompletedModal()">Fechar</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Confirmar Terminar Exercício com Séries em Falta -->
        <div id="confirmFinishExerciseModal" class="weight-modal">
            <div class="weight-modal-content" style="background: var(--card); color: var(--text);">
                <h2 class="modal-title">Terminar Exercício</h2>
                <p>Existem séries não preenchidas. Deseja terminar mesmo assim?</p>
                <p style="font-size: 0.9rem; opacity: 0.8;">As séries em falta serão preenchidas com "0".</p>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeConfirmFinishExerciseModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="confirmFinishExercise()">Terminar Exercício</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Confirmar Terminar Treino com Exercícios em Falta -->
        <div id="confirmFinishWorkoutModal" class="weight-modal">
            <div class="weight-modal-content" style="background: var(--card); color: var(--text);">
                <h2 class="modal-title">Terminar Treino</h2>
                <p>Existem exercícios não terminados. Deseja terminar mesmo assim?</p>
                <p style="font-size: 0.9rem; opacity: 0.8;">Os exercícios em falta serão preenchidos com "0".</p>
                <div id="missingExercisesList" class="missing-exercises-list">
                    <!-- Lista de exercícios em falta será preenchida via JavaScript -->
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeConfirmFinishWorkoutModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="confirmFinishWorkout()">Terminar Treino</button>
                </div>
            </div>
        </div>

        <div id="toast" class="toast">Guardado!</div>
    </div>

    <!-- Navbar Fixa -->
    <div class="navbar">
        <div class="nav-item active" onclick="showPage('mainPage')"><i class="bi bi-house-fill nav-icon"></i><div>HOME</div></div>
        <div class="nav-item" onclick="showPage('exercisesPage')"><i class="bi bi-activity nav-icon"></i><div>EXERCICIOS</div></div>
        <div class="nav-item" onclick="showPage('plansPage')"><i class="bi bi-calendar-week nav-icon"></i><div>PLANOS</div></div>
        <div class="nav-item" onclick="showPage('workoutsPage')"><i class="bi bi-clock-history nav-icon"></i><div>TREINOS</div></div>
        <div class="nav-item" onclick="showPage('weightPage')"><i class="bi bi-speedometer2 nav-icon"></i><div>PESO</div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script>
        // ===== Variáveis globais =====
        let currentWeight = 80;
        let selectedPlanId = null;
        let currentPage = 'mainPage';
        let weights = JSON.parse(localStorage.getItem("weights")) || [];
        let weightChart;
        let exerciseChart = null;
        let currentExercise = null;
        let currentPlanDetail = null;
        let currentDayForExercise = null;
        let currentDayDetail = null;
        let mediaTypeToChange = null;
        let exerciseToRemoveIndex = null;

        // Variáveis para controlar o treino atual
        let currentWorkout = null;
        let currentExerciseIndex = 0;
        let timerInterval = null;
        let timerSeconds = 120; // 2 minutos
        let workoutStartTime = null;

        // Variável para guardar o treino atualmente selecionado para detalhes
        let currentWorkoutDetail = null;

        // Variável para controlar o dia sendo gerenciado
        let currentDayManagementIndex = null;

        // Variáveis para filtros
        let exerciseFilters = {
            muscleGroups: [],
            sortBy: 'name'
        };
        
        let workoutFilters = {
            dateStart: null,
            dateEnd: null,
            plan: null
        };

        // Variável para controlar o treino em progresso
        let ongoingWorkout = JSON.parse(localStorage.getItem('fitnessOngoingWorkout')) || null;

        // Variável para controlar se o treino já foi guardado
        let isWorkoutSaved = false;

        // Variável para controlar se há exercício em progresso
        let exerciseInProgress = false;

        const storageKeys = { 
            WEIGHT: 'fitnessWeight', 
            SELECTED_PLAN: 'fitnessSelectedPlan', 
            WEIGHT_HISTORY: 'fitnessWeightHistory', 
            EXERCISES: 'fitnessExercises', 
            PLANS: 'fitnessPlans',
            WORKOUTS: 'fitnessWorkouts',
            EXERCISE_MEDIA: 'fitnessExerciseMedia',
            AVAILABLE_EXERCISES: 'fitnessAvailableExercises',
            ONGOING_WORKOUT: 'fitnessOngoingWorkout'
        };

        // Exercícios disponíveis (agora carregados do localStorage)
        let availableExercises = loadAvailableExercises();

        // ===== Novas funções para gerir exercícios disponíveis =====
        function loadAvailableExercises() {
            try {
                return JSON.parse(localStorage.getItem(storageKeys.AVAILABLE_EXERCISES)) || [];
            } catch (e) {
                console.error("Erro ao carregar exercícios disponíveis:", e);
                return [];
            }
        }

        function saveAvailableExercises(exercises) {
            localStorage.setItem(storageKeys.AVAILABLE_EXERCISES, JSON.stringify(exercises));
        }

        // ===== Funções para a Página de Peso =====
        function renderWeightList() {
            const list = document.getElementById('weightList');
            const hist = loadWeightHistory();
            
            list.innerHTML = '';
            
            if (hist.length === 0) {
                list.innerHTML = '<li>Nenhum registro de peso ainda</li>';
                return;
            }
            
            hist.slice().reverse().forEach((entry, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${entry.date}</span>
                    <span>${entry.weight} kg</span>
                    <button class="delete-weight-btn" onclick="removeWeight(${hist.length - 1 - index})"><i class="bi bi-x"></i></button>
                `;
                list.appendChild(li);
            });
        }

        function removeWeight(index) {
            const hist = loadWeightHistory();
            if (index >= 0 && index < hist.length) {
                hist.splice(index, 1);
                saveWeightHistory(hist);
                initWeight();
                showToast('Peso removido!');
            }
        }

        function initWeight() {
            const hist = loadWeightHistory();
            if (hist.length > 0) {
                currentWeight = hist[hist.length - 1].weight;
                document.getElementById('currentWeightLabel').textContent = currentWeight + ' kg';
                document.getElementById('currentWeightPageLabel').textContent = currentWeight + ' kg';
            } else {
                currentWeight = 80;
                document.getElementById('currentWeightLabel').textContent = '0 kg';
                document.getElementById('currentWeightPageLabel').textContent = '0 kg';
            }
            
            const ctx = document.getElementById('weightChart');
            if (weightChart) weightChart.destroy();
            
            if (hist.length > 0) {
                weightChart = new Chart(ctx, {
                    type: 'line', 
                    data: { 
                        labels: hist.map(h => h.date), 
                        datasets: [{ 
                            label: 'Peso (kg)', 
                            data: hist.map(h => h.weight),
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            } else {
                // Gráfico vazio
                weightChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Peso (kg)',
                            data: [],
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            }
            
            renderWeightList();
        }
        
        function openWeightModal(){ 
            document.getElementById('weightModal').style.display='block'; 
            document.getElementById('weightDate').value = new Date().toISOString().slice(0,10);
        }
        
        function closeWeightModal(){ document.getElementById('weightModal').style.display='none'; }
        
        function saveWeight(){ 
            const v = parseFloat(document.getElementById('weightInput').value); 
            const d = document.getElementById('weightDate').value || new Date().toISOString().slice(0,10);
            
            if (!v) {
                alert('Insira um peso.');
                return;
            } 
            
            currentWeight = v;
            document.getElementById('currentWeightLabel').textContent = v + ' kg';
            document.getElementById('currentWeightPageLabel').textContent = v + ' kg';
            
            const hist = loadWeightHistory();
            hist.push({ date: d, weight: v });
            saveWeightHistory(hist);
            
            initWeight();
            closeWeightModal();
            showToast('Peso guardado!');
        }

        // ===== Funções para a Página de Exercícios =====
        function getExercisesData(){ return loadExercisesData(); }
        
        function renderExercises(){
            const q = (document.getElementById('exerciseSearch').value || '').toLowerCase();
            const list = document.getElementById('exercisesList');
            let items = availableExercises.filter(e => e.name.toLowerCase().includes(q));
            
            // Aplicar filtros de grupo muscular
            if (exerciseFilters.muscleGroups.length > 0) {
                items = items.filter(e => exerciseFilters.muscleGroups.includes(e.muscle));
            }
            
            // Aplicar ordenação
            switch(exerciseFilters.sortBy) {
                case 'name':
                    items.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'nameDesc':
                    items.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'mostPerformed':
                    items.sort((a, b) => getExercisePerformanceCount(b.name) - getExercisePerformanceCount(a.name));
                    break;
                case 'leastPerformed':
                    items.sort((a, b) => getExercisePerformanceCount(a.name) - getExercisePerformanceCount(b.name));
                    break;
                case 'recent':
                    items.sort((a, b) => new Date(getExerciseLastPerformedDate(b.name)) - new Date(getExerciseLastPerformedDate(a.name)));
                    break;
            }
            
            // Verificar se não há exercícios
            if (availableExercises.length === 0) {
                list.innerHTML = '<div class="card">Sem exercícios ainda.</div>';
                return;
            }
            
            // Verificar se a pesquisa não encontrou resultados
            if (items.length === 0) {
                list.innerHTML = '<div class="card">Nenhum exercício encontrado.</div>';
                return;
            }
            
            list.innerHTML = items.map(e => {
                // Carregar mídia para obter a miniatura
                const mediaData = loadExerciseMediaData();
                const exerciseMedia = mediaData[e.name] || {};
                const hasImage = exerciseMedia && exerciseMedia.image;
                
                return `
                    <div class="exercise-list-item">
                        ${hasImage ? 
                            `<img src="${exerciseMedia.image}" class="exercise-thumbnail" alt="${e.name}">` : 
                            `<div class="exercise-thumbnail"><i class="bi bi-activity"></i></div>`
                        }
                        <div>
                            <div class="title">${e.name}</div>
                            <div class="subtitle">${e.muscle}</div>
                        </div>
                        <button class="kebab" onclick="openExerciseDetail('${e.name.replace(/'/g,"&#39;")}')">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        // Funções auxiliares para ordenação de exercícios
        function getExercisePerformanceCount(exerciseName) {
            const exercisesData = getExercisesData();
            if (exercisesData[exerciseName] && exercisesData[exerciseName].history) {
                return exercisesData[exerciseName].history.length;
            }
            return 0;
        }
        
        function getExerciseLastPerformedDate(exerciseName) {
            const exercisesData = getExercisesData();
            if (exercisesData[exerciseName] && exercisesData[exerciseName].history && exercisesData[exerciseName].history.length > 0) {
                const sortedHistory = exercisesData[exerciseName].history.sort((a, b) => new Date(b.date) - new Date(a.date));
                return sortedHistory[0].date;
            }
            return '1970-01-01'; // Data muito antiga para exercícios nunca realizados
        }
        
        // MODAL: Adicionar exercício (substitui o prompt)
        function openAddExerciseModal(dayIndex){
            currentDayForExercise = dayIndex;
            document.getElementById('newExerciseName').value = '';
            document.getElementById('newExerciseMuscle').value = 'Peito';
            document.getElementById('addExerciseModal').style.display='block';
        }
        
        function closeAddExerciseModal(){
            document.getElementById('addExerciseModal').style.display='none';
        }
        
        function saveNewExercise() {
            const name = document.getElementById('newExerciseName').value.trim();
            const muscle = document.getElementById('newExerciseMuscle').value;
            
            if (!name) {
                alert('Por favor, insira um nome para o exercício.');
                return;
            }
            
            // Verificar se já existe
            if (availableExercises.some(e => e.name.toLowerCase() === name.toLowerCase())) {
                alert('Já existe a exercício com esse nome.');
                return;
            }
            
            availableExercises.push({ name, muscle, type: muscle.toLowerCase() });
            saveAvailableExercises(availableExercises); // Salvar no localStorage
            
            const data = loadExercisesData();
            if (!data[name]) {
                data[name] = { notes: '', sets: [], history: [] };
            }
            saveExercisesData(data);
            
            renderExercises();
            closeAddExerciseModal();
            showToast('Exercício adicionado.');
        }

        // Detalhe exercício
        function openExerciseDetail(name){ 
            currentExercise=name; 
            showPage('exerciseDetailPage'); 
            document.getElementById('exerciseDetailTitle').textContent=name; 
            loadExerciseDetail(name);
            loadExerciseMedia(name);
        }
        
        function closeExerciseDetail(){ showPage('exercisesPage'); }
        
        function loadExerciseDetail(name){
            const data = getExercisesData()[name] || { notes: '', history: [] };
            document.getElementById('exerciseNotes').value = data.notes || '';
            
            updateExerciseStats(data.history || []);

            // Atualizar o gráfico para mostrar a média de peso por repetição
            const ctx = document.getElementById('exerciseChart');
            if (exerciseChart) exerciseChart.destroy();
            
            if (data.history && data.history.length > 0) {
                // Preparar dados para o gráfico
                const labels = data.history.map(h => new Date(h.startTime).toLocaleDateString('pt-PT'));
                const avgData = data.history.map(h => h.averageWeightPerRep || 0);
                const maxData = data.history.map(h => h.maxWeight || 0);
                
                exerciseChart = new Chart(ctx, { 
                    type: 'line', 
                    data: { 
                        labels: labels,
                        datasets: [
                            { 
                                label: 'Média de Peso por Repetição (kg)', 
                                data: avgData,
                                borderColor: '#4f46e5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Peso Máximo (kg)',
                                data: maxData,
                                borderColor: '#2e7d32',
                                backgroundColor: 'rgba(46, 125, 50, 0.1)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    }, 
                    options: { 
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Kg'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Data'
                                }
                            }
                        }
                    } 
                });
            } else {
                // Gráfico vazio
                exerciseChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Média de Peso por Repetição (kg)',
                                data: [],
                                borderColor: '#4f46e5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Peso Máximo (kg)',
                                data: [],
                                borderColor: '#2e7d32',
                                backgroundColor: 'rgba(46, 125, 50, 0.1)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: { 
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Kg'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Data'
                                }
                            }
                        }
                    }
                });
            }
            
            // Carregar o histórico de exercícios
            loadExerciseHistoryList(data.history || []);
        }

        function updateExerciseStats(history) {
            if (!history || history.length === 0) {
                // Se não há histórico, definir valores padrão
                document.getElementById('statMaxWeight').textContent = '0 kg';
                document.getElementById('statMaxWeightDate').textContent = '—';
                document.getElementById('statTotalSessions').textContent = '0';
                document.getElementById('statAvgWeight').textContent = '0 kg';
                document.getElementById('statTotalVolume').textContent = '0 kg';
                return;
            }
            
            // Calcular estatísticas
            let maxWeight = 0;
            let maxWeightDate = '';
            let totalSessions = history.length;
            let totalReps = 0;
            let totalVolume = 0;
            let totalWeight = 0;
            let weightCount = 0;
            
            history.forEach(workout => {
                // Encontrar o peso máximo neste treino
                let workoutMaxWeight = 0;
                
                if (workout.sets) {
                    workout.sets.forEach(set => {
                        const weight = parseFloat(set.weight) || 0;
                        const reps = parseInt(set.repetitions) || 0;
                        
                        // Verificar peso máximo
                        if (weight > maxWeight) {
                            maxWeight = weight;
                            maxWeightDate = new Date(workout.startTime).toLocaleDateString('pt-PT');
                        }
                        
                        // Calcular totais
                        if (weight > 0) {
                            totalReps += reps;
                            totalVolume += weight * reps;
                            totalWeight += weight;
                            weightCount++;
                            
                            // Também verificar o máximo neste treino
                            if (weight > workoutMaxWeight) {
                                workoutMaxWeight = weight;
                            }
                        }
                    });
                }
                
                // Se não encontramos peso nos sets, verificar nas propriedades do workout
                if (workoutMaxWeight === 0 && workout.maxWeight) {
                    const weight = parseFloat(workout.maxWeight) || 0;
                    if (weight > maxWeight) {
                        maxWeight = weight;
                        maxWeightDate = new Date(workout.startTime).toLocaleDateString('pt-PT');
                    }
                }
            });
            
            // Calcular média de peso
            const avgWeight = weightCount > 0 ? totalWeight / weightCount : 0;
            
            // Atualizar a interface
            document.getElementById('statMaxWeight').textContent = `${maxWeight} kg`;
            document.getElementById('statMaxWeightDate').textContent = maxWeightDate || '—';
            document.getElementById('statTotalSessions').textContent = totalSessions;
            document.getElementById('statAvgWeight').textContent = `${avgWeight.toFixed(1)} kg`;
            document.getElementById('statTotalVolume').textContent = `${totalVolume.toFixed(0)} kg`;
        }
        
        // Função para carregar o histórico de exercícios na página de detalhes
        function loadExerciseHistoryList(history) {
            const container = document.getElementById('exerciseHistoryList');
            container.innerHTML = '';
            
            if (!history || history.length === 0) {
                container.innerHTML = '<div class="exercise-history-item">Nenhum treino registado ainda</div>';
                return;
            }
            
            history.sort((a, b) => new Date(b.startTime || b.date) - new Date(a.startTime || a.date));
            
            history.forEach((workout, index) => {
                const item = document.createElement('div');
                item.className = 'exercise-history-item';
                item.id = `exercise-history-${index}`;
                
                let setsHTML = '';
                if (workout.sets && workout.sets.length) {
                    setsHTML = workout.sets.map((set, i) => `
                        <div class="exercise-history-set">
                            <span>Série ${i + 1}:</span>
                            <span>${set.repetitions || 0} reps × ${set.weight || 0} kg</span>
                        </div>
                    `).join('');
                }
                
                // Verificar se houve atualização de objetivo
                let targetHTML = '';
                if (workout.targetUpdate && workout.targetUpdate.updated) {
                    targetHTML = `
                        <div class="exercise-completed-target target-updated">
                            <strong>🎉 Objetivo atualizado!</strong><br>
                            <span class="target-old">${workout.targetUpdate.oldTarget.reps} reps × ${workout.targetUpdate.oldTarget.weight} kg</span>
                            <span class="target-new">${workout.targetUpdate.newTarget.reps} reps × ${workout.targetUpdate.newTarget.weight} kg</span>
                        </div>
                    `;
                }
                
                item.innerHTML = `
                    <div class="exercise-history-header" onclick="toggleExerciseHistoryDetails(${index})">
                        <div class="exercise-history-date">${new Date(workout.startTime).toLocaleDateString('pt-PT')}</div>
                        <div class="exercise-history-avg">${workout.averageWeightPerRep ? workout.averageWeightPerRep.toFixed(2) + ' kg/rep' : 'N/A'}</div>
                    </div>
                    <div class="exercise-history-details">
                        <div class="exercise-history-detail-item">
                            <span class="exercise-history-detail-label">Séries</span>
                            <span class="exercise-history-detail-value">${workout.sets ? workout.sets.length : 0}</span>
                        </div>
                        <div class="exercise-history-detail-item">
                            <span class="exercise-history-detail-label">Reps Totais</span>
                            <span class="exercise-history-detail-value">${workout.totalReps || 0}</span>
                        </div>
                        <div class="exercise-history-detail-item">
                            <span class="exercise-history-detail-label">Volume Total</span>
                            <span class="exercise-history-detail-value">${workout.totalVolume ? workout.totalVolume.toFixed(2) + ' kg' : 'N/A'}</span>
                        </div>
                    </div>
                    ${targetHTML}
                    <div class="exercise-history-sets" id="history-sets-${index}">
                        ${setsHTML}
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        function toggleExerciseHistoryDetails(index) {
            const setsElement = document.getElementById(`history-sets-${index}`);
            if (setsElement) {
                setsElement.classList.toggle('expanded');
            }
        }
        
        function saveExerciseNotes(){ 
            const data=loadExercisesData(); 
            if(!data[currentExercise]) data[currentExercise]={notes:'',history:[]}; 
            data[currentExercise].notes=document.getElementById('exerciseNotes').value; 
            saveExercisesData(data); 
            showToast('Notas guardadas.'); 
        }
        
        // MODAL: Editar nome do exercício (substitui o prompt)
        function openEditExerciseNameModal(){
            document.getElementById('editExerciseName').value = currentExercise;
            document.getElementById('editExerciseNameModal').style.display='block';
        }
        
        function closeEditExerciseNameModal(){
            document.getElementById('editExerciseNameModal').style.display='none';
        }
        
        function saveExerciseName(){
            const newName = document.getElementById('editExerciseName').value.trim();
            
            if (!newName) {
                alert('Por favor, insira um nome para o exercício.');
                return;
            }
            
            if (newName === currentExercise) {
                closeEditExerciseNameModal();
                return;
            }
            
            // Verificar se já existe
            if (availableExercises.some(e => e.name.toLowerCase() === newName.toLowerCase())) {
                alert('Já existe um exercício com esse nome.');
                return;
            }
            
            // Atualizar nos exercícios disponíveis
            const index = availableExercises.findIndex(e => e.name === currentExercise);
            if (index !== -1) {
                availableExercises[index].name = newName;
                saveAvailableExercises(availableExercises);
            }
            
            // Atualizar nos dados dos exercícios
            const data = loadExercisesData();
            if (data[currentExercise]) {
                data[newName] = data[currentExercise];
                delete data[currentExercise];
                saveExercisesData(data);
            }
            
            // Atualizar nos planos
            const plans = loadPlansData();
            let updatedPlans = false;
            plans.forEach(plan => {
                plan.days.forEach(day => {
                    day.exercises.forEach(exercise => {
                        if (exercise.name === currentExercise) {
                            exercise.name = newName;
                            updatedPlans = true;
                        }
                    });
                });
            });
            if (updatedPlans) {
                savePlansData(plans);
            }
            
            // Atualizar nos treinos
            const workouts = loadWorkoutsData();
            let updatedWorkouts = false;
            workouts.forEach(workout => {
                workout.exercises.forEach(exercise => {
                    if (exercise.name === currentExercise) {
                        exercise.name = newName;
                        updatedWorkouts = true;
                    }
                });
            });
            if (updatedWorkouts) {
                saveWorkoutsData(workouts);
            }
            
            // Atualizar mídia
            const mediaData = loadExerciseMediaData();
            if (mediaData[currentExercise]) {
                mediaData[newName] = mediaData[currentExercise];
                delete mediaData[currentExercise];
                saveExerciseMediaData(mediaData);
            }
            
            currentExercise = newName;
            document.getElementById('exerciseDetailTitle').textContent = newName;
            
            renderExercises();
            closeEditExerciseNameModal();
            showToast('Nome do exercício alterado.');
        }
        
        // MODAL: Confirmar remoção do exercício
        function openDeleteExerciseModal(){
            document.getElementById('exerciseNameToDelete').textContent = currentExercise;
            document.getElementById('deleteExerciseModal').style.display='block';
        }
        
        function closeDeleteExerciseModal(){
            document.getElementById('deleteExerciseModal').style.display='none';
        }
        
        function deleteExercise(){
            // Remover dos exercícios disponíveis
            const index = availableExercises.findIndex(e => e.name === currentExercise);
            if (index !== -1) {
                availableExercises.splice(index, 1);
                saveAvailableExercises(availableExercises);
            }
            
            // Remover dos dados dos exercícios
            const data = loadExercisesData();
            if (data[currentExercise]) {
                delete data[currentExercise];
                saveExercisesData(data);
            }
            
            // Remover dos planos
            const plans = loadPlansData();
            let updatedPlans = false;
            plans.forEach(plan => {
                plan.days.forEach(day => {
                    const originalLength = day.exercises.length;
                    day.exercises = day.exercises.filter(exercise => exercise.name !== currentExercise);
                    if (day.exercises.length !== originalLength) {
                        updatedPlans = true;
                    }
                });
            });
            if (updatedPlans) {
                savePlansData(plans);
            }
            
            // Remover dos treinos
            const workouts = loadWorkoutsData();
            let updatedWorkouts = false;
            workouts.forEach(workout => {
                const originalLength = workout.exercises.length;
                workout.exercises = workout.exercises.filter(exercise => exercise.name !== currentExercise);
                if (workout.exercises.length !== originalLength) {
                    updatedWorkouts = true;
                }
            });
            if (updatedWorkouts) {
                saveWorkoutsData(workouts);
            }
            
            // Remover mídia
            const mediaData = loadExerciseMediaData();
            if (mediaData[currentExercise]) {
                delete mediaData[currentExercise];
                saveExerciseMediaData(mediaData);
            }
            
            closeDeleteExerciseModal();
            showToast('Exercício removido.');
            closeExerciseDetail();
        }

        // ===== Funções para a Página de Planos =====
        function renderPlans(){ 
            const list=document.getElementById('plansList'); 
            const plans=loadPlansData(); 
            if(plans.length===0){ list.innerHTML='<div class="card">Sem planos ainda.</div>'; return; } 
            
            list.innerHTML=plans.map(p=>`
                <div class="list-item" data-plan-id="${p.id}">
                    <div><i class="bi bi-calendar-week"></i></div>
                    <div>
                        <div class="title">${p.name}</div>
                        <div class="subtitle">${p.days.length} dias</div>
                    </div>
                    <button class="kebab" data-plan-id="${p.id}"><i class="bi bi-three-dots-vertical"></i></button>
                </div>
            `).join(''); 
            
            // Adicionar event listeners após renderizar
            setTimeout(() => {
                // Clique no item do plano
                document.querySelectorAll('.list-item[data-plan-id]').forEach(item => {
                    item.addEventListener('click', function(e) {
                        // Não abrir se o clique foi no botão de opções
                        if (!e.target.closest('.kebab')) {
                            const planId = this.getAttribute('data-plan-id');
                            openPlanDetail(planId);
                        }
                    });
                });
                
                // Clique no botão de opções
                document.querySelectorAll('.kebab[data-plan-id]').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const planId = this.getAttribute('data-plan-id');
                        openPlanDetail(planId);
                    });
                });
            }, 0);
        }
        
        function openPlanOptions(planId, event) {
            event.stopPropagation();
            
            // Fechar menus abertos anteriormente
            closeAllPlanOptionsMenus();
            
            const button = event.target;
            const menu = document.createElement('div');
            menu.className = 'plan-options-menu';
            menu.style.cssText = `
                position: absolute;
                background: var(--card);
                border: 1px solid rgba(255,255,255,0.2);
                border-radius: 8px;
                padding: 8px 0;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                min-width: 120px;
            `;
            
            menu.innerHTML = `
                <div class="plan-option" onclick="editPlan('${planId}')" style="padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="bi bi-pencil"></i> Editar
                </div>
                <div class="plan-option" onclick="deletePlan('${planId}')" style="padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--danger);">
                    <i class="bi bi-trash"></i> Eliminar
                </div>
            `;
            
            // Posicionar o menu perto do botão
            const rect = button.getBoundingClientRect();
            menu.style.top = `${rect.bottom + window.scrollY}px`;
            menu.style.left = `${rect.left + window.scrollX - 100}px`;
            
            menu.id = `plan-menu-${planId}`;
            document.body.appendChild(menu);
            
            // Fechar menu ao clicar fora
            setTimeout(() => {
                document.addEventListener('click', closeAllPlanOptionsMenus, { once: true });
            }, 100);
        }

        function closeAllPlanOptionsMenus() {
            const menus = document.querySelectorAll('.plan-options-menu');
            menus.forEach(menu => menu.remove());
        }

        function editPlan(planId) {
            closeAllPlanOptionsMenus();
            openPlanDetail(planId);
            // Aqui você pode adicionar lógica para edição rápida do nome, etc.
        }

        function deletePlan(planId) {
            closeAllPlanOptionsMenus();
            
            // Usar a lógica existente de eliminação de plano
            const plans = loadPlansData();
            const planIndex = plans.findIndex(p => p.id === planId);
            
            if (planIndex !== -1) {
                const planName = plans[planIndex].name;
                if (confirm(`Tem a certeza que deseja eliminar o plano "${planName}"?`)) {
                    plans.splice(planIndex, 1);
                    savePlansData(plans);
                    
                    // Se era o plano selecionado, limpar seleção
                    if (selectedPlanId === planId) {
                        selectedPlanId = null;
                        localStorage.removeItem(storageKeys.SELECTED_PLAN);
                        document.getElementById('selectedPlanLabel').textContent = '—';
                        document.getElementById('selectedPlanDays').innerHTML = '';
                    }
                    
                    renderPlans();
                    showToast('Plano eliminado.');
                }
            }
        }

        function openPlanDetail(id){ 
            const plans=loadPlansData(); 
            const plan=plans.find(p=>p.id===id); 
            if(!plan) {
                showToast('Plano não encontrado');
                return;
            } 
            
            // Garantir que o plano tem a estrutura correta
            if (!plan.days) {
                plan.days = [];
            }
            
            currentPlanDetail=plan; 
            document.getElementById('planDetailTitle').textContent=plan.name; 
            renderPlanDaysDetail(plan.days); 
            showPage('planDetailPage'); 
        }
        
        function closePlanDetail(){ showPage('plansPage'); }
        
        function renderPlanDaysDetail(days){ 
            const list=document.getElementById('planDaysDetail'); 
            if(days.length===0){ list.innerHTML='<div class="card">Sem dias ainda.</div>'; return; } 
            list.innerHTML=days.map((day, index)=>`
                <div class="plan-day-item">
                    <div class="plan-day-info">
                        <div class="plan-day-name">${day.name}</div>
                        <div class="plan-day-exercises-count">${day.exercises ? day.exercises.length : 0} exercícios</div>
                    </div>
                    <div>
                        <button class="plan-day-options" onclick="openDayManagementPage(${index})"><i class="bi bi-three-dots-vertical"></i></button>
                    </div>
                </div>
            `).join(''); 
        }
        
        // MODAL: Gestão do Dia (NOVA)
        function openDayManagementPage(dayIndex) {
            // Verificar se currentPlanDetail e days existem
            if (!currentPlanDetail || !currentPlanDetail.days || !currentPlanDetail.days[dayIndex]) {
                console.error('Erro: Plano ou dia não encontrado');
                showToast('Erro ao abrir gestão do dia');
                return;
            }
            
            // Recarregar o plano atual para garantir que temos os dados mais recentes
            const plans = loadPlansData();
            const updatedPlan = plans.find(p => p.id === currentPlanDetail.id);
            if (updatedPlan) {
                currentPlanDetail = updatedPlan;
            }
            
            currentDayManagementIndex = dayIndex;
            const day = currentPlanDetail.days[dayIndex];
            document.getElementById('dayManagementPageTitle').textContent = day.name;
            renderDayManagementPageExerciseList(day.exercises || []);
            showPage('dayManagementPage');
        }
        
        function closeDayManagementPage() {
            // Recarregar os dados do plano antes de voltar
            const plans = loadPlansData();
            const updatedPlan = plans.find(p => p.id === currentPlanDetail.id);
            if (updatedPlan) {
                currentPlanDetail = updatedPlan;
                renderPlanDaysDetail(currentPlanDetail.days);
            }
            showPage('planDetailPage');
        }
        
        function renderDayManagementPageExerciseList(exercises) {
            const list = document.getElementById('dayManagementPageExerciseList');
            if (!exercises || exercises.length === 0) {
                list.innerHTML = '<div class="card">Sem exercícios ainda.</div>';
                return;
            }
            
            list.innerHTML = exercises.map((exercise, index) => `
                <div class="day-management-page-exercise-item" draggable="true" ondragstart="dragExerciseStart(event, ${index})" ondragover="dragExerciseOver(event)" ondrop="dragExerciseDrop(event, ${index})">
                    <div class="day-management-page-exercise-info">
                        <div class="day-management-page-exercise-name">${exercise.name}</div>
                        <div class="day-management-page-exercise-details">${exercise.sets} séries × ${exercise.reps} reps ${exercise.weight ? `@ ${exercise.weight} kg` : ''}</div>
                    </div>
                    <div>
                        <button class="day-management-page-exercise-edit" onclick="openEditExerciseModalFromPage(${index})"><i class="bi bi-pencil"></i></button>
                        <button class="day-management-page-exercise-remove" onclick="openDeleteExerciseConfirmModalFromPage(${index})"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }
        
        function openAddExerciseToDayModalFromPage() {
            // Abrir o modal correto para adicionar exercício ao dia
            document.getElementById('addExerciseToDayModal').style.display = 'block';
            
            // Preencher o select com exercícios disponíveis
            const exerciseSelect = document.getElementById('exerciseSelect');
            exerciseSelect.innerHTML = '<option value="">Selecione um exercício</option>' + 
                availableExercises.map(e => `<option value="${e.name}">${e.name}</option>`).join('');
        }
        
        function openEditExerciseModalFromPage(exerciseIndex) {
            openEditExerciseModal(currentDayManagementIndex, exerciseIndex);
        }
        
        function openDeleteExerciseConfirmModalFromPage(exerciseIndex) {
            openDeleteExerciseConfirmModal(currentDayManagementIndex, exerciseIndex);
        }
        
        // Funções de drag and drop para reordenar exercícios
        let draggedExerciseIndex = null;
        
        function dragExerciseStart(event, index) {
            draggedExerciseIndex = index;
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', '');
            event.currentTarget.classList.add('dragging');
        }
        
        function dragExerciseOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
        
        function dragExerciseDrop(event, targetIndex) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragging');
            
            if (draggedExerciseIndex !== null && draggedExerciseIndex !== targetIndex) {
                // Reordenar os exercícios
                const day = currentPlanDetail.days[currentDayManagementIndex];
                const exercises = day.exercises;
                const draggedExercise = exercises[draggedExerciseIndex];
                
                // Remover o exercício arrastado
                exercises.splice(draggedExerciseIndex, 1);
                // Inserir na nova posição
                exercises.splice(targetIndex, 0, draggedExercise);
                
                // Atualizar o plano
                const plans = loadPlansData();
                const planIndex = plans.findIndex(p => p.id === currentPlanDetail.id);
                if (planIndex !== -1) {
                    plans[planIndex] = currentPlanDetail;
                    savePlansData(plans);
                }
                
                // Re-renderizar a lista
                renderDayManagementPageExerciseList(exercises);
                
                showToast('Exercício movido.');
            }
            
            draggedExerciseIndex = null;
        }
        
        function saveExerciseToDayFromPage() {
            saveExerciseToDay(currentDayManagementIndex);
        }
        
        // MODAL: Adicionar exercício ao dia
        function openAddExerciseToDayModal(dayIndex) {
            console.log('Abrir modal para adicionar exercício. DayIndex:', dayIndex);
            console.log('Available exercises:', availableExercises);
            
            currentDayForExercise = dayIndex;
            document.getElementById('addExerciseToDayModal').style.display = 'block';
            
            // Preencher o select com exercícios disponíveis
            const exerciseSelect = document.getElementById('exerciseSelect');
            exerciseSelect.innerHTML = '<option value="">Selecione um exercício</option>' + 
                availableExercises.map(e => `<option value="${e.name}">${e.name}</option>`).join('');
            
            console.log('Select preenchido com exercícios');
        }
        
        function closeAddExerciseToDayModal() {
            document.getElementById('addExerciseToDayModal').style.display = 'none';
        }
        
        function saveExerciseToDay() {
            const exerciseName = document.getElementById('exerciseSelect').value;
            const sets = parseInt(document.getElementById('exerciseSets').value) || 1;
            const reps = parseInt(document.getElementById('exerciseReps').value) || 1;
            const weight = parseFloat(document.getElementById('exerciseWeight').value) || 0;
            
            console.log('Dados do exercício:', { exerciseName, sets, reps, weight });
            console.log('currentDayForExercise:', currentDayForExercise);
            console.log('currentPlanDetail:', currentPlanDetail);
            
            if (!exerciseName) {
                alert('Por favor, selecione um exercício.');
                return;
            }
            
            if (!sets || sets < 1) {
                alert('Por favor, insira um número válido de séries.');
                return;
            }
            
            if (!reps || reps < 1) {
                alert('Por favor, insira um número válido de repetições.');
                return;
            }
            
            // Verificar se currentPlanDetail existe
            if (!currentPlanDetail) {
                console.error('currentPlanDetail não está definido');
                alert('Erro: Plano não encontrado.');
                return;
            }
            
            // Verificar se o dia existe
            if (!currentPlanDetail.days || !currentPlanDetail.days[currentDayForExercise]) {
                console.error('Dia não encontrado no índice:', currentDayForExercise);
                alert('Erro: Dia não encontrado.');
                return;
            }
            
            // Garantir que o array de exercícios existe
            if (!currentPlanDetail.days[currentDayForExercise].exercises) {
                currentPlanDetail.days[currentDayForExercise].exercises = [];
            }
            
            // Adicionar o exercício
            currentPlanDetail.days[currentDayForExercise].exercises.push({
                name: exerciseName,
                sets: sets,
                reps: reps,
                weight: weight
            });
            
            console.log('Exercício adicionado. Lista atual:', currentPlanDetail.days[currentDayForExercise].exercises);
            
            // Atualizar o plano no localStorage
            const plans = loadPlansData();
            const planIndex = plans.findIndex(p => p.id === currentPlanDetail.id);
            
            if (planIndex !== -1) {
                plans[planIndex] = currentPlanDetail;
                savePlansData(plans);
                console.log('Plano atualizado no localStorage');
            } else {
                console.error('Plano não encontrado no localStorage');
            }
            
            // Atualizar a visualização
            if (currentPage === 'dayManagementPage') {
                renderDayManagementPageExerciseList(currentPlanDetail.days[currentDayForExercise].exercises);
            } else {
                renderPlanDaysDetail(currentPlanDetail.days);
            }
            
            closeAddExerciseToDayModal();
            showToast('Exercício adicionado ao dia.');
        }
        
        // MODAL: Editar exercício do dia
        function openEditExerciseModal(dayIndex, exerciseIndex) {
            if (!currentPlanDetail || !currentPlanDetail.days[dayIndex] || !currentPlanDetail.days[dayIndex].exercises[exerciseIndex]) {
                console.error('Erro: Exercício não encontrado');
                return;
            }
            
            const exercise = currentPlanDetail.days[dayIndex].exercises[exerciseIndex];
            document.getElementById('editExerciseNameStatic').textContent = exercise.name;
            document.getElementById('editExerciseSets').value = exercise.sets || 1;
            document.getElementById('editExerciseReps').value = exercise.reps || 1;
            document.getElementById('editExerciseWeight').value = exercise.weight || 0;
            
            // Guardar referências
            currentDayForExercise = dayIndex;
            exerciseToRemoveIndex = exerciseIndex;
            
            document.getElementById('editExerciseModal').style.display = 'block';
        }
        
        function closeEditExerciseModal() {
            document.getElementById('editExerciseModal').style.display = 'none';
        }
        
        function saveEditedExercise() {
            const sets = parseInt(document.getElementById('editExerciseSets').value) || 1;
            const reps = parseInt(document.getElementById('editExerciseReps').value) || 1;
            const weight = parseFloat(document.getElementById('editExerciseWeight').value) || 0;
            
            if (!sets || sets < 1) {
                alert('Por favor, insira um número válido de séries.');
                return;
            }
            
            if (!reps || reps < 1) {
                alert('Por favor, insira um número válido de repetições.');
                return;
            }
            
            // Atualizar o exercício
            if (currentPlanDetail && currentPlanDetail.days[currentDayForExercise] && 
                currentPlanDetail.days[currentDayForExercise].exercises[exerciseToRemoveIndex]) {
                
                currentPlanDetail.days[currentDayForExercise].exercises[exerciseToRemoveIndex].sets = sets;
                currentPlanDetail.days[currentDayForExercise].exercises[exerciseToRemoveIndex].reps = reps;
                currentPlanDetail.days[currentDayForExercise].exercises[exerciseToRemoveIndex].weight = weight;
                
                // Atualizar o plano
                const plans = loadPlansData();
                const planIndex = plans.findIndex(p => p.id === currentPlanDetail.id);
                if (planIndex !== -1) {
                    plans[planIndex] = currentPlanDetail;
                    savePlansData(plans);
                }
                
                // Atualizar a visualização
                if (currentPage === 'dayManagementPage') {
                    renderDayManagementPageExerciseList(currentPlanDetail.days[currentDayForExercise].exercises);
                } else {
                    renderPlanDaysDetail(currentPlanDetail.days);
                }
                
                closeEditExerciseModal();
                showToast('Exercício atualizado.');
            }
        }
        
        // MODAL: Confirmar remoção de exercício do dia
        function openDeleteExerciseConfirmModal(dayIndex, exerciseIndex) {
            if (!currentPlanDetail || !currentPlanDetail.days[dayIndex] || !currentPlanDetail.days[dayIndex].exercises[exerciseIndex]) {
                console.error('Erro: Exercício não encontrado');
                return;
            }
            
            const exercise = currentPlanDetail.days[dayIndex].exercises[exerciseIndex];
            
            // Guardar referências
            currentDayForExercise = dayIndex;
            exerciseToRemoveIndex = exerciseIndex;
            
            document.getElementById('deleteExerciseConfirmModal').style.display = 'block';
        }
        
        function closeDeleteExerciseConfirmModal() {
            document.getElementById('deleteExerciseConfirmModal').style.display = 'none';
        }
        
        function confirmRemoveExerciseFromDay() {
            // Remover o exercício
            if (currentPlanDetail && currentPlanDetail.days[currentDayForExercise] && 
                currentPlanDetail.days[currentDayForExercise].exercises[exerciseToRemoveIndex]) {
                
                currentPlanDetail.days[currentDayForExercise].exercises.splice(exerciseToRemoveIndex, 1);
                
                // Atualizar o plano
                const plans = loadPlansData();
                const planIndex = plans.findIndex(p => p.id === currentPlanDetail.id);
                if (planIndex !== -1) {
                    plans[planIndex] = currentPlanDetail;
                    savePlansData(plans);
                }
                
                // Atualizar a visualização
                if (currentPage === 'dayManagementPage') {
                    renderDayManagementPageExerciseList(currentPlanDetail.days[currentDayForExercise].exercises);
                } else {
                    renderPlanDaysDetail(currentPlanDetail.days);
                }
                
                closeDeleteExerciseConfirmModal();
                showToast('Exercício removido do dia.');
            }
        }
        
        function removeExerciseFromDay() {
            // Esta função é chamada diretamente do modal de edição
            closeEditExerciseModal();
            openDeleteExerciseConfirmModal(currentDayForExercise, exerciseToRemoveIndex);
        }
        
        // MODAL: Adicionar exercício ao dia a partir da gestão
        function openAddExerciseToDayModalFromManagement() {
            openAddExerciseToDayModal(currentDayManagementIndex);
        }
        
        // MODAL: Editar nome do dia
        function openEditDayNameModalFromPage() {
            openEditDayNameModal(currentDayManagementIndex);
        }
        
        // MODAL: Adicionar dia
        function openAddDayModal(){ 
            document.getElementById('addDayModal').style.display='block'; 
            document.getElementById('dayNameInput').value=''; 
        }
        
        function closeAddDayModal(){ document.getElementById('addDayModal').style.display='none'; }
        
        function saveDay(){ 
            const name=document.getElementById('dayNameInput').value.trim(); 
            if(!name){ alert('Por favor, insira um nome para o dia.'); return; } 
            
            if(!currentPlanDetail.days) currentPlanDetail.days=[]; 
            currentPlanDetail.days.push({name: name, exercises: []}); 
            
            const plans=loadPlansData(); 
            const planIndex=plans.findIndex(p=>p.id===currentPlanDetail.id); 
            if(planIndex!==-1){ 
                plans[planIndex]=currentPlanDetail; 
                savePlansData(plans); 
            } 
            
            renderPlanDaysDetail(currentPlanDetail.days); 
            closeAddDayModal(); 
            showToast('Dia adicionado.'); 
        }
        
        // MODAL: Opções do dia (renomear/apagar)
        function openDayOptionsModal(dayIndex) {
            if (typeof dayIndex === 'undefined') {
                dayIndex = currentDayManagementIndex;
            }
            
            if (!currentPlanDetail || !currentPlanDetail.days[dayIndex]) {
                console.error('Erro: Dia não encontrado');
                return;
            }
            
            const day = currentPlanDetail.days[dayIndex];
            document.getElementById('dayNameToDelete').textContent = day.name;
            
            // Guardar referência do dia a ser removido
            currentDayForExercise = dayIndex;
            
            document.getElementById('dayOptionsModal').style.display = 'block';
        }
        
        function closeDayOptionsModal(){ document.getElementById('dayOptionsModal').style.display='none'; }
        
        function removeDay(){ 
            if(!currentPlanDetail || !currentPlanDetail.days[currentDayForExercise]) return; 
            
            currentPlanDetail.days.splice(currentDayForExercise,1); 
            
            const plans=loadPlansData(); 
            const planIndex=plans.findIndex(p=>p.id===currentPlanDetail.id); 
            if(planIndex!==-1){ 
                plans[planIndex]=currentPlanDetail; 
                savePlansData(plans); 
            } 
            
            renderPlanDaysDetail(currentPlanDetail.days); 
            closeDayOptionsModal(); 
            showToast('Dia removido.'); 
            
            // Se está na página de gestão do dia, voltar para o detalhe do plano
            if (currentPage === 'dayManagementPage') {
                closeDayManagementPage();
            }
        }
        
        // MODAL: Editar nome do dia
        function openEditDayNameModal(dayIndex) {
            if (typeof dayIndex === 'undefined') {
                dayIndex = currentDayManagementIndex;
            }
            
            if (!currentPlanDetail || !currentPlanDetail.days[dayIndex]) {
                console.error('Erro: Dia não encontrado');
                return;
            }
            
            const day = currentPlanDetail.days[dayIndex];
            document.getElementById('editDayNameInput').value = day.name;
            
            // Guardar referência do dia a ser editado
            currentDayForExercise = dayIndex;
            
            document.getElementById('editDayNameModal').style.display = 'block';
        }
        
        function closeEditDayNameModal(){ document.getElementById('editDayNameModal').style.display='none'; }
        
        function saveDayName(){ 
            const name=document.getElementById('editDayNameInput').value.trim(); 
            if(!name){ alert('Por favor, insira um nome para o dia.'); return; } 
            
            if(!currentPlanDetail || !currentPlanDetail.days[currentDayForExercise]) return; 
            
            currentPlanDetail.days[currentDayForExercise].name=name; 
            
            const plans=loadPlansData(); 
            const planIndex=plans.findIndex(p=>p.id===currentPlanDetail.id); 
            if(planIndex!==-1){ 
                plans[planIndex]=currentPlanDetail; 
                savePlansData(plans); 
            } 
            
            // Atualizar a visualização
            if (currentPage === 'dayManagementPage') {
                document.getElementById('dayManagementPageTitle').textContent = name;
            } else {
                renderPlanDaysDetail(currentPlanDetail.days);
            }
            
            closeEditDayNameModal(); 
            showToast('Nome do dia alterado.'); 
        }
        
        // MODAL: Editar nome do plano
        function openEditPlanNameModal(){ 
            document.getElementById('editPlanNameInput').value=currentPlanDetail.name; 
            document.getElementById('editPlanNameModal').style.display='block'; 
        }
        
        function closeEditPlanNameModal(){ document.getElementById('editPlanNameModal').style.display='none'; }
        
        function savePlanName(){ 
            const name=document.getElementById('editPlanNameInput').value.trim(); 
            if(!name){ alert('Por favor, insira um nome para o plano.'); return; } 
            
            currentPlanDetail.name=name; 
            document.getElementById('planDetailTitle').textContent=name; 
            
            const plans=loadPlansData(); 
            const planIndex=plans.findIndex(p=>p.id===currentPlanDetail.id); 
            if(planIndex!==-1){ 
                plans[planIndex]=currentPlanDetail; 
                savePlansData(plans); 
            } 
            
            renderPlans(); 
            closeEditPlanNameModal(); 
            showToast('Nome do plano alterado.'); 
        }
        
        // MODAL: Confirmar remoção do plano
        function openDeletePlanConfirmModal(){ 
            document.getElementById('deletePlanConfirmModal').style.display='block'; 
        }
        
        function closeDeletePlanConfirmModal(){ document.getElementById('deletePlanConfirmModal').style.display='none'; }
        
        function removePlan(){ 
            openDeletePlanConfirmModal(); 
        }
        
        function confirmRemovePlan(){ 
            const plans=loadPlansData(); 
            const planIndex=plans.findIndex(p=>p.id===currentPlanDetail.id); 
            if(planIndex!==-1){ 
                plans.splice(planIndex,1); 
                savePlansData(plans); 
            } 
            
            // Se era o plano selecionado, limpar seleção
            if(selectedPlanId===currentPlanDetail.id){ 
                selectedPlanId=null; 
                localStorage.removeItem(storageKeys.SELECTED_PLAN); 
                document.getElementById('selectedPlanLabel').textContent='—'; 
                document.getElementById('selectedPlanDays').innerHTML=''; 
            } 
            
            closeDeletePlanConfirmModal(); 
            showToast('Plano removido.'); 
            closePlanDetail(); 
        }
        
        // MODAL: Criar plano
        function openPlanModal(){ 
            document.getElementById('modalPlanTitle').textContent='Criar Plano de Treino'; 
            document.getElementById('planNameInput').value=''; 
            document.getElementById('planModal').style.display='block'; 
        }
        
        function closePlanModal(){ document.getElementById('planModal').style.display='none'; }
        
        function savePlan(){ 
            const name=document.getElementById('planNameInput').value.trim(); 
            if(!name){ alert('Por favor, insira um nome para o plano.'); return; } 
            
            const plans=loadPlansData(); 
            plans.push({ id: Date.now().toString(), name: name, days: [] }); 
            savePlansData(plans); 
            
            renderPlans(); 
            closePlanModal(); 
            showToast('Plano criado.'); 
        }
        
        // MODAL: Seleção de plano
        function openPlanSelection(){ 
            const plans=loadPlansData(); 
            const list=document.getElementById('planSelectionList'); 
            if(plans.length===0){ list.innerHTML='<div class="card">Sem planos ainda.</div>'; } 
            else{ 
                list.innerHTML=plans.map(p=>`
                    <div class="plan-selection-item" onclick="selectPlan('${p.id}')">
                        <div class="title">${p.name}</div>
                        <div class="subtitle">${p.days.length} dias</div>
                    </div>
                `).join(''); 
            } 
            document.getElementById('planSelectionModal').style.display='block'; 
        }
        
        function closePlanSelection(){ document.getElementById('planSelectionModal').style.display='none'; }
        
        function selectPlan(id){ 
            selectedPlanId=id; 
            localStorage.setItem(storageKeys.SELECTED_PLAN,id); 
            const plans=loadPlansData(); 
            const plan=plans.find(p=>p.id===id); 
            if(plan){ 
                document.getElementById('selectedPlanLabel').textContent=plan.name; 
                renderSelectedPlanDays(plan); 
            } 
            closePlanSelection(); 
            showToast('Plano selecionado.'); 
        }
        
        function renderSelectedPlanDays(plan){ 
            const container = document.getElementById('selectedPlanDays'); 
            if(!plan.days || plan.days.length === 0){ 
                container.innerHTML = '<div class="card">Este plano não tem dias de treino ainda.</div>'; 
                return; 
            } 
            
            container.innerHTML = plan.days.map((day, index) => `
                <div class="day-card">
                    <div class="day-number-box">
                        <div>DIA</div>
                        <div>${index + 1}</div>
                    </div>
                    <div style="flex:1">
                        <h5>${day.name}</h5>
                        <small>${day.exercises ? day.exercises.length : 0} exercícios</small>
                    </div>
                    <button class="start-workout-btn-home" onclick="openDayDetail('${plan.id}', ${index})">Iniciar</button>
                </div>
            `).join(''); 
        }
        
        // ===== Funções para a Página de Detalhes do Dia =====
        function openDayDetail(planId, dayIndex){ 
            console.log('openDayDetail called with:', planId, dayIndex);
            
            const plans = loadPlansData(); 
            const plan = plans.find(p => p.id === planId); 
            
            if(!plan) {
                console.error('Plano não encontrado:', planId);
                showToast('Plano não encontrado');
                return;
            } 
            
            if (!plan.days || !plan.days[dayIndex]) {
                console.error('Dia não encontrado:', dayIndex, 'em plano:', plan.name);
                showToast('Dia não encontrado no plano');
                return;
            }
            
            currentDayDetail = { 
                planId: planId, 
                dayIndex: dayIndex, 
                planName: plan.name, 
                day: plan.days[dayIndex] 
            }; 
            
            document.getElementById('dayDetailTitle').textContent = plan.days[dayIndex].name; 
            renderDayExercises(plan.days[dayIndex].exercises); 
            showPage('dayDetailPage'); 
        }
        
        function closeDayDetail(){ showPage('mainPage'); }
        
        function renderDayExercises(exercises){ 
            const list=document.getElementById('dayExercisesList'); 
            if(!exercises||exercises.length===0){ 
                list.innerHTML='<div class="card">Este dia não tem exercícios ainda.</div>'; 
                return; 
            } 
            list.innerHTML=exercises.map(ex=>`
                <div class="day-detail-exercise">
                    <div class="day-detail-exercise-header">
                        <div class="day-detail-exercise-name">${ex.name}</div>
                    </div>
                    <div class="day-detail-exercise-details">
                        <div class="day-detail-exercise-sets">${ex.sets} séries</div>
                        <div class="day-detail-exercise-weight">${ex.reps} reps ${ex.weight?`@ ${ex.weight} kg`:''}</div>
                    </div>
                </div>
            `).join(''); 
        }

        // ===== Funções para a Página de Treinos (Histórico) =====
        function renderWorkouts() {
            const list = document.getElementById('workoutsList');
            const q = (document.getElementById('workoutSearch').value || '').toLowerCase();
            let workouts = loadWorkoutsData();
            
            // Aplicar filtros
            if (workoutFilters.dateStart) {
                workouts = workouts.filter(w => new Date(w.startTime) >= new Date(workoutFilters.dateStart));
            }
            if (workoutFilters.dateEnd) {
                workouts = workouts.filter(w => new Date(w.startTime) <= new Date(workoutFilters.dateEnd));
            }
            if (workoutFilters.plan) {
                workouts = workouts.filter(w => w.planName === workoutFilters.plan);
            }
            
            // Aplicar pesquisa por texto
            if (q) {
                workouts = workouts.filter(w => 
                    w.planName.toLowerCase().includes(q) || 
                    w.dayName.toLowerCase().includes(q) ||
                    (w.exercises && w.exercises.some(e => e.name.toLowerCase().includes(q)))
                );
            }
            
            // Ordenar por data (mais recente primeiro)
            workouts.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
            
            if (workouts.length === 0) {
                list.innerHTML = '<div class="card">Nenhum treino encontrado.</div>';
                return;
            }
            
            list.innerHTML = workouts.map((workout, index) => {
                // Calcular duração
                let duration = 'N/A';
                if (workout.startTime && workout.endTime) {
                    const start = new Date(workout.startTime);
                    const end = new Date(workout.endTime);
                    const diffMs = end - start;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMins / 60);
                    const remainingMins = diffMins % 60;
                    
                    if (diffHours > 0) {
                        duration = `${diffHours}h ${remainingMins}m`;
                    } else {
                        duration = `${remainingMins}m`;
                    }
                }
                
                return `
                    <div class="workout-item-compact" onclick="openWorkoutDetailModal('${workout.id}')">
                        <div class="workout-header-compact">
                            <div class="workout-title-compact">${workout.planName} - ${workout.dayName}</div>
                            <div class="workout-date-compact">${new Date(workout.startTime).toLocaleDateString('pt-PT')}</div>
                        </div>
                        <div class="workout-details-compact">
                            <div class="workout-day-compact">${workout.exercises ? workout.exercises.length : 0} exercícios</div>
                            <div class="workout-duration-compact">${duration}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // MODAL: Detalhes do treino
        function openWorkoutDetailModal(workoutId) {
            const workouts = loadWorkoutsData();
            const workout = workouts.find(w => w.id === workoutId);
            
            if (!workout) {
                showToast('Treino não encontrado');
                return;
            }
            
            currentWorkoutDetail = workout;
            
            // Preencher informações básicas
            const infoElement = document.getElementById('workoutDetailInfo');
            
            // Calcular duração
            let duration = 'N/A';
            if (workout.startTime && workout.endTime) {
                const start = new Date(workout.startTime);
                const end = new Date(workout.endTime);
                const diffMs = end - start;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const remainingMins = diffMins % 60;
                
                if (diffHours > 0) {
                    duration = `${diffHours}h ${remainingMins}m`;
                } else {
                    duration = `${remainingMins}m`;
                }
            }
            
            infoElement.innerHTML = `
                <div class="workout-detail-info-item">
                    <span class="workout-detail-info-label">Data:</span>
                    <span class="workout-detail-info-value">${new Date(workout.startTime).toLocaleDateString('pt-PT')}</span>
                </div>
                <div class="workout-detail-info-item">
                    <span class="workout-detail-info-label">Duração:</span>
                    <span class="workout-detail-info-value">${duration}</span>
                </div>
                <div class="workout-detail-info-item">
                    <span class="workout-detail-info-label">Plano:</span>
                    <span class="workout-detail-info-value">${workout.planName}</span>
                </div>
                <div class="workout-detail-info-item">
                    <span class="workout-detail-info-label">Dia:</span>
                    <span class="workout-detail-info-value">${workout.dayName}</span>
                </div>
            `;
            
            // Preencher exercícios
            const exercisesElement = document.getElementById('workoutDetailExercises');
            exercisesElement.innerHTML = '';
            
            if (!workout.exercises || workout.exercises.length === 0) {
                exercisesElement.innerHTML = '<div class="card">Nenhum exercício registado.</div>';
            } else {
                workout.exercises.forEach(exercise => {
                    const exerciseElement = document.createElement('div');
                    exerciseElement.className = 'workout-detail-exercise';
                    exerciseElement.innerHTML = `
                        <div class="workout-detail-exercise-header" onclick="this.parentElement.classList.toggle('expanded')">
                            <div class="workout-detail-exercise-name">${exercise.name}</div>
                            <div>${exercise.sets ? exercise.sets.length : 0} séries</div>
                        </div>
                        <div class="workout-detail-exercise-details">
                            ${exercise.targetUpdate && exercise.targetUpdate.updated ? `
                                <div class="exercise-completed-target target-updated" style="margin-bottom: 10px;">
                                    <strong>🎉 Objetivo atualizado!</strong><br>
                                    <span class="target-old">${exercise.targetUpdate.oldTarget.reps} reps × ${exercise.targetUpdate.oldTarget.weight} kg</span>
                                    <span class="target-new">${exercise.targetUpdate.newTarget.reps} reps × ${exercise.targetUpdate.newTarget.weight} kg</span>
                                </div>
                            ` : ''}
                            <div class="workout-detail-set workout-detail-set-header">
                                <div>Série</div>
                                <div>Reps</div>
                                <div>Peso</div>
                            </div>
                            ${exercise.sets ? exercise.sets.map((set, index) => `
                                <div class="workout-detail-set">
                                    <div>${index + 1}</div>
                                    <div>${set.repetitions || 0}</div>
                                    <div>${set.weight || 0} kg</div>
                                </div>
                            `).join('') : ''}
                        </div>
                    `;
                    exercisesElement.appendChild(exerciseElement);
                });
            }
            
            document.getElementById('workoutDetailModal').style.display = 'block';
        }
        
        function closeWorkoutDetailModal() {
            document.getElementById('workoutDetailModal').style.display = 'none';
        }
        
        // MODAL: Confirmar eliminação do treino
        function openDeleteWorkoutConfirmModal() {
            document.getElementById('deleteWorkoutConfirmModal').style.display = 'block';
        }
        
        function closeDeleteWorkoutConfirmModal() {
            document.getElementById('deleteWorkoutConfirmModal').style.display = 'none';
        }
        
        function deleteWorkout() {
            // Abrir modal de confirmação
            openDeleteWorkoutConfirmModal();
        }
        
        function confirmDeleteWorkout() {
            if (!currentWorkoutDetail) return;
            
            const workouts = loadWorkoutsData();
            const workoutIndex = workouts.findIndex(w => w.id === currentWorkoutDetail.id);
            
            if (workoutIndex !== -1) {
                workouts.splice(workoutIndex, 1);
                saveWorkoutsData(workouts);
                
                closeWorkoutDetailModal();
                closeDeleteWorkoutConfirmModal();
                renderWorkouts();
                showToast('Treino eliminado.');
            }
        }

        // ===== NOVAS FUNÇÕES PARA O FLUXO DE TREINO =====
        
        // Iniciar um treino a partir do detalhe do dia
        function startWorkout() {
            if (!currentDayDetail) return;
            
            // Verificar se já existe um treino em progresso
            if (ongoingWorkout && !isWorkoutSaved) {
                if (confirm('Já existe um treino em progresso. Deseja continuar com o treino anterior ou iniciar um novo?')) {
                    // Continuar com o treino anterior
                    showPage('workoutPage');
                    renderWorkoutExercises(ongoingWorkout.exercises);
                    return;
                } else {
                    // Eliminar o treino anterior e iniciar um novo
                    localStorage.removeItem(storageKeys.ONGOING_WORKOUT);
                    ongoingWorkout = null;
                }
            }
            
            const plan = loadPlansData().find(p => p.id === currentDayDetail.planId);
            if (!plan) return;
            
            const day = plan.days[currentDayDetail.dayIndex];
            if (!day) return;
            
            // Criar um novo treino
            currentWorkout = {
                id: Date.now().toString(),
                planId: currentDayDetail.planId,
                planName: plan.name,
                dayIndex: currentDayDetail.dayIndex,
                dayName: day.name,
                startTime: new Date().toISOString(),
                endTime: null,
                exercises: day.exercises.map(exercise => ({
                    name: exercise.name,
                    targetSets: exercise.sets,
                    targetReps: exercise.reps,
                    targetWeight: exercise.weight,
                    sets: [],
                    completed: false,
                    targetUpdate: null
                })),
                completedExercises: []
            };
            
            // Guardar como treino em progresso
            saveOngoingWorkout(currentWorkout);
            
            // Ir para a página do treino
            showPage('workoutPage');
            document.getElementById('workoutTitle').textContent = `${plan.name} - ${day.name}`;
            renderWorkoutExercises(currentWorkout.exercises);
            
            // Iniciar o temporizador
            workoutStartTime = new Date();
        }
        
        // Renderizar exercícios na página do treino
        function renderWorkoutExercises(exercises) {
            const list = document.getElementById('workoutExercisesList');
            list.innerHTML = '';
            
            // Separar exercícios não concluídos e concluídos
            const incompleteExercises = exercises.filter(ex => !ex.completed);
            const completeExercises = exercises.filter(ex => ex.completed);
            
            // Juntar: não concluídos primeiro, depois concluídos
            const sortedExercises = [...incompleteExercises, ...completeExercises];
            
            sortedExercises.forEach((exercise, index) => {
                const originalIndex = exercises.indexOf(exercise);
                const exerciseElement = document.createElement('div');
                exerciseElement.className = `workout-exercise-item ${exercise.completed ? 'workout-exercise-completed' : ''}`;
                
                if (exercise.completed) {
                    // Para exercícios concluídos: mostrar botão de detalhes
                    exerciseElement.innerHTML = `
                        <div class="workout-exercise-info">
                            <div class="workout-exercise-name">${exercise.name}</div>
                            <div class="workout-exercise-details">
                                ${exercise.targetSets} séries × ${exercise.targetReps} reps ${exercise.targetWeight ? `@ ${exercise.targetWeight} kg` : ''}
                            </div>
                        </div>
                        <button class="workout-exercise-btn" onclick="showExerciseDetails(${originalIndex})">Ver Detalhes</button>
                    `;
                } else {
                    // Para exercícios não concluídos: botão normal
                    exerciseElement.innerHTML = `
                        <div class="workout-exercise-info">
                            <div class="workout-exercise-name">${exercise.name}</div>
                            <div class="workout-exercise-details">
                                ${exercise.targetSets} séries × ${exercise.targetReps} reps ${exercise.targetWeight ? `@ ${exercise.targetWeight} kg` : ''}
                            </div>
                        </div>
                        <button class="workout-exercise-btn" ${exerciseInProgress && originalIndex !== currentExerciseIndex ? 'disabled' : ''} onclick="startExercise(${originalIndex})">
                            ${exerciseInProgress && originalIndex === currentExerciseIndex ? 'Em Progresso' : 'Iniciar'}
                        </button>
                    `;
                }
                list.appendChild(exerciseElement);
            });
        }

        function showExerciseDetails(exerciseIndex) {
            const exercise = currentWorkout.exercises[exerciseIndex];
            
            let contentHTML = '';
            
            if (exercise.targetUpdate && exercise.targetUpdate.updated) {
                contentHTML += `
                    <div class="exercise-completed-target target-updated">
                        <strong>🎉 Objetivo atualizado!</strong><br>
                        <span class="target-old">${exercise.targetUpdate.oldTarget.reps} reps × ${exercise.targetUpdate.oldTarget.weight} kg</span>
                        <span class="target-new">${exercise.targetUpdate.newTarget.reps} reps × ${exercise.targetUpdate.newTarget.weight} kg</span>
                    </div>
                `;
            }
            
            contentHTML += `
                <div class="exercise-completed-details">
                    <h4>Resultados:</h4>
                    ${exercise.sets.map((set, index) => `
                        <div class="exercise-completed-set">
                            <span>Série ${index + 1}:</span>
                            <span>${set.repetitions} reps × ${set.weight} kg</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('completedExerciseTitle').textContent = `Detalhes de ${exercise.name}`;
            document.getElementById('completedExerciseContent').innerHTML = contentHTML;
            document.getElementById('exerciseCompletedModal').style.display = 'block';
        }
        
        // Iniciar um exercício específico
        function startExercise(exerciseIndex) {
            // Verificar se já existe um exercício em progresso
            if (exerciseInProgress && exerciseIndex !== currentExerciseIndex) {
                showToast('Termine o exercício em progresso antes de iniciar outro.');
                return;
            }
            
            currentExerciseIndex = exerciseIndex;
            const exercise = currentWorkout.exercises[exerciseIndex];
            
            // Ir para a página de execução do exercício
            showPage('exerciseWorkoutPage');
            document.getElementById('exerciseWorkoutTitle').textContent = exercise.name;
            document.getElementById('exerciseWorkoutTarget').textContent = `${exercise.targetSets} séries × ${exercise.targetReps} reps ${exercise.targetWeight ? `@ ${exercise.targetWeight} kg` : ''}`;
            
            // Renderizar as séries
            renderExerciseSeries(exercise);
            
            // Atualizar o estado
            exerciseInProgress = true;
            
            // Guardar o treino em progresso
            saveOngoingWorkout(currentWorkout);
        }
        
        // Renderizar séries do exercício
        function renderExerciseSeries(exercise) {
            const grid = document.getElementById('seriesGrid');
            grid.innerHTML = '';
            
            const numSets = exercise.targetSets || 3;
            
            for (let i = 0; i < numSets; i++) {
                const set = exercise.sets[i] || { repetitions: '', weight: '' };
                
                const setElement = document.createElement('div');
                setElement.className = 'series-item';
                setElement.innerHTML = `
                    <div class="series-header">
                        <div class="series-number">Série ${i + 1}</div>
                    </div>
                    <div class="series-inputs">
                        <div class="input-group">
                            <label class="input-label">Repetições</label>
                            <input type="number" class="series-input" id="reps-${i}" value="${set.repetitions}" placeholder="0" min="0" oninput="saveExerciseData(${currentExerciseIndex})">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Peso (kg)</label>
                            <input type="number" class="series-input" id="weight-${i}" value="${set.weight}" placeholder="0" step="0.5" min="0" oninput="saveExerciseData(${currentExerciseIndex})">
                        </div>
                    </div>
                `;
                grid.appendChild(setElement);
            }
        }
        
        // Guardar dados do exercício em tempo real
        function saveExerciseData(exerciseIndex) {
            if (!currentWorkout) return;
            
            const exercise = currentWorkout.exercises[exerciseIndex];
            exercise.sets = [];
            
            const numSets = exercise.targetSets || 3;
            
            for (let i = 0; i < numSets; i++) {
                const reps = document.getElementById(`reps-${i}`).value;
                const weight = document.getElementById(`weight-${i}`).value;
                
                if (reps || weight) {
                    exercise.sets.push({
                        repetitions: reps || '0',
                        weight: weight || '0'
                    });
                } else {
                    exercise.sets.push({
                        repetitions: '',
                        weight: ''
                    });
                }
            }
            
            // Guardar o treino em progresso
            saveOngoingWorkout(currentWorkout);
        }
        
        // Terminar o exercício atual
        function finishExercise() {
            // Verificar se há séries não preenchidas
            const exercise = currentWorkout.exercises[currentExerciseIndex];
            let hasEmptySets = false;
            
            for (let i = 0; i < exercise.sets.length; i++) {
                const set = exercise.sets[i];
                if (!set.repetitions && !set.weight) {
                    hasEmptySets = true;
                    break;
                }
            }
            
            if (hasEmptySets) {
                // Mostrar modal de confirmação
                openConfirmFinishExerciseModal();
                return;
            }
            
            // Se todas as séries estão preenchidas, terminar normalmente
            actuallyFinishExercise();
        }
        
        // MODAL: Confirmar terminar exercício com séries em falta
        function openConfirmFinishExerciseModal() {
            document.getElementById('confirmFinishExerciseModal').style.display = 'block';
        }
        
        function closeConfirmFinishExerciseModal() {
            document.getElementById('confirmFinishExerciseModal').style.display = 'none';
        }
        
        function confirmFinishExercise() {
            // Preencher séries vazias com "0"
            const exercise = currentWorkout.exercises[currentExerciseIndex];
            
            for (let i = 0; i < exercise.sets.length; i++) {
                const set = exercise.sets[i];
                if (!set.repetitions && !set.weight) {
                    set.repetitions = '0';
                    set.weight = '0';
                } else if (!set.repetitions) {
                    set.repetitions = '0';
                } else if (!set.weight) {
                    set.weight = '0';
                }
            }
            
            closeConfirmFinishExerciseModal();
            actuallyFinishExercise();
        }
        
        function actuallyFinishExercise() {
            const exercise = currentWorkout.exercises[currentExerciseIndex];
            
            // Marcar como concluído
            exercise.completed = true;
            
            // Adicionar à lista de exercícios concluídos
            if (!currentWorkout.completedExercises.includes(currentExerciseIndex)) {
                currentWorkout.completedExercises.push(currentExerciseIndex);
                
                // Atualizar objetivos se aplicável
                const updateInfo = updatePlanTargetsBasedOnPerformance(currentWorkout, currentExerciseIndex);
                if (updateInfo.updated) {
                    exercise.targetUpdate = updateInfo;
                }
            }
            
            // Guardar o treino em progresso
            saveOngoingWorkout(currentWorkout);
            
            // Atualizar o estado
            exerciseInProgress = false;
            
            // Voltar para a página do treino
            showPage('workoutPage');
            renderWorkoutExercises(currentWorkout.exercises);
        }
        
        // MODAL: Exercício concluído
        function showExerciseCompletedModal(exercise) {
            document.getElementById('completedExerciseTitle').textContent = `${exercise.name} Concluído`;
            
            let contentHTML = '';
            
            if (exercise.targetUpdate && exercise.targetUpdate.updated) {
                contentHTML += `
                    <div class="exercise-completed-target target-updated">
                        <strong>🎉 Objetivo atualizado!</strong><br>
                        <span class="target-old">${exercise.targetUpdate.oldTarget.reps} reps × ${exercise.targetUpdate.oldTarget.weight} kg</span>
                        <span class="target-new">${exercise.targetUpdate.newTarget.reps} reps × ${exercise.targetUpdate.newTarget.weight} kg</span>
                    </div>
                `;
            }
            
            contentHTML += `
                <div class="exercise-completed-details">
                    <h4>Resultados:</h4>
                    ${exercise.sets.map((set, index) => `
                        <div class="exercise-completed-set">
                            <span>Série ${index + 1}:</span>
                            <span>${set.repetitions} reps × ${set.weight} kg</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('completedExerciseContent').innerHTML = contentHTML;
            document.getElementById('exerciseCompletedModal').style.display = 'block';
        }
        
        function closeExerciseCompletedModal() {
            document.getElementById('exerciseCompletedModal').style.display = 'none';
        }
        
        // Atualizar objetivos do plano com base no desempenho
        function updatePlanTargetsBasedOnPerformance(workout, exerciseIndex) {
            const exercise = workout.exercises[exerciseIndex];
            const plans = loadPlansData();
            const plan = plans.find(p => p.id === workout.planId);
            
            if (!plan || !plan.days[workout.dayIndex]) {
                return { updated: false };
            }
            
            const day = plan.days[workout.dayIndex];
            const planExercise = day.exercises.find(e => e.name === exercise.name);
            
            if (!planExercise) {
                return { updated: false };
            }
            
            // Calcular a melhor série (maior carga total)
            let bestTotalLoad = 0;
            let bestReps = 0;
            let bestWeight = 0;
            
            exercise.sets.forEach(set => {
                const reps = parseInt(set.repetitions) || 0;
                const weight = parseFloat(set.weight) || 0;
                const totalLoad = reps * weight;
                
                if (totalLoad > bestTotalLoad) {
                    bestTotalLoad = totalLoad;
                    bestReps = reps;
                    bestWeight = weight;
                }
            });
            
            // Calcular a carga total do objetivo atual
            const planReps = parseInt(planExercise.reps) || 0;
            const planWeight = parseFloat(planExercise.weight) || 0;
            const planTotalLoad = planReps * planWeight;
            
            // Se a melhor série excedeu o objetivo, atualizar
            if (bestTotalLoad > planTotalLoad && bestReps > 0 && bestWeight > 0) {
                const oldTarget = {
                    reps: planExercise.reps,
                    weight: planExercise.weight
                };
                
                // Atualizar para o novo objetivo
                planExercise.reps = bestReps.toString();
                planExercise.weight = bestWeight.toString();
                
                const newTarget = {
                    reps: bestReps,
                    weight: bestWeight
                };
                
                // Guardar as alterações no plano
                savePlansData(plans);
                
                return {
                    updated: true,
                    exerciseName: exercise.name,
                    oldTarget,
                    newTarget
                };
            }
            
            return { updated: false };
        }
        
        // Terminar o treino completo
        function finishWorkout() {
            // Verificar se há exercícios não concluídos
            const incompleteExercises = currentWorkout.exercises.filter((ex, index) => 
                !ex.completed && !currentWorkout.completedExercises.includes(index)
            );
            
            if (incompleteExercises.length > 0) {
                // Mostrar modal de confirmação
                openConfirmFinishWorkoutModal(incompleteExercises);
                return;
            }
            
            // Se todos os exercícios estão concluídos, terminar normalmente
            actuallyFinishWorkout();
        }
        
        // MODAL: Confirmar terminar treino com exercícios em falta
        function openConfirmFinishWorkoutModal(incompleteExercises) {
            const listElement = document.getElementById('missingExercisesList');
            listElement.innerHTML = '';
            
            incompleteExercises.forEach(exercise => {
                const item = document.createElement('div');
                item.className = 'missing-exercise-item';
                item.textContent = exercise.name;
                listElement.appendChild(item);
            });
            
            document.getElementById('confirmFinishWorkoutModal').style.display = 'block';
        }
        
        function closeConfirmFinishWorkoutModal() {
            document.getElementById('confirmFinishWorkoutModal').style.display = 'none';
        }
        
        function confirmFinishWorkout() {
            // Preencher exercícios em falta com séries vazias
            currentWorkout.exercises.forEach((exercise, index) => {
                if (!exercise.completed && !currentWorkout.completedExercises.includes(index)) {
                    // Criar séries vazias
                    exercise.sets = [];
                    for (let i = 0; i < exercise.targetSets; i++) {
                        exercise.sets.push({
                            repetitions: '0',
                            weight: '0'
                        });
                    }
                    
                    // Marcar como concluído
                    exercise.completed = true;
                    currentWorkout.completedExercises.push(index);
                }
            });
            
            closeConfirmFinishWorkoutModal();
            actuallyFinishWorkout();
        }
        
        function actuallyFinishWorkout() {
            console.log('Terminando treino...');
            
            // Definir hora de término
            currentWorkout.endTime = new Date().toISOString();
            
            // Calcular estatísticas para cada exercício
            currentWorkout.exercises.forEach(exercise => {
                if (exercise.sets && exercise.sets.length > 0) {
                    let totalReps = 0;
                    let totalVolume = 0;
                    let maxWeight = 0;
                    let weightCount = 0;
                    let totalWeight = 0;
                    
                    exercise.sets.forEach(set => {
                        const reps = parseInt(set.repetitions) || 0;
                        const weight = parseFloat(set.weight) || 0;
                        
                        totalReps += reps;
                        totalVolume += reps * weight;
                        
                        if (weight > maxWeight) {
                            maxWeight = weight;
                        }
                        
                        if (weight > 0) {
                            totalWeight += weight;
                            weightCount++;
                        }
                    });
                    
                    exercise.totalReps = totalReps;
                    exercise.totalVolume = totalVolume;
                    exercise.maxWeight = maxWeight;
                    exercise.averageWeightPerRep = weightCount > 0 ? totalWeight / weightCount : 0;
                }
            });
            
            // Adicionar ao histórico de treinos
            const workouts = loadWorkoutsData();
            workouts.push(currentWorkout);
            saveWorkoutsData(workouts);
            
            console.log('Treino guardado no histórico:', currentWorkout);
            
            // Limpar o treino em progresso
            localStorage.removeItem(storageKeys.ONGOING_WORKOUT);
            ongoingWorkout = null;
            exerciseInProgress = false;
            isWorkoutSaved = true;
            
            // Ir para a página de resumo
            showWorkoutSummary();
        }
        
        // Mostrar resumo do treino
        function showWorkoutSummary() {
            console.log('Mostrando resumo do treino...');
            console.log('currentWorkout:', currentWorkout);
            
            // Mostrar a página primeiro
            showPage('workoutSummaryPage');
            
            // Verificar se currentWorkout existe
            if (!currentWorkout) {
                console.error('currentWorkout não está definido!');
                document.getElementById('summaryPlanName').textContent = 'Treino não encontrado';
                document.getElementById('summaryDuration').textContent = 'N/A';
                document.getElementById('summaryExercisesList').innerHTML = 
                    '<div class="summary-exercise">Erro: Dados do treino não disponíveis.</div>';
                return;
            }
            
            // Preencher informações básicas
            document.getElementById('summaryPlanName').textContent = 
                (currentWorkout.planName || 'Plano desconhecido') + ' - ' + 
                (currentWorkout.dayName || 'Dia desconhecido');
            
            // Calcular duração
            let duration = 'N/A';
            if (currentWorkout.startTime && currentWorkout.endTime) {
                const start = new Date(currentWorkout.startTime);
                const end = new Date(currentWorkout.endTime);
                const diffMs = end - start;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const remainingMins = diffMins % 60;
                
                if (diffHours > 0) {
                    duration = `${diffHours}h ${remainingMins}m`;
                } else {
                    duration = `${remainingMins}m`;
                }
            }
            document.getElementById('summaryDuration').textContent = duration;
            
            // Preencher lista de exercícios
            const list = document.getElementById('summaryExercisesList');
            list.innerHTML = '';
            
            if (!currentWorkout.exercises || currentWorkout.exercises.length === 0) {
                list.innerHTML = '<div class="summary-exercise">Nenhum exercício registado neste treino.</div>';
                return;
            }
            
            console.log('Exercícios no treino:', currentWorkout.exercises.length);
            
            currentWorkout.exercises.forEach((exercise, index) => {
                const exerciseElement = document.createElement('div');
                exerciseElement.className = 'summary-exercise';
                
                // Calcular estatísticas para este exercício
                let totalReps = 0;
                let totalVolume = 0;
                let maxWeight = 0;
                let completedSets = 0;
                
                if (exercise.sets && exercise.sets.length > 0) {
                    exercise.sets.forEach(set => {
                        const reps = parseInt(set.repetitions) || 0;
                        const weight = parseFloat(set.weight) || 0;
                        
                        totalReps += reps;
                        totalVolume += reps * weight;
                        
                        if (weight > maxWeight) {
                            maxWeight = weight;
                        }
                        
                        if (reps > 0 || weight > 0) {
                            completedSets++;
                        }
                    });
                }
                
                let targetHTML = '';
                if (exercise.targetUpdate && exercise.targetUpdate.updated) {
                    targetHTML = `
                        <div style="margin-top: 8px; padding: 8px; background: rgba(46,125,50,0.2); border-radius: 8px; font-size: 0.9rem;">
                            <strong>🎉 Objetivo atualizado!</strong>
                            <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                                <span style="text-decoration: line-through; opacity: 0.7;">
                                    ${exercise.targetUpdate.oldTarget.reps} reps × ${exercise.targetUpdate.oldTarget.weight} kg
                                </span>
                                <span style="font-weight: bold; color: var(--primary);">
                                    ${exercise.targetUpdate.newTarget.reps} reps × ${exercise.targetUpdate.newTarget.weight} kg
                                </span>
                            </div>
                        </div>
                    `;
                }
                
                // Criar HTML detalhado para cada série
                let setsHTML = '';
                if (exercise.sets && exercise.sets.length > 0) {
                    setsHTML = `
                        <div style="margin-top: 8px; font-size: 0.9rem;">
                            <strong>Detalhes das séries:</strong>
                            <div style="margin-top: 4px;">
                                ${exercise.sets.map((set, setIndex) => `
                                    <div style="display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <span>Série ${setIndex + 1}:</span>
                                        <span>${set.repetitions || 0} reps × ${set.weight || 0} kg</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                exerciseElement.innerHTML = `
                    <div class="summary-exercise-name">${exercise.name || 'Exercício sem nome'}</div>
                    <div class="summary-exercise-details">
                        <div>
                            <strong>Objetivo:</strong> ${exercise.targetSets || 0} séries × ${exercise.targetReps || 0} reps ${exercise.targetWeight ? `@ ${exercise.targetWeight} kg` : ''}<br>
                            <strong>Séries completadas:</strong> ${completedSets}<br>
                            <strong>Reps totais:</strong> ${totalReps}
                        </div>
                        <div>
                            <strong>Peso máximo:</strong> ${maxWeight} kg<br>
                            <strong>Volume total:</strong> ${totalVolume.toFixed(0)} kg<br>
                            <strong>Estado:</strong> ${exercise.completed ? '✅ Concluído' : '❌ Não concluído'}
                        </div>
                    </div>
                    ${setsHTML}
                    ${targetHTML}
                `;
                list.appendChild(exerciseElement);
            });
            
            console.log('Resumo do treino renderizado com sucesso!');
        }
        
        function closeWorkoutSummary() {
            showPage('mainPage');
        }
        
        // Fechar páginas do treino
        function closeWorkoutPage() {
            // Verificar se há exercício em progresso
            if (exerciseInProgress) {
                openConfirmExitModal();
                return;
            }
            
            showPage('mainPage');
        }
        
        function closeExerciseWorkout() {
            // Verificar se há dados não guardados
            const exercise = currentWorkout.exercises[currentExerciseIndex];
            let hasData = false;
            
            if (exercise.sets && exercise.sets.length > 0) {
                for (let i = 0; i < exercise.sets.length; i++) {
                    const set = exercise.sets[i];
                    if (set.repetitions || set.weight) {
                        hasData = true;
                        break;
                    }
                }
            }
            
            if (hasData) {
                openConfirmExitModal();
                return;
            }
            
            // Se não há dados, apenas voltar
            exerciseInProgress = false;
            showPage('workoutPage');
        }
        
        // MODAL: Confirmar saída do treino
        function openConfirmExitModal() {
            document.getElementById('confirmExitModal').style.display = 'block';
        }
        
        function closeConfirmExitModal() {
            document.getElementById('confirmExitModal').style.display = 'none';
        }
        
        function confirmExitWorkout() {
            // Limpar o treino em progresso
            localStorage.removeItem(storageKeys.ONGOING_WORKOUT);
            ongoingWorkout = null;
            currentWorkout = null;
            exerciseInProgress = false;
            
            closeConfirmExitModal();
            showPage('mainPage');
        }
        
        // Funções do temporizador
        function startTimer() {
            const timerBtn = document.getElementById('timerBtnSmall');
            
            if (timerInterval) {
                // Parar o temporizador
                clearInterval(timerInterval);
                timerInterval = null;
                timerBtn.classList.remove('timer-active');
                timerBtn.innerHTML = '<i class="bi bi-stopwatch"></i>';
                timerSeconds = 120; // Reset para 2 minutos
            } else {
                // Iniciar o temporizador
                timerBtn.classList.add('timer-active');
                updateTimerDisplay();
                
                timerInterval = setInterval(() => {
                    timerSeconds--;
                    updateTimerDisplay();
                    
                    if (timerSeconds <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        timerBtn.classList.remove('timer-active');
                        timerBtn.innerHTML = '<i class="bi bi-stopwatch"></i>';
                        timerSeconds = 120; // Reset para 2 minutos
                        
                        // Tocar um som ou mostrar notificação (se suportado)
                        if ('vibrate' in navigator) {
                            navigator.vibrate(200);
                        }
                    }
                }, 1000);
            }
        }
        
        function updateTimerDisplay() {
            const timerBtn = document.getElementById('timerBtnSmall');
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            timerBtn.innerHTML = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Mostrar informações do exercício
        function showExerciseInfo() {
            const exercise = currentWorkout.exercises[currentExerciseIndex];
            const exerciseData = getExercisesData()[exercise.name] || { notes: '' };
            const mediaData = loadExerciseMediaData()[exercise.name] || {};
            
            document.getElementById('exerciseInfoTitle').textContent = exercise.name;
            
            let contentHTML = '';
            
            if (mediaData.image) {
                contentHTML += `<img src="${mediaData.image}" style="max-width: 100%; border-radius: 8px; margin-bottom: 12px;">`;
            }
            
            if (exerciseData.notes) {
                contentHTML += `<p>${exerciseData.notes}</p>`;
            } else {
                contentHTML += '<p>Nenhuma nota disponível para este exercício.</p>';
            }
            
            document.getElementById('exerciseInfoContent').innerHTML = contentHTML;
            document.getElementById('exerciseInfoModal').style.display = 'block';
        }
        
        function closeExerciseInfo() {
            document.getElementById('exerciseInfoModal').style.display = 'none';
        }
        
        // Alternar série de aquecimento
        function toggleWarmupSet() {
            const isChecked = document.getElementById('warmupCheckbox').checked;
            const exercise = currentWorkout.exercises[currentExerciseIndex];
            
            if (isChecked) {
                // Adicionar série de aquecimento no início
                exercise.sets.unshift({
                    repetitions: '',
                    weight: '',
                    isWarmup: true
                });
                exercise.targetSets = (exercise.targetSets || 0) + 1;
            } else {
                // Remover série de aquecimento
                if (exercise.sets.length > 0 && exercise.sets[0].isWarmup) {
                    exercise.sets.shift();
                    exercise.targetSets = Math.max(1, (exercise.targetSets || 1) - 1);
                }
            }
            
            // Re-renderizar as séries
            renderExerciseSeries(exercise);
            
            // Guardar o treino em progresso
            saveOngoingWorkout(currentWorkout);
        }
        
        // Retomar treino em progresso
        function resumeWorkout() {
            if (!ongoingWorkout) return;
            
            currentWorkout = ongoingWorkout;
            showPage('workoutPage');
            document.getElementById('workoutTitle').textContent = `${ongoingWorkout.planName} - ${ongoingWorkout.dayName}`;
            renderWorkoutExercises(ongoingWorkout.exercises);
            
            // Verificar se há um exercício em progresso
            exerciseInProgress = ongoingWorkout.exercises.some((ex, index) => 
                !ex.completed && ex.sets && ex.sets.length > 0 && 
                ex.sets.some(set => set.repetitions || set.weight)
            );
            
            if (exerciseInProgress) {
                // Encontrar o primeiro exercício não concluído com dados
                for (let i = 0; i < ongoingWorkout.exercises.length; i++) {
                    const ex = ongoingWorkout.exercises[i];
                    if (!ex.completed && ex.sets && ex.sets.length > 0 && 
                        ex.sets.some(set => set.repetitions || set.weight)) {
                        currentExerciseIndex = i;
                        break;
                    }
                }
            }
        }

        // ===== Funções de Mídia para Exercícios =====
        function loadExerciseMediaData() {
            try {
                return JSON.parse(localStorage.getItem(storageKeys.EXERCISE_MEDIA)) || {};
            } catch (e) {
                console.error("Erro ao carregar mídia de exercícios:", e);
                return {};
            }
        }
        
        function saveExerciseMediaData(mediaData) {
            localStorage.setItem(storageKeys.EXERCISE_MEDIA, JSON.stringify(mediaData));
        }
        
        function loadExerciseMedia(exerciseName) {
            const mediaData = loadExerciseMediaData();
            const exerciseMedia = mediaData[exerciseName] || {};
            
            const imageBox = document.getElementById('exerciseImageBox');
            const gifBox = document.getElementById('exerciseGifBox');
            
            // Limpar conteúdo anterior
            imageBox.querySelectorAll('img').forEach(img => img.remove());
            gifBox.querySelectorAll('img').forEach(img => img.remove());
            
            // Adicionar imagem se existir
            if (exerciseMedia.image) {
                const img = document.createElement('img');
                img.src = exerciseMedia.image;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                img.style.objectFit = 'contain';
                imageBox.appendChild(img);
                
                // Esconder o label
                imageBox.querySelector('.exercise-media-label').style.display = 'none';
            } else {
                // Mostrar o label
                imageBox.querySelector('.exercise-media-label').style.display = 'block';
            }
            
            // Adicionar GIF se existir
            if (exerciseMedia.gif) {
                const img = document.createElement('img');
                img.src = exerciseMedia.gif;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                img.style.objectFit = 'contain';
                gifBox.appendChild(img);
                
                // Esconder o label
                gifBox.querySelector('.exercise-media-label').style.display = 'none';
            } else {
                // Mostrar o label
                gifBox.querySelector('.exercise-media-label').style.display = 'block';
            }
        }
        
        function openExerciseMediaMenu(type, event) {
            event.stopPropagation();
            
            // Fechar outros menus abertos
            closeExerciseMediaMenus();
            
            const menu = document.getElementById(type + 'Options');
            menu.style.display = 'block';
            
            // Fechar menu ao clicar fora
            setTimeout(() => {
                document.addEventListener('click', closeExerciseMediaMenus, { once: true });
            }, 100);
        }
        
        function closeExerciseMediaMenus() {
            document.querySelectorAll('.exercise-media-options').forEach(menu => {
                menu.style.display = 'none';
            });
        }
        
        function changeExerciseMedia(type) {
            mediaTypeToChange = type;
            document.getElementById('mediaInput').click();
            closeExerciseMediaMenus();
        }
        
        function removeExerciseMedia(type) {
            if (!currentExercise) return;
            
            const mediaData = loadExerciseMediaData();
            if (!mediaData[currentExercise]) {
                mediaData[currentExercise] = {};
            }
            
            delete mediaData[currentExercise][type];
            saveExerciseMediaData(mediaData);
            
            loadExerciseMedia(currentExercise);
            showToast(`${type === 'image' ? 'Imagem' : 'GIF'} removido.`);
            closeExerciseMediaMenus();
        }
        
        // Configurar o input de mídia
        document.getElementById('mediaInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file || !currentExercise) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const mediaData = loadExerciseMediaData();
                if (!mediaData[currentExercise]) {
                    mediaData[currentExercise] = {};
                }
                
                mediaData[currentExercise][mediaTypeToChange] = e.target.result;
                saveExerciseMediaData(mediaData);
                
                loadExerciseMedia(currentExercise);
                showToast(`${mediaTypeToChange === 'image' ? 'Imagem' : 'GIF'} atualizado.`);
                
                // Limpar o input
                document.getElementById('mediaInput').value = '';
            };
            
            reader.readAsDataURL(file);
        });

        // ===== Funções de Filtro =====
        
        // MODAL: Filtro de exercícios
        function openExerciseFilterModal() {
            // Preencher os filtros atuais
            document.querySelectorAll('#exerciseFilterModal input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = exerciseFilters.muscleGroups.includes(checkbox.value);
            });
            
            document.getElementById('exerciseSort').value = exerciseFilters.sortBy;
            
            document.getElementById('exerciseFilterModal').style.display = 'block';
        }
        
        function closeExerciseFilterModal() {
            document.getElementById('exerciseFilterModal').style.display = 'none';
        }
        
        function clearExerciseFilters() {
            exerciseFilters = {
                muscleGroups: [],
                sortBy: 'name'
            };
            
            document.querySelectorAll('#exerciseFilterModal input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            document.getElementById('exerciseSort').value = 'name';
            
            renderExercises();
            closeExerciseFilterModal();
            showToast('Filtros limpos.');
        }
        
        function applyExerciseFilters() {
            // Recolher grupos musculares selecionados
            const selectedMuscles = [];
            document.querySelectorAll('#exerciseFilterModal input[type="checkbox"]:checked').forEach(checkbox => {
                selectedMuscles.push(checkbox.value);
            });
            
            exerciseFilters.muscleGroups = selectedMuscles;
            exerciseFilters.sortBy = document.getElementById('exerciseSort').value;
            
            renderExercises();
            closeExerciseFilterModal();
            showToast('Filtros aplicados.');
        }
        
        // MODAL: Filtro de treinos
        function openWorkoutFilterModal() {
            // Preencher os filtros atuais
            document.getElementById('workoutFilterDateStart').value = workoutFilters.dateStart || '';
            document.getElementById('workoutFilterDateEnd').value = workoutFilters.dateEnd || '';
            
            // Preencher select de planos
            const planSelect = document.getElementById('workoutFilterPlan');
            const plans = loadPlansData();
            planSelect.innerHTML = '<option value="">Todos os planos</option>' + 
                plans.map(p => `<option value="${p.name}" ${workoutFilters.plan === p.name ? 'selected' : ''}>${p.name}</option>`).join('');
            
            document.getElementById('workoutFilterModal').style.display = 'block';
        }
        
        function closeWorkoutFilterModal() {
            document.getElementById('workoutFilterModal').style.display = 'none';
        }
        
        function clearWorkoutFilters() {
            workoutFilters = {
                dateStart: null,
                dateEnd: null,
                plan: null
            };
            
            document.getElementById('workoutFilterDateStart').value = '';
            document.getElementById('workoutFilterDateEnd').value = '';
            document.getElementById('workoutFilterPlan').value = '';
            
            renderWorkouts();
            closeWorkoutFilterModal();
            showToast('Filtros limpos.');
        }
        
        function applyWorkoutFilters() {
            workoutFilters.dateStart = document.getElementById('workoutFilterDateStart').value || null;
            workoutFilters.dateEnd = document.getElementById('workoutFilterDateEnd').value || null;
            workoutFilters.plan = document.getElementById('workoutFilterPlan').value || null;
            
            renderWorkouts();
            closeWorkoutFilterModal();
            showToast('Filtros aplicados.');
        }

        // ===== Funções de Navegação e Utilidade =====
        function showPage(pageId){ 
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); 
            document.getElementById(pageId).classList.add('active'); 
            currentPage=pageId; 
            
            // Atualizar navbar
            document.querySelectorAll('.nav-item').forEach(item=>item.classList.remove('active')); 
            const navMap={ 
                mainPage:0, exercisesPage:1, plansPage:2, workoutsPage:3, weightPage:4 
            }; 
            if(navMap[pageId]!==undefined){ 
                document.querySelectorAll('.nav-item')[navMap[pageId]].classList.add('active'); 
            } 
            
            // Atualizar conteúdo específico da página
            if(pageId==='mainPage'){ 
                updateResumeWorkoutCard();
            } 
            else if(pageId==='exercisesPage'){ 
                renderExercises(); 
            } 
            else if(pageId==='plansPage'){ 
                renderPlans(); 
            } 
            else if(pageId==='workoutsPage'){ 
                renderWorkouts(); 
            } 
            else if(pageId==='weightPage'){ 
                initWeight(); 
            } 
        }
        
        function updateResumeWorkoutCard() {
            const resumeCard = document.getElementById('resumeWorkoutCard');
            const resumeDetails = document.getElementById('resumeWorkoutDetails');
            
            if (ongoingWorkout && !isWorkoutSaved) {
                resumeCard.style.display = 'flex';
                resumeDetails.textContent = `${ongoingWorkout.planName} - ${ongoingWorkout.dayName} (${ongoingWorkout.completedExercises ? ongoingWorkout.completedExercises.length : 0}/${ongoingWorkout.exercises ? ongoingWorkout.exercises.length : 0} exercícios)`;
            } else {
                resumeCard.style.display = 'none';
            }
        }
        
        function showToast(message){ 
            const toast=document.getElementById('toast'); 
            toast.textContent=message; 
            toast.classList.add('show'); 
            setTimeout(()=>{ toast.classList.remove('show'); },2000); 
        }
        
        // ===== Funções de Armazenamento =====
        function loadWeightHistory(){ 
            try{ 
                return JSON.parse(localStorage.getItem(storageKeys.WEIGHT_HISTORY))||[]; 
            }catch(e){ 
                console.error("Erro ao carregar histórico de peso:",e); 
                return[]; 
            } 
        }
        
        function saveWeightHistory(hist){ 
            localStorage.setItem(storageKeys.WEIGHT_HISTORY,JSON.stringify(hist)); 
        }
        
        function loadExercisesData(){ 
            try{ 
                return JSON.parse(localStorage.getItem(storageKeys.EXERCISES))||{}; 
            }catch(e){ 
                console.error("Erro ao carregar dados de exercícios:",e); 
                return{}; 
            } 
        }
        
        function saveExercisesData(data){ 
            localStorage.setItem(storageKeys.EXERCISES,JSON.stringify(data)); 
        }
        
        function loadPlansData(){ 
            try{ 
                return JSON.parse(localStorage.getItem(storageKeys.PLANS))||[]; 
            }catch(e){ 
                console.error("Erro ao carregar dados de planos:",e); 
                return[]; 
            } 
        }
        
        function savePlansData(data){ 
            localStorage.setItem(storageKeys.PLANS,JSON.stringify(data)); 
        }
        
        function loadWorkoutsData(){ 
            try{ 
                return JSON.parse(localStorage.getItem(storageKeys.WORKOUTS))||[]; 
            }catch(e){ 
                console.error("Erro ao carregar dados de treinos:",e); 
                return[]; 
            } 
        }
        
        function saveWorkoutsData(data){ 
            localStorage.setItem(storageKeys.WORKOUTS,JSON.stringify(data)); 
        }
        
        function saveOngoingWorkout(workout) {
            localStorage.setItem(storageKeys.ONGOING_WORKOUT, JSON.stringify(workout));
            ongoingWorkout = workout;
            isWorkoutSaved = false;
            updateResumeWorkoutCard();
        }

        // ===== Inicialização =====
        function init(){ 
            // Carregar dados
            const hist=loadWeightHistory(); 
            if(hist.length>0){ 
                currentWeight=hist[hist.length-1].weight; 
                document.getElementById('currentWeightLabel').textContent=currentWeight+' kg'; 
                document.getElementById('currentWeightPageLabel').textContent=currentWeight+' kg'; 
            } 
            
            selectedPlanId=localStorage.getItem(storageKeys.SELECTED_PLAN); 
            if(selectedPlanId){ 
                const plans=loadPlansData(); 
                const plan=plans.find(p=>p.id===selectedPlanId); 
                if(plan){ 
                    document.getElementById('selectedPlanLabel').textContent=plan.name; 
                    renderSelectedPlanDays(plan); 
                } 
            } 
            
            // Carregar treino em progresso
            ongoingWorkout = JSON.parse(localStorage.getItem(storageKeys.ONGOING_WORKOUT)) || null;
            if (ongoingWorkout) {
                updateResumeWorkoutCard();
            }
            
            // Inicializar páginas
            initWeight(); 
            renderExercises(); 
            renderPlans(); 
            renderWorkouts(); 
            
            // Mostrar página inicial
            showPage('mainPage'); 
        }

        // Iniciar a aplicação quando a página carregar
        window.onload = init;

        // ===== Service Worker para PWA =====
        if('serviceWorker' in navigator){ 
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js')
            .then(function(registration) {
                console.log('Service Worker registado com sucesso:', registration.scope);
                
                // Verificar se há uma nova versão do Service Worker
                registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                console.log('Nova versão do Service Worker encontrada:', newWorker);
                
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    console.log('Nova versão pronta! Atualize a página.');
                    }
                });
                });
            })
            .catch(function(err) { 
                console.log('Service Worker falhou:', err); 
                // Não bloquear a aplicação se o Service Worker falhar
            }); 
        });
        }
    </script>
</body>
</html>
