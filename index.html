<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#111827">
    <title>Gym PWA</title>
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        :root {
            --bg: #0b1220;
            --card: #121a2b;
            --muted: rgba(255,255,255,0.6);
            --text: #fff;
            --primary: #2e7d32;
            --accent: #4f46e5;
            --danger: #dc3545;
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            background: linear-gradient(180deg, #0b1220 0%, #0d1626 100%);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container { padding: 16px 16px 96px; }
        .page { display: none; }
        .page.active { display: block; }

        .header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; position: sticky; top: 0; z-index: 10;
            background: rgba(11,18,32,0.7); backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .header h1 { margin: 0; font-size: 1.25rem; letter-spacing: 0.3px; }
        .header .actions { display: flex; gap: 8px; }
        .icon-btn { border: 0; background: #18233a; color: #cfd7ff; padding: 8px 10px; border-radius: 10px; cursor: pointer; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .card {
            background: radial-gradient(120% 120% at 100% 0%, rgba(79,70,229,0.08) 0%, rgba(255,255,255,0) 60%),
                       linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px; padding: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.25);
        }
        .card h3 { margin: 0 0 8px 0; font-size: 0.95rem; opacity: 0.8; }
        .card .big { font-size: 1.8rem; font-weight: 800; letter-spacing: 0.5px; }

        /* Pesquisas/inputs */
        .search {
            display: grid; grid-template-columns: 1fr auto auto; gap: 10px; margin: 10px 0 16px;
        }
        .input {
            width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.04); color: var(--text); outline: none;
        }
        .btn { border: 0; padding: 10px 12px; border-radius: 12px; color: #fff; cursor: pointer; font-weight: 700; }
        .btn.primary { background: var(--primary); }
        .btn.accent  { background: var(--accent); }
        .btn.ghost { background: rgba(255,255,255,0.08); }
        .btn.danger { background: var(--danger); }

        /* Listas */
        .list { display: grid; gap: 10px; }
        .list-item {
            display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 10px;
            padding: 12px; background: #111b30; border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px;
        }
        .list-item .title { font-weight: 800; }
        .list-item .subtitle { font-size: 0.9rem; opacity: 0.7; }
        .kebab { border: 0; background: rgba(255,255,255,0.08); color: #cfd7ff; padding: 6px 8px; border-radius: 10px; cursor: pointer; }

        /* Navbar */
        .navbar {
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 20;
            display: grid; grid-template-columns: repeat(5,1fr); gap: 4px; align-items: end;
            background: rgba(11,18,32,0.86); backdrop-filter: blur(10px);
            padding: 6px 10px 12px; border-top: 1px solid rgba(255,255,255,0.08);
        }
        .nav-item { text-align: center; font-size: 0.7rem; opacity: 0.8; }
        .nav-icon { font-size: 1.2rem; display: block; margin-bottom: 4px; }
        .nav-item.active { opacity: 1; color: #fff; }

        /* TOAST - Alterado para fora do ecrã inicialmente */
        .toast { 
            position: fixed; 
            left: 50%; 
            transform: translateX(-50%); 
            top: -100px; /* Inicialmente fora do ecrã */
            background: #1f2937; 
            color: #fff; 
            padding: 10px 14px; 
            border-radius: 10px;
            opacity: 0; 
            transition: all .3s ease; 
            z-index: 50;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .toast.show { 
            opacity: 1;
            top: 70px; /* Posição quando mostra */
        }

        /* MODAIS */
        .weight-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.55); z-index: 2000; overflow-y: auto; }
        .weight-modal-content { max-width: 420px; margin: 40px auto; background: #fff; color: #111; border-radius: 18px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.35); position: relative; }
        .modal-title { margin: 0 0 12px; font-size: 1.3rem; font-weight: 800; text-align: center; }
        .form-group { margin: 10px 0; }
        .form-label { font-weight: 700; font-size: 0.9rem; color: #111; margin-bottom: 6px; display: block; }
        .form-input, .form-select { width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; }
        .modal-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .modal-btn { padding: 10px 12px; border: 0; border-radius: 12px; font-weight: 800; cursor: pointer; }
        .btn-cancel { background: #f3f4f6; }
        .btn-save { background: #2e7d32; color: #fff; }
        .btn-danger { background: #fee2e2; color: #b00020; }
        .modal-exercise-select {
            width: 100%;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0,12);
            background: rgba(255, 255, 255, 0,04);
            color: black;
            outline: none;
            margin-bottom: 12px;
        }

        /* Página EXERCÍCIO - Detalhes */
        .exercise-detail-header { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; width: 100%; }
        .back-button { border: none; background: #18233a; color: #cfd7ff; padding: 8px 10px; border-radius: 10px; cursor: pointer; }
        .exercise-detail-title { margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; padding-right: 8px; /* Espaço para evitar que encoste no botão */}
        .edit-exercise-button { border: none; background: #f5f5f5; border-radius: 12px; padding: 8px 12px; font-size: 1.1rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .edit-exercise-button i { pointer-events: none; }
        .exercise-media-card { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin: 14px 0 10px; }
        .media-box { position: relative; border: 2px dashed #e0e0e0; border-radius: 16px; height: 160px; display: flex; align-items: center; justify-content: center; background: #fafafa; }
        .media-label { font-weight: 600; opacity: 0.7; }
        .media-menu { position: absolute; top: 8px; right: 8px; border: none; background: white; border-radius: 12px; padding: 6px 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.12); cursor: pointer; }

        .plan-day-exercises-list { margin-top: 8px; }
        .exercise-row { display: flex; align-items: center; justify-content: space-between; background: #fff; color:#111; border-radius: 14px; padding: 10px 12px; margin: 8px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
        .exercise-row-main { display: flex; flex-direction: column; gap: 2px; }
        .exercise-row-name { font-weight: 800; }
        .exercise-row-meta { font-size: 0.9rem; opacity: 0.7; }
        .exercise-row-options { border: none; background: #f3f3f3; border-radius: 12px; padding: 6px 8px; cursor: pointer; }
        .add-exercise-inline { width: 100%; border: none; border-radius: 14px; padding: 10px 12px; background: #f7f7f7; color:#111; margin-top: 8px; cursor: pointer; }

        .plan-detail-footer { display: grid; gap: 12px; margin-top: 12px; position: static; bottom: 92px; }
        .btn-remove-plan { flex: 1; background: #ffe7e7; color: #b00020; border: none; padding: 12px; border-radius: 14px; font-weight: 800; cursor: pointer; }
        .btn-save-plan { flex: 2; background: #2e7d32; color: white; border: none; padding: 12px; border-radius: 14px; font-weight: 800; cursor: pointer; }

        .exercise-media-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin: 14px 0 10px;
        }

        .exercise-media-box {
            position: relative;
            border: 2px dashed #e0e0e0;
            border-radius: 16px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
            overflow: hidden;
        }

        .exercise-media-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .exercise-media-label {
            font-weight: 600;
            opacity: 0.7;
            position: absolute;
            z-index: 1;
        }

        .exercise-media-menu {
            position: absolute;
            top: 8px;
            right: 8px;
            border: none;
            background: white;
            border-radius: 12px;
            padding: 6px 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            cursor: pointer;
            z-index: 2;
        }

        .exercise-media-options {
            position: absolute;
            top: 35px;
            right: 5px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }

        .exercise-media-option {
            padding: 10px 14px;
            cursor: pointer;
            color: #111;
            border-bottom: 1px solid #f0f0f0;
        }

        .exercise-media-option:last-child {
            border-bottom: none;
        }

        .exercise-media-option:hover {
            background: #f5f5f5;
        }

        /* Estilo para a lista de exercícios com miniaturas */
        .exercise-list-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #111b30;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px;
        }

        .exercise-thumbnail {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            background: #18233a;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .exercise-thumbnail i {
            font-size: 1.2rem;
            opacity: 0.7;
        }

        /* Garante que modais personalizados não aparecem no fim das páginas */
        .plan-modal { display: none; }

        #weightCard {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        #weightCard button {
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
        }
        
        /* Estilo para a lista de pesos */
        #weightList {
            margin-top: 20px;
            display: grid;
            gap: 10px;
        }
        #weightList li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--card);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            color: var(--text);
        }
        .delete-weight-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
        }

        /* estilo simples para os day-cards - MODIFICADO para usar a cor original */
        .day-card {
            padding: 14px;
            margin-bottom: 16px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
            background: var(--card);
            position: relative;
            cursor: default;
            border: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .day-card h5 { margin: 0 0 6px 0; font-weight: 700; color: var(--text); }
        .day-card small { color: var(--muted); }

        /* Quadrado do dia - NOVO */
        .day-number-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            background: var(--accent);
            border-radius: 8px;
            font-weight: bold;
        }
        .day-number-box div:first-child {
            font-size: 0.7rem;
            opacity: 0.8;
        }
        .day-number-box div:last-child {
            font-size: 1.2rem;
        }

        /* Estilo para a lista de seleção de planos */
        .plan-selection-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            color: white;
        }
        .plan-selection-item:hover {
            background: rgba(255,255,255,0.05);
        }
        .plan-selection-item:last-child {
            border-bottom: none;
        }
        .plan-selection-item .title {
            font-weight: 700;
            margin-bottom: 4px;
        }
        .plan-selection-item .subtitle {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Espaçamento na página de peso */
        #weightPage .card {
            margin-bottom: 16px;
        }

        /* Página de detalhes do dia - REDESENHADA conforme a imagem */
        .day-detail-exercise {
            background: var(--card);
            color: var(--text);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .day-detail-exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .day-detail-exercise-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin: 0;
        }
        .day-detail-exercise-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .day-detail-exercise-sets {
            font-weight: 600;
        }
        .day-detail-exercise-weight {
            font-weight: 600;
            color: var(--primary);
        }
        .start-workout-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 1.1rem;
            width: 100%;
            margin-top: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Página de treinos (histórico) - MODIFICADO conforme solicitado */
        .workout-item-compact {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            cursor: pointer;
        }
        .workout-header-compact {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .workout-title-compact {
            font-weight: 700;
            font-size: 1rem;
            margin: 0;
        }
        .workout-date-compact {
            opacity: 0.7;
            font-size: 0.85rem;
            text-align: right;
        }
        .workout-details-compact {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
        }
        .workout-day-compact {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .workout-duration-compact {
            font-size: 0.9rem;
            opacity: 0.8;
            text-align: right;
        }

        .workout-exercise {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .workout-exercise:last-child {
            border-bottom: none;
        }

        /* Modal para alterar mídia */
        .media-options {
            position: absolute;
            top: 35px;
            right: 5px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }
        .media-option {
            padding: 10px 14px;
            cursor: pointer;
            color: #111;
            border-bottom: 1px solid #f0f0f0;
        }
        .media-option:last-child {
            border-bottom: none;
        }
        .media-option:hover {
            background: #f5f5f5;
        }

        /* NOVAS PÁGINAS PARA O FLUXO DE TREINO */
        /* Página de exercícios do treino */
        .workout-exercise-item {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .workout-exercise-info {
            flex: 1;
        }
        .workout-exercise-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin: 0 0 4px 0;
        }
        .workout-exercise-details {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        .workout-exercise-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
        }
        .workout-exercise-btn:disabled {
            background: var(--muted);
            cursor: not-allowed;
        }
        .finish-workout-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 1.1rem;
            width: 100%;
            margin-top: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Página de execução do exercício - MODIFICADO conforme solicitado */
        .exercise-execution-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            position: relative;
        }
        .exercise-execution-title {
            font-weight: 700;
            font-size: 1.3rem;
            margin: 0;
        }
        .exercise-info-btn {
            border: none;
            background: var(--accent);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
        }
        .timer-btn-small {
            border: none;
            background: var(--primary);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }
        .timer-active {
            background: var(--accent);
        }
        .series-grid {
            display: grid;
            gap: 8px;
            margin-bottom: 20px;
        }
        .series-item {
            background: var(--card);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            align-items: center;
        }
        .series-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            grid-column: 1 / 3;
        }
        .series-number {
            font-weight: 700;
        }
        .series-inputs {
            display: contents;
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        .input-label {
            font-size: 0.8rem;
            margin-bottom: 4px;
            opacity: 0.7;
            text-align: center;
        }
        .series-input {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.04);
            color: var(--text);
            outline: none;
            text-align: center;
            font-size: 0.9rem;
        }
        .warmup-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .finish-exercise-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 1.1rem;
            width: 100%;
            margin-top: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .finish-exercise-btn:disabled {
            background: var(--muted);
            cursor: not-allowed;
        }

        /* Página de resumo do treino */
        .workout-summary-item {
            background: linear-gradient(135deg, rgba(79,70,229,0.15) 0%, rgba(46,125,50,0.15) 100%);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }

        .summary-title {
            font-weight: 800;
            font-size: 1.4rem;
            margin: 0;
            background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .summary-duration {
            font-size: 1rem;
            opacity: 0.9;
            background: rgba(255,255,255,0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .summary-exercise {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            transition: all 0.3s ease;
        }

        .summary-exercise:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .summary-exercise:last-child {
            margin-bottom: 0;
        }

        .summary-exercise-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--text);
        }

        .summary-exercise-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        /* Modal de detalhes do treino - MODIFICADO conforme solicitado */
        .workout-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            overflow-y: auto;
        }
        .workout-detail-content {
            max-width: 500px;
            margin: 40px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .workout-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            position: relative;
        }
        .workout-detail-title {
            font-weight: 700;
            font-size: 1.2rem;
            margin: 0;
        }
        .workout-detail-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 3001;
        }
        .workout-detail-info {
            margin-bottom: 16px;
            display: grid;
            gap: 8px;
        }
        .workout-detail-info-item {
            display: flex;
            justify-content: space-between;
        }
        .workout-detail-info-label {
            font-weight: 600;
            opacity: 0.8;
        }
        .workout-detail-info-value {
            text-align: right;
        }
        .workout-detail-exercises {
            margin-top: 16px;
        }
        .workout-detail-exercise {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .workout-detail-exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .workout-detail-exercise-name {
            font-weight: 700;
            margin-bottom: 8px;
        }
        .workout-detail-exercise-details {
            display: none;
            margin-top: 8px;
        }
        .workout-detail-exercise.expanded .workout-detail-exercise-details {
            display: block;
        }
        .workout-detail-exercise-sets {
            opacity: 0.8;
            margin-bottom: 4px;
        }
        .workout-detail-set {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }
        .workout-detail-set-header {
            font-weight: 600;
            opacity: 0.7;
        }

        /* ===== ESTILOS ADICIONADOS PARA AS CORREÇÕES ===== */
        
        /* Espaçamento na página de treinos */
        #workoutsPage .card {
            margin-bottom: 16px; /* Adiciona espaçamento entre o card e a lista */
        }
        
        /* Estilo para a lista de histórico de treinos na página de exercícios */
        .exercise-history-list {
            margin-top: 16px;
            display: grid;
            gap: 12px;
        }
        
        .exercise-history-item {
            background: linear-gradient(135deg, rgba(79,70,229,0.08) 0%, rgba(46,125,50,0.08) 100%);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255,255,255,0.08);
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        .exercise-history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .exercise-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .exercise-history-date {
            font-weight: 700;
            font-size: 1rem;
            margin: 0;
        }

        .exercise-history-avg {
            font-weight: 700;
            color: var(--primary);
            background: rgba(46,125,50,0.15);
            padding: 4px 8px;
            border-radius: 8px;
        }

        .exercise-history-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .exercise-history-detail-item {
            display: flex;
            flex-direction: column;
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
        }

        .exercise-history-detail-label {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-bottom: 4px;
        }

        .exercise-history-detail-value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .exercise-history-expand-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .exercise-history-expand-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(180deg);
        }
        
        .exercise-history-sets {
            margin-top: 12px;
            font-size: 0.85rem;
            opacity: 0.7;
            display: none;
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
        }

        .exercise-history-sets.expanded {
            display: block;
        }
        
        .exercise-history-set {
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
        }

        .exercise-history-set:last-child {
            border-bottom: none;
        }
        
        /* Botão de eliminar treino no modal */
        .delete-workout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            width: 100%;
        }

        /* NOVOS ESTILOS PARA AS CORREÇÕES SOLICITADAS */
        
        /* Modal para adicionar exercício */
        .add-exercise-modal-content {
            max-width: 420px;
            margin: 40px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
            position: relative;
        }
        
        /* Modal para editar nome do exercício */
        .edit-exercise-name-modal-content {
            max-width: 420px;
            margin: 40px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
            position: relative;
        }
        
        /* Modal para confirmar remoção de exercício */
        .confirm-delete-modal-content {
            max-width: 420px;
            margin: 40px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
            position: relative;
            text-align: center;
        }
        
        /* Botão de remover exercício na página de detalhes */
        .delete-exercise-button {
            border: none;
            background: #ffebee;
            color: #d32f2f;
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-left: 8px;
        }
        
        .exercise-detail-header-buttons {
            display: flex;
            gap: 8px;
            flex-shrink: 0; /* Impede que os botões diminuam */
        }

        /* NOVOS ESTILOS PARA A MODAL DE GESTÃO DO DIA */
        .day-management-modal-content {
            max-width: 500px;
            margin: 40px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
            position: relative;
        }
        
        .day-management-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .day-management-title {
            font-weight: 700;
            font-size: 1.2rem;
            margin: 0;
        }
        
        .day-management-exercise-list {
            margin: 16px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .day-management-exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: move;
        }
        
        .day-management-exercise-info {
            flex: 1;
        }
        
        .day-management-exercise-name {
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .day-management-exercise-details {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .day-management-exercise-remove {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
        }
        
        .day-management-footer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        /* NOVO ESTILO PARA OS DIAS NA PÁGINA DE DETALHES DO PLANO */
        .plan-day-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--card);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        
        .plan-day-info {
            flex: 1;
        }
        
        .plan-day-name {
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .plan-day-exercises-count {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .plan-day-options {
            background: rgba(255,255,255,0.08);
            color: #cfd7ff;
            border: none;
            border-radius: 8px;
            padding: 8px 10px;
            cursor: pointer;
        }

        /* Estilo para modais sobrepostas - CORREÇÃO DO PROBLEMA */
        .day-options-modal-active {
            z-index: 2001 !important;
        }
        
        /* CORREÇÃO: Aumentar z-index da modal de edição do nome do dia */
        #editDayNameModal {
            z-index: 2001 !important;
        }

        /* NOVOS ESTILOS PARA FILTROS E ORDENAÇÃO */
        .filter-modal-content {
            max-width: 420px;
            margin: 40px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .filter-options {
            display: grid;
            gap: 16px;
            margin-bottom: 20px;
        }

        .filter-option-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(255,255,255,0.05);
            padding: 16px;
            border-radius: 12px;
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        .filter-checkbox:last-child {
            border-bottom: none;
        }

        .filter-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
        }

        .filter-checkbox label {
            font-weight: 500;
        }
        
        /* Estilo para a página de gestão de dia (nova página) */
        .day-management-page-content {
            padding: 16px;
        }
        
        .day-management-page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .day-management-page-title {
            font-weight: 700;
            font-size: 1.2rem;
            margin: 0;
        }
        
        .day-management-page-exercise-list {
            margin: 16px 0;
        }
        
        .day-management-page-exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--card);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(255,255,255,0.08);
            cursor: grab;
        }
        
        .day-management-page-exercise-item:active {
            cursor: grabbing;
        }
        
        .day-management-page-exercise-info {
            flex: 1;
        }
        
        .day-management-page-exercise-name {
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .day-management-page-exercise-details {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .day-management-page-exercise-edit {
            background: rgba(255,255,255,0.08);
            color: #cfd7ff;
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            margin-right: 8px;
        }
        
        .day-management-page-exercise-remove {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
        }
        
        .day-management-page-add-exercise {
            width: 100%;
            margin-top: 16px;
        }

        /* Estilo para a página de treinos com pesquisa */
        .workouts-search {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        /* Estilo para o botão de retomar treino */
        .resume-workout-card {
            background: var(--accent);
            color: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .resume-workout-info {
            flex: 1;
        }
        
        .resume-workout-title {
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .resume-workout-details {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .resume-workout-btn {
            background: white;
            color: var(--accent);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-weight: 700;
            cursor: pointer;
        }

        /* Botão Iniciar Treino na Home */
        .start-workout-btn-home {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-left: auto;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-date {
            font-size: 0.7rem;
            opacity: 0.6;
        }

        .stat-subtext {
            font-size: 0.7rem;
            opacity: 0.6;
        }

        /* Confirmation Modal css */
        #confirmExitModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3002 !important;
        }

        #confirmExitModal .weight-modal-content {
            max-width: 400px;
            margin: 100px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        #confirmExitModal p {
            margin: 15px 0;
            text-align: center;
            line-height: 1.5;
        }

        #confirmExitModal .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        #deletePlanConfirmModal {
            z-index: 3003 !important;
        }

        #deleteExerciseConfirmModal {
            z-index: 3004 !important;
        }

        /* Add this CSS for the delete confirmation modal */
        #deleteWorkoutConfirmModal {
            z-index: 3001 !important;
        }

        #deleteWorkoutConfirmModal .weight-modal-content {
            max-width: 400px;
            background: var(--card);
            color: var(--text);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }

        #deleteWorkoutConfirmModal p {
            margin: 15px 0;
            line-height: 1.5;
        }

        #dayManagementPage .exercise-detail-header {
            grid-template-columns: auto minmax(0, 1fr) auto;
        }

        #dayManagementPage .exercise-detail-title {
            max-width: 65vw; /* Limita a largura máxima para garantir espaço para os botões */
        }

        /* Adicionar estes estilos para destacar objetivos atualizados */
        .plan-updated {
            animation: highlightUpdate 2s ease;
            border-left: 4px solid var(--primary) !important;
        }

        .plan-option:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .plan-options-menu {
            backdrop-filter: blur(10px);
        }

        @keyframes highlightUpdate {
            0% { background-color: rgba(46, 125, 50, 0.3); }
            100% { background-color: transparent; }
        }

        .updated-badge {
            background-color: var(--primary);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* NOVOS ESTILOS PARA AS MODIFICAÇÕES SOLICITADAS */
        
        /* Modal para mostrar detalhes do exercício concluído */
        .exercise-completed-modal-content {
            max-width: 500px;
            margin: 40px auto;
            background: var(--card);
            color: var(--text);
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
            position: relative;
        }
        
        .exercise-completed-details {
            margin: 16px 0;
        }
        
        .exercise-completed-set {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .exercise-completed-set:last-child {
            border-bottom: none;
        }
        
        .exercise-completed-target {
            margin: 16px 0;
            padding: 12px;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
        }
        
        .target-updated {
            background: rgba(46,125,50,0.2);
            border-left: 4px solid var(--primary);
        }
        
        .target-old {
            color: var(--muted);
            text-decoration: line-through;
            margin-right: 8px;
        }
        
        .target-new {
            color: var(--primary);
            font-weight: 700;
        }
        
        /* Estilo para exercícios concluídos na workoutPage */
        .workout-exercise-completed {
            background: rgba(46,125,50,0.1);
            border-left: 4px solid var(--primary);
        }
        
        .workout-exercise-options-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text);
            border-radius: 8px;
            padding: 8px 10px;
            cursor: pointer;
        }
        
        /* Modal de confirmação para terminar exercício com séries em falta */
        #confirmFinishExerciseModal .weight-modal-content,
        #confirmFinishWorkoutModal .weight-modal-content {
            max-width: 400px;
            background: var(--card);
            color: var(--text);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }
        
        #confirmFinishExerciseModal p,
        #confirmFinishWorkoutModal p {
            margin: 15px 0;
            line-height: 1.5;
        }
        
        .missing-exercises-list {
            text-align: left;
            margin: 16px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .missing-exercise-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .missing-exercise-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 500px) {
             .series-inputs {
                grid-template-columns: 1fr 1fr !important;
                gap: 4px;
            }
            
            .series-item {
                padding: 8px;
                grid-template-columns: 1fr;
            }
            
            .input-group {
                margin-bottom: 0;
            }
            
            .input-label {
                font-size: 0.7rem;
            }
            
            .series-input {
                padding: 6px 4px;
                font-size: 0.8rem;
            }
            
            /* Garantir que o cabeçalho da série ocupe a largura total */
            .series-header {
                grid-column: 1 / 3;
                margin-bottom: 6px;
            }
            
            .header .actions {
                display: none;
            }
        }
        /* Adicionar estas regras CSS para corrigir o layout em ecrãs pequenos */
        @media (max-width: 430px) {
            .series-item {
                padding: 6px;
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .series-inputs {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 4px;
                width: 100%;
            }
            
            .input-group {
                margin-bottom: 0;
                min-width: 0; /* Permite que os inputs se ajustem melhor */
            }
            
            .input-label {
                font-size: 0.65rem;
                margin-bottom: 2px;
            }
            
            .series-input {
                padding: 4px 4px;
                font-size: 0.75rem;
                width: 100%;
                box-sizing: border-box;
            }
            
            /* Garantir que o cabeçalho da série ocupe a largura total */
            .series-header {
                grid-column: 1 / 3;
                margin-bottom: 4px;
                font-size: 0.75rem;
            }
            
            /* Ajustar o padding geral do card para economizar espaço */
            .card {
                padding: 10px;
            }
        }

        @media (max-width: 360px) {
            #dayManagementPage .exercise-detail-title {
                max-width: 55vw;
            }
            
            .exercise-detail-header-buttons {
                gap: 4px;
            }
            
            .edit-exercise-button, 
            .delete-exercise-button {
                padding: 6px 8px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>GYM</h1>
        <div class="actions">
            <!-- Removido conforme solicitado -->
        </div>
    </div>

    <div class="container">
        <!-- HOME - Adicionado card de retomar treino -->
        <div id="mainPage" class="page active">
            <div id="resumeWorkoutCard" class="resume-workout-card" style="display: none;" onclick="resumeWorkout()">
                <div class="resume-workout-info">
                    <div class="resume-workout-title">Treino em Progresso</div>
                    <div class="resume-workout-details" id="resumeWorkoutDetails">Clique para retomar</div>
                </div>
                <button class="resume-workout-btn">Retomar</button>
            </div>

            <div class="stats-grid">
                <div class="card">
                    <h3>Peso Atual</h3>
                    <div class="big" id="currentWeightLabel">0 kg</div>
                    <div class="big">
                        <button class="btn ghost" onclick="openWeightModal()"><i class="bi bi-plus-circle"></i> Adicionar Peso</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Plano Selecionado</h3>
                    <div class="big" id="selectedPlanLabel">—</div>
                    <div class="big">
                        <button class="btn accent" onclick="openPlanSelection()"><i class="bi bi-list-check"></i> Escolher Plano</button>
                    </div>
                </div>
            </div>

            <div id="selectedPlanDays" style="margin-top:16px;"></div>

        </div>

        <!-- EXERCÍCIOS - Adicionado botão de filtro -->
        <div id="exercisesPage" class="page">
            <div class="search">
                <input id="exerciseSearch" class="input" placeholder="Procurar exercício..." oninput="renderExercises()" />
                <button class="btn accent" onclick="openAddExerciseModal()"><i class="bi bi-plus-circle"></i></button>
                <button class="btn ghost" onclick="openExerciseFilterModal()"><i class="bi bi-funnel"></i></button>
            </div>
            <div id="exercisesList" class="list">
                <!-- Mensagem será mostrada aqui via JavaScript -->
            </div>
        </div>

        <!-- DETALHES DO EXERCÍCIO -->
        <div id="exerciseDetailPage" class="page">
            <div class="exercise-detail-header">
                <button class="back-button" onclick="closeExerciseDetail()"><i class="bi bi-arrow-left"></i></button>
                <h1 class="exercise-detail-title" id="exerciseDetailTitle">Nome do Exercício</h1>
                <div class="exercise-detail-header-buttons">
                    <button class="edit-exercise-button" onclick="openEditExerciseNameModal()"><i class="bi bi-pencil"></i></button>
                    <button class="delete-exercise-button" onclick="openDeleteExerciseModal()"><i class="bi bi-trash"></i></button>
                </div>
            </div>

            <div class="exercise-media-container">
                <div class="exercise-media-box" id="exerciseImageBox">
                    <span class="exercise-media-label">Imagem</span>
                    <button class="exercise-media-menu" onclick="openExerciseMediaMenu('image', event)">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <div class="exercise-media-options" id="imageOptions">
                        <div class="exercise-media-option" onclick="changeExerciseMedia('image')">Alterar Imagem</div>
                        <div class="exercise-media-option" onclick="removeExerciseMedia('image')">Remover Imagem</div>
                    </div>
                </div>
                <div class="exercise-media-box" id="exerciseGifBox">
                    <span class="exercise-media-label">GIF</span>
                    <button class="exercise-media-menu" onclick="openExerciseMediaMenu('gif', event)">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <div class="exercise-media-options" id="gifOptions">
                        <div class="exercise-media-option" onclick="changeExerciseMedia('gif')">Alterar GIF</div>
                        <div class="exercise-media-option" onclick="removeExerciseMedia('gif')">Remover GIF</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Notas</h3>
                <textarea id="exerciseNotes" class="input" rows="4" placeholder="Notas sobre execução, dicas, etc."></textarea>
                <div style="text-align:right; margin-top:8px;"><button class="btn primary" onclick="saveExerciseNotes()">Guardar Notas</button></div>
            </div>

            <div class="card" style="margin-bottom: 14px; margin-top: 14px;">
                <h3>Estatísticas do Exercício</h3>
                <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                    <div class="stat-item">
                        <div class="stat-label">Peso Máximo</div>
                        <div class="stat-value" id="statMaxWeight">0 kg</div>
                        <div class="stat-date" id="statMaxWeightDate">—</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total de Sessões</div>
                        <div class="stat-value" id="statTotalSessions">0</div>
                        <div class="stat-subtext">vezes realizado</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Média de Peso</div>
                        <div class="stat-value" id="statAvgWeight">0 kg</div>
                        <div class="stat-subtext">por repetição</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Volume Total</div>
                        <div class="stat-value" id="statTotalVolume">0 kg</div>
                        <div class="stat-subtext">carga acumulada</div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:14px;">
                <h3>Histórico</h3>
                <canvas id="exerciseChart" height="180"></canvas>
            </div>
            
            <!-- Lista de histórico de treinos adicionada -->
            <div class="card" style="margin-top:14px;">
                <h3>Detalhes dos Treinos</h3>
                <div id="exerciseHistoryList" class="exercise-history-list"></div>
            </div>
        </div>

        <!-- PLANOS -->
        <div id="plansPage" class="page">
            <div style="display:flex; justify-content:end; margin-bottom: 10px;">
                <button class="btn primary" onclick="openPlanModal()"><i class="bi bi-plus-circle"></i> Adicionar Plano de Treino</button>
            </div>
            <div id="plansList" class="list"></div>
        </div>

        <!-- DETALHE DO PLANO -->
        <div id="planDetailPage" class="page">
            <div class="exercise-detail-header" style="margin-bottom:8px;">
                <button class="back-button" onclick="closePlanDetail()"><i class="bi bi-arrow-left"></i></button>
                <h1 class="exercise-detail-title" id="planDetailTitle">Plano</h1>
                <button class="edit-exercise-button" onclick="openEditPlanNameModal()"><i class="bi bi-pencil"></i></button>
            </div>

            <div class="card" style="margin-bottom:10px;">
                <div style="display:flex; gap:8px;">
                    <button class="btn accent" onclick="openAddDayModal()"><i class="bi bi-plus-circle"></i> Adicionar Dia</button>
                </div>
            </div>

            <div id="planDaysDetail" class="list"></div>
            <div class="plan-detail-footer">
                <button class="btn-remove-plan" onclick="removePlan()">Remover</button>
                <button class="btn-save-plan" onclick="savePlanChanges()">Guardar</button>
            </div>
        </div>

        <!-- NOVA PÁGINA: Gestão do Dia -->
        <div id="dayManagementPage" class="page">
            <div class="exercise-detail-header" style="margin-bottom:16px;">
                <button class="back-button" onclick="closeDayManagementPage()"><i class="bi bi-arrow-left"></i></button>
                <h1 class="exercise-detail-title" id="dayManagementPageTitle">Gestão do Dia</h1>
                <button class="edit-exercise-button" onclick="openEditDayNameModalFromPage()"><i class="bi bi-pencil"></i></button>
            </div>

            <div class="day-management-page-content">
                <button class="btn accent day-management-page-add-exercise" onclick="openAddExerciseToDayModalFromPage()"><i class="bi bi-plus-circle"></i> Adicionar Exercício</button>
                
                <div id="dayManagementPageExerciseList" class="day-management-page-exercise-list"></div>
            </div>
        </div>

        <!-- DETALHES DO DIA - REDESENHADO conforme a imagem -->
        <div id="dayDetailPage" class="page">
            <div class="exercise-detail-header" style="margin-bottom:16px;">
                <button class="back-button" onclick="closeDayDetail()"><i class="bi bi-arrow-left"></i></button>
                <h1 class="exercise-detail-title" id="dayDetailTitle">Dia do Treino</h1>
            </div>

            <div id="dayExercisesList"></div>

            <button class="start-workout-btn" onclick="startWorkout()">Iniciar Treino</button>
        </div>

        <!-- Weight Page -->
        <div id="weightPage" class="page">
            <div class="card" id="weightCard">
                <div>
                    <h3>Peso Atual:</h3>
                    <div class="big" id="currentWeightPageLabel">0 kg</div>
                </div>
                <button class="btn ghost" onclick="openWeightModal()"><i class="bi bi-plus-circle"></i> Adicionar Peso</button>
            </div>
            <div class="card">
                <canvas id="weightChart" height="200"></canvas>
            </div>
            <ul id="weightList" class="weight-list"></ul>
        </div>

        <!-- Página de Treinos (Histórico) - MODIFICADA com barra de pesquisa -->
        <div id="workoutsPage" class="page">
            <div class="workouts-search">
                <input id="workoutSearch" class="input" placeholder="Procurar treino..." oninput="renderWorkouts()" />
                <button class="btn ghost" onclick="openWorkoutFilterModal()"><i class="bi bi-funnel"></i></button>
            </div>

            <div id="workoutsCard" class="card">
                <h3>Histórico de Treinos</h3>
                <p>Aqui podes ver todos os teus treinos realizados.</p>
            </div>

            <div id="workoutsList" class="list"></div>
        </div>

        <!-- NOVAS PÁGINAS PARA O FLUXO DE TREINO -->
        <!-- Página de exercícios do treino -->
        <div id="workoutPage" class="page">
            <div class="exercise-detail-header" style="margin-bottom:16px;">
                <button class="back-button" onclick="closeWorkoutPage()"><i class="bi bi-arrow-left"></i></button>
                <h1 class="exercise-detail-title" id="workoutTitle">Treino</h1>
            </div>

            <div id="workoutExercisesList"></div>

            <button id="finishWorkoutBtn" class="finish-workout-btn" onclick="finishWorkout()">Terminar Treino</button>
        </div>

        <!-- Página de execução do exercício - MODIFICADA conforme solicitado -->
        <div id="exerciseWorkoutPage" class="page">
            <div class="exercise-execution-header">
                <button class="back-button" onclick="closeExerciseWorkout()"><i class="bi bi-arrow-left"></i></button>
                <h1 class="exercise-execution-title" id="exerciseWorkoutTitle">Exercício</h1>
                <div>
                    <button class="timer-btn-small" id="timerBtnSmall" onclick="startTimer()"><i class="bi bi-stopwatch"></i></button>
                    <button class="exercise-info-btn" onclick="showExerciseInfo()"><i class="bi bi-info-circle"></i></button>
                </div>
            </div>

            <div class="card">
                <h3 id="exerciseWorkoutTarget"></h3>
                
                <div class="warmup-checkbox">
                    <input type="checkbox" id="warmupCheckbox" onchange="toggleWarmupSet()">
                    <label for="warmupCheckbox">Adicionar série de aquecimento</label>
                </div>
                
                <div id="seriesGrid" class="series-grid"></div>
            </div>

            <button id="finishExerciseBtn" class="finish-exercise-btn" onclick="finishExercise()">Terminar Exercício</button>
        </div>

        <!-- Página de resumo do treino -->
        <div id="workoutSummaryPage" class="page">
            <div class="exercise-detail-header" style="margin-bottom:16px;">
                <button class="back-button" onclick="closeWorkoutSummary()"><i class="bi bi-arrow-left"></i></button>
                <h1 class="exercise-detail-title">Resumo do Treino</h1>
            </div>

            <div class="workout-summary-item">
                <div class="summary-header">
                    <h2 class="summary-title" id="summaryPlanName"></h2>
                    <div class="summary-duration" id="summaryDuration"></div>
                </div>
                <div id="summaryExercisesList"></div>
            </div>

            <button class="start-workout-btn" onclick="closeWorkoutSummary()">Voltar ao Início</button>
        </div>

        <!-- MODAL PESO -->
        <div id="weightModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Adicionar Peso</h2>
                <div class="form-group"><label class="form-label">Peso (kg)</label><input id="weightInput" type="number" step="0.1" class="form-input"></div>
                <div class="form-group"><label class="form-label">Data</label><input id="weightDate" type="date" class="form-input"></div>
                <div classmodal-buttons><button class="modal-btn btn-cancel" onclick="closeWeightModal()">Cancelar</button><button class="modal-btn btn-save" onclick="saveWeight()">Guardar</button></div>
            </div>
        </div>

        <!-- MODAL ADICIONAR EXERCICIO AO DIA -->
        <div id="addExerciseToDayModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Adicionar Exercício</h2>
                <div class="form-group">
                    <label class="form-label">Exercício</label>
                    <select id="exerciseSelect" class="modal-exercise-select">
                        <option value="">Selecione um exercício</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Séries</label>
                    <input type="number" id="exerciseSets" class="form-input" min="1" placeholder="Ex: 3">
                </div>
                <div class="form-group">
                    <label class="form-label">Repetições</label>
                    <input type="number" id="exerciseReps" class="form-input" min="1" placeholder="Ex: 10">
                </div>
                <div class="form-group">
                    <label class="form-label">Peso (kg)</label>
                    <input type="number" id="exerciseWeight" class="form-input" step="0.5" min="0" placeholder="Opcional">
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeAddExerciseToDayModal()">Cancelar</button>
                    <button class="modal-btn btn-save" onclick="saveExerciseToDay()">Salvar</button>
                </div>
            </div>
        </div>

        <!-- MODAL SELEÇÃO DE PLANO -->
        <div id="planSelectionModal" class="weight-modal">
            <div class="weight-modal-content" style="color: white; background: var(--card);">
                <h2 class="modal-title">Escolher Plano</h2>
                <div id="planSelectionList" class="list"></div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closePlanSelection()">Cancelar</button>
                </div>
            </div>
        </div>
        
        <!-- MODAL FILTRO DE EXERCÍCIOS -->
        <div id="exerciseFilterModal" class="weight-modal">
            <div class="filter-modal-content">
                <h2 class="modal-title">Filtrar e Ordenar Exercícios</h2>
                
                <div class="filter-options">
                    <div class="filter-option-group">
                        <label class="form-label" style="color: white;">Filtrar por Grupo Muscular</label>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterChest" value="Peito">
                            <label for="filterChest">Peito</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterBack" value="Costas">
                            <label for="filterBack">Costas</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterLegs" value="Pernas">
                            <label for="filterLegs">Pernas</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterShoulders" value="Ombros">
                            <label for="filterShoulders">Ombros</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterArms" value="Braços">
                            <label for="filterArms">Braços</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterOther" value="Outro">
                            <label for="filterOther">Outro</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" style="color: white;">Ordenar por</label>
                        <select class="form-select" id="exerciseSort">
                            <option value="name">Nome (A-Z)</option>
                            <option value="nameDesc">Nome (Z-A)</option>
                            <option value="mostPerformed">Mais Realizados</option>
                            <option value="leastPerformed">Menos Realizados</option>
                            <option value="recent">Mais Recentes</option>
                        </select>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeExerciseFilterModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="clearExerciseFilters()">Limpar</button>
                    <button class="modal-btn btn-save" onclick="applyExerciseFilters()">Aplicar</button>
                </div>
            </div>
        </div>

        <!-- MODAL FILTRO DE TREINOS -->
        <div id="workoutFilterModal" class="weight-modal">
            <div class="filter-modal-content">
                <h2 class="modal-title">Filtrar Treinos</h2>
                
                <div class="filter-options">
                    <div class="form-group">
                        <label class="form-label" style="color: white;"> Data Inicial</label>
                        <input type="date" id="workoutFilterDateStart" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" style="color: white;"> Data Final</label>
                        <input type="date" id="workoutFilterDateEnd" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" style="color: white;"> Plano de Treino</label>
                        <select class="form-select" id="workoutFilterPlan">
                            <option value="">Todos os planos</option>
                        </select>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeWorkoutFilterModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="clearWorkoutFilters()">Limpar</button>
                    <button class="modal-btn btn-save" onclick="applyWorkoutFilters()">Aplicar</button>
                </div>
            </div>
        </div>

        <!-- MODAL CRIAR PLANO -->
        <div id="planModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title" id="modalPlanTitle">Criar Plano de Treino</h2>
                <div class="form-group"><label class="form-label">Nome do Plano</label><input id="planNameInput" class="form-input" placeholder="Ex: Push/Pull/Legs"></div>
                <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closePlanModal()">Cancelar</button><button class="modal-btn btn-save" onclick="savePlan()">Salvar Plano</button></div>
            </div>
        </div>

        <!-- MODAL ADICIONAR DIA -->
        <div id="addDayModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Adicionar Dia</h2>
                <div class="form-group"><label class="form-label">Nome do Dia</label><input id="dayNameInput" class="form-input" placeholder="Ex: Segunda-feira - Peito"></div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeAddDayModal()">Cancelar</button>
                    <button class="modal-btn btn-save" onclick="saveDay()">Salvar</button></div>
            </div>
        </div>

        <!-- MODAL EDITAR NOME DO PLANO -->
        <div id="editPlanNameModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Editar Nome do Plano</h2>
                <div class="form-group"><label class="form-label">Nome do Plano</label><input type="text" class="form-input" id="editPlanNameInput" placeholder="Ex: Plano de Força"></div>
                <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closeEditPlanNameModal()">Cancelar</button><button class="modal-btn btn-save" onclick="savePlanName()">Salvar</button></div>
            </div>
        </div>

        <!-- MODAL: Opções do Dia (renomear/apagar) - MODIFICADA para ter apenas remoção -->
        <div id="dayOptionsModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Remover Dia</h2>
                <p>Tem a certeza que deseja remover o dia <span id="dayNameToDelete"></span>?</p>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeDayOptionsModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="removeDay()">Remover Dia</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Editar Exercício do Dia - MODIFICADO (removido campo de nome) -->
        <div id="editExerciseModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Editar Exercício</h2>
                <div class="form-group">
                    <label class="form-label">Exercício</label>
                    <div class="form-input" style="background: #f3f4f6; padding: 10px 12px; border-radius: 10px; border: 1px solid #e5e7eb;" id="editExerciseNameStatic">Nome do Exercício</div>
                </div>
                <div class="form-group"><label class="form-label">Séries</label><input type="number" class="form-input" id="editExerciseSets" min="1"></div>
                <div class="form-group"><label class="form-label">Repetições</label><input type="number" class="form-input" id="editExerciseReps" min="1"></div>
                <div class="form-group"><label class="form-label">Peso (kg)</label><input type="number" class="form-input" id="editExerciseWeight" step="0.5" min="0"></div>
                <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closeEditExerciseModal()">Cancelar</button><button class="modal-btn btn-danger" onclick="removeExerciseFromDay()">Remover Exercício</button><button class="modal-btn btn-save" onclick="saveEditedExercise()">Guardar</button></div>
            </div>
        </div>

        <!-- MODAL: Informações do Exercício -->
        <div id="exerciseInfoModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title" id="exerciseInfoTitle">Informações do Exercício</h2>
                <div id="exerciseInfoContent" style="max-height: 300px; overflow-y: auto;"></div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeExerciseInfo()">Fechar</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Detalhes do Treino - MODIFICADO conforme solicitado -->
        <div id="workoutDetailModal" class="workout-detail-modal">
            <div class="workout-detail-content">
                <div class="workout-detail-header">
                    <h2 class="workout-detail-title">Detalhes do Treino</h2>
                    <button class="workout-detail-close" onclick="closeWorkoutDetailModal()">&times;</button>
                </div>
                <div id="workoutDetailInfo" class="workout-detail-info"></div>
                <div id="workoutDetailExercises" class="workout-detail-exercises"></div>
                <!-- Botão para eliminar treino no modal -->
                <button class="delete-workout-btn" onclick="deleteWorkout()">Eliminar Treino</button>
            </div>
        </div>

        <!-- MODAL: Alterar Mídia -->
        <input type="file" id="mediaInput" accept="image/*" style="display: none;">

        <!-- NOVOS MODAIS ADICIONADOS PARA AS CORREÇÕES -->
        
        <!-- MODAL: Adicionar Exercício (substitui o prompt) -->
        <div id="addExerciseModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Adicionar Exercício</h2>
                <div class="form-group">
                    <label class="form-label">Nome do Exercício</label>
                    <input type="text" class="form-input" id="newExerciseName" placeholder="Ex: Supino Reto">
                </div>
                <div class="form-group">
                    <label class="form-label">Grupo Muscular</label>
                    <select class="form-select" id="newExerciseMuscle">
                        <option value="Peito">Peito</option>
                        <option value="Costas">Costas</option>
                        <option value="Pernas">Pernas</option>
                        <option value="Ombros">Ombros</option>
                        <option value="Bicep">Bicep</option>
                        <option value="Tricep">Tricep</option>
                        <option value="Antebraço">Antebraço</option>
                        <option value="Lombar">Lombar</option>
                        <option value="Trapézio">Trapézio</option>
                        <option value="Gémeos">Gémeos</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeAddExerciseModal()">Cancelar</button>
                    <button class="modal-btn btn-save" onclick="saveNewExercise()">Salvar</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Editar Nome do Exercício (substitui o prompt) -->
        <div id="editExerciseNameModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Editar Nome do Exercício</h2>
                <div class="form-group">
                    <label class="form-label">Nome do Exercício</label>
                    <input type="text" class="form-input" id="editExerciseName" placeholder="Ex: Supino Reto">
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeEditExerciseNameModal()">Cancelar</button>
                    <button class="modal-btn btn-save" onclick="saveExerciseName()">Salvar</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Confirmar Remoção de Exercício -->
        <div id="deleteExerciseModal" class="weight-modal">
            <div class="confirm-delete-modal-content">
                <h2 class="modal-title">Remover Exercício</h2>
                <p>Tem a certeza que deseja remover o exercício <span id="exerciseNameToDelete"></span>?</p>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeDeleteExerciseModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="deleteExercise()">Remover</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Confirmar Remoção de Plano -->
        <div id="deletePlanConfirmModal" class="weight-modal">
            <div class="weight-modal-content" style="background: var(--card); color: var(--text);">
                <h2 class="modal-title">Remover Plano</h2>
                <p style="margin: 15px 0; text-align: center;">Tem a certeza que deseja remover permanentemente este plano de treino?</p>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeDeletePlanConfirmModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="confirmRemovePlan()">Remover</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Confirmar Remoção de Exercicio do Plano -->
        <div id="deleteExerciseConfirmModal" class="weight-modal">
            <div class="weight-modal-content" style="background: var(--card); color: var(--text);">
                <h2 class="modal-title">Remover Exercício</h2>
                <p style="margin: 15px 0; text-align: center;">Tem a certeza que deseja remover este exercício do dia?</p>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeDeleteExerciseConfirmModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="confirmRemoveExerciseFromDay()">Remover</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Confirmarçao de eliminaçao do treino -->
        <div id="deleteWorkoutConfirmModal" class="weight-modal">
            <div class="weight-modal-content" style="background: var(--card); color: var(--text);">
                <h2 class="modal-title">Eliminar Treino</h2>
                <p style="margin: 15px 0; text-align: center;">Tem a certeza que deseja eliminar permanentemente este treino?</p>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeDeleteWorkoutConfirmModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="confirmDeleteWorkout()">Eliminar</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Gestão do Dia (NOVA) -->
        <div id="dayManagementModal" class="weight-modal">
            <div class="day-management-modal-content">
                <div class="day-management-header">
                    <h2 class="day-management-title" id="dayManagementTitle">Gestão do Dia</h2>
                    <button class="edit-exercise-button" onclick="openEditDayNameModal()"><i class="bi bi-pencil"></i></button>
                </div>
                
                <div id="dayManagementExerciseList" class="day-management-exercise-list"></div>
                
                <button class="btn accent" style="width:100%; margin-bottom:16px;" onclick="openAddExerciseToDayModalFromManagement()">Adicionar Exercício</button>
                
                <div class="day-management-footer">
                    <button class="modal-btn btn-danger" onclick="openDayOptionsModal()">Remover Dia</button>
                    <button class="modal-btn btn-save" onclick="saveDayManagement()">Guardar</button>
                </div>
            </div>
        </div>

        <!-- NOVA MODAL: Editar Nome do Dia (semelhante à de editar nome do plano) - MOVIDA PARA DEPOIS DA MODAL DE GESTÃO DO DIA -->
        <div id="editDayNameModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Editar Nome do Dia</h2>
                <div class="form-group"><label class="form-label">Nome do Dia</label><input type="text" class="form-input" id="editDayNameInput" placeholder="Ex: Segunda - Peito"></div>
                <div class="modal-buttons"><button class="modal-btn btn-cancel" onclick="closeEditDayNameModal()">Cancelar</button><button class="modal-btn btn-save" onclick="saveDayName()">Salvar</button></div>
            </div>
        </div>

        <!-- MODAL DE CONFIRMAÇÃO PERSONALIZADO -->
        <div id="confirmExitModal" class="weight-modal">
            <div class="weight-modal-content">
                <h2 class="modal-title">Sair do Treino</h2>
                <p>Tem a certeza que deseja sair do treino? Todo o progresso não guardado será perdido.</p>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeConfirmExitModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="confirmExitWorkout()">Sair do Treino</button>
                </div>
            </div>
        </div>

        <!-- NOVOS MODAIS PARA AS MODIFICAÇÕES SOLICITADAS -->
        
        <!-- MODAL: Detalhes do Exercício Concluído -->
        <div id="exerciseCompletedModal" class="weight-modal">
            <div class="exercise-completed-modal-content">
                <h2 class="modal-title" id="completedExerciseTitle">Exercício Concluído</h2>
                <div id="completedExerciseContent">
                    <!-- Conteúdo será preenchido via JavaScript -->
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-save" onclick="closeExerciseCompletedModal()">Fechar</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Confirmar Terminar Exercício com Séries em Falta -->
        <div id="confirmFinishExerciseModal" class="weight-modal">
            <div class="weight-modal-content" style="background: var(--card); color: var(--text);">
                <h2 class="modal-title">Terminar Exercício</h2>
                <p>Existem séries não preenchidas. Deseja terminar mesmo assim?</p>
                <p style="font-size: 0.9rem; opacity: 0.8;">As séries em falta serão preenchidas com "0".</p>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeConfirmFinishExerciseModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="confirmFinishExercise()">Terminar Exercício</button>
                </div>
            </div>
        </div>

        <!-- MODAL: Confirmar Terminar Treino com Exercícios em Falta -->
        <div id="confirmFinishWorkoutModal" class="weight-modal">
            <div class="weight-modal-content" style="background: var(--card); color: var(--text);">
                <h2 class="modal-title">Terminar Treino</h2>
                <p>Existem exercícios não terminados. Deseja terminar mesmo assim?</p>
                <p style="font-size: 0.9rem; opacity: 0.8;">Os exercícios em falta serão preenchidos com "0".</p>
                <div id="missingExercisesList" class="missing-exercises-list">
                    <!-- Lista de exercícios em falta será preenchida via JavaScript -->
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn btn-cancel" onclick="closeConfirmFinishWorkoutModal()">Cancelar</button>
                    <button class="modal-btn btn-danger" onclick="confirmFinishWorkout()">Terminar Treino</button>
                </div>
            </div>
        </div>

        <div id="toast" class="toast">Guardado!</div>
    </div>

    <!-- Navbar Fixa -->
    <div class="navbar">
        <div class="nav-item active" onclick="showPage('mainPage')"><i class="bi bi-house-fill nav-icon"></i><div>HOME</div></div>
        <div class="nav-item" onclick="showPage('exercisesPage')"><i class="bi bi-activity nav-icon"></i><div>EXERCICIOS</div></div>
        <div class="nav-item" onclick="showPage('plansPage')"><i class="bi bi-calendar-week nav-icon"></i><div>PLANOS</div></div>
        <div class="nav-item" onclick="showPage('workoutsPage')"><i class="bi bi-clock-history nav-icon"></i><div>TREINOS</div></div>
        <div class="nav-item" onclick="showPage('weightPage')"><i class="bi bi-speedometer2 nav-icon"></i><div>PESO</div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script>
        // ===== Variáveis globais =====
        let currentWeight = 80;
        let selectedPlanId = null;
        let currentPage = 'mainPage';
        let weights = JSON.parse(localStorage.getItem("weights")) || [];
        let weightChart;
        let exerciseChart = null;
        let currentExercise = null;
        let currentPlanDetail = null;
        let currentDayForExercise = null;
        let currentDayDetail = null;
        let mediaTypeToChange = null;
        let exerciseToRemoveIndex = null;

        // Variáveis para controlar o treino atual
        let currentWorkout = null;
        let currentExerciseIndex = 0;
        let timerInterval = null;
        let timerSeconds = 120; // 2 minutos
        let workoutStartTime = null;

        // Variável para guardar o treino atualmente selecionado para detalhes
        let currentWorkoutDetail = null;

        // Variável para controlar o dia sendo gerenciado
        let currentDayManagementIndex = null;

        // Variáveis para filtros
        let exerciseFilters = {
            muscleGroups: [],
            sortBy: 'name'
        };
        
        let workoutFilters = {
            dateStart: null,
            dateEnd: null,
            plan: null
        };

        // Variável para controlar o treino em progresso
        let ongoingWorkout = JSON.parse(localStorage.getItem('fitnessOngoingWorkout')) || null;

        // Variável para controlar se o treino já foi guardado
        let isWorkoutSaved = false;

        const storageKeys = { 
            WEIGHT: 'fitnessWeight', 
            SELECTED_PLAN: 'fitnessSelectedPlan', 
            WEIGHT_HISTORY: 'fitnessWeightHistory', 
            EXERCISES: 'fitnessExercises', 
            PLANS: 'fitnessPlans',
            WORKOUTS: 'fitnessWorkouts',
            EXERCISE_MEDIA: 'fitnessExerciseMedia',
            AVAILABLE_EXERCISES: 'fitnessAvailableExercises',
            ONGOING_WORKOUT: 'fitnessOngoingWorkout'
        };

        // Exercícios disponíveis (agora carregados do localStorage)
        let availableExercises = loadAvailableExercises();

        // ===== Novas funções para gerir exercícios disponíveis =====
        function loadAvailableExercises() {
            try {
                return JSON.parse(localStorage.getItem(storageKeys.AVAILABLE_EXERCISES)) || [];
            } catch (e) {
                console.error("Erro ao carregar exercícios disponíveis:", e);
                return [];
            }
        }

        function saveAvailableExercises(exercises) {
            localStorage.setItem(storageKeys.AVAILABLE_EXERCISES, JSON.stringify(exercises));
        }

        // ===== Funções para a Página de Peso =====
        function renderWeightList() {
            const list = document.getElementById('weightList');
            const hist = loadWeightHistory();
            
            list.innerHTML = '';
            
            if (hist.length === 0) {
                list.innerHTML = '<li>Nenhum registro de peso ainda</li>';
                return;
            }
            
            hist.slice().reverse().forEach((entry, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${entry.date}</span>
                    <span>${entry.weight} kg</span>
                    <button class="delete-weight-btn" onclick="removeWeight(${hist.length - 1 - index})"><i class="bi bi-x"></i></button>
                `;
                list.appendChild(li);
            });
        }

        function removeWeight(index) {
            const hist = loadWeightHistory();
            if (index >= 0 && index < hist.length) {
                hist.splice(index, 1);
                saveWeightHistory(hist);
                initWeight();
                showToast('Peso removido!');
            }
        }

        function initWeight() {
            const hist = loadWeightHistory();
            if (hist.length > 0) {
                currentWeight = hist[hist.length - 1].weight;
                document.getElementById('currentWeightLabel').textContent = currentWeight + ' kg';
                document.getElementById('currentWeightPageLabel').textContent = currentWeight + ' kg';
            } else {
                currentWeight = 80;
                document.getElementById('currentWeightLabel').textContent = '0 kg';
                document.getElementById('currentWeightPageLabel').textContent = '0 kg';
            }
            
            const ctx = document.getElementById('weightChart');
            if (weightChart) weightChart.destroy();
            
            if (hist.length > 0) {
                weightChart = new Chart(ctx, {
                    type: 'line', 
                    data: { 
                        labels: hist.map(h => h.date), 
                        datasets: [{ 
                            label: 'Peso (kg)', 
                            data: hist.map(h => h.weight),
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            } else {
                // Gráfico vazio
                weightChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Peso (kg)',
                            data: [],
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            }
            
            renderWeightList();
        }
        
        function openWeightModal(){ 
            document.getElementById('weightModal').style.display='block'; 
            document.getElementById('weightDate').value = new Date().toISOString().slice(0,10);
        }
        
        function closeWeightModal(){ document.getElementById('weightModal').style.display='none'; }
        
        function saveWeight(){ 
            const v = parseFloat(document.getElementById('weightInput').value); 
            const d = document.getElementById('weightDate').value || new Date().toISOString().slice(0,10);
            
            if (!v) {
                alert('Insira um peso.');
                return;
            } 
            
            currentWeight = v;
            document.getElementById('currentWeightLabel').textContent = v + ' kg';
            document.getElementById('currentWeightPageLabel').textContent = v + ' kg';
            
            const hist = loadWeightHistory();
            hist.push({ date: d, weight: v });
            saveWeightHistory(hist);
            
            initWeight();
            closeWeightModal();
            showToast('Peso guardado!');
        }

        // ===== Funções para a Página de Exercícios =====
        function getExercisesData(){ return loadExercisesData(); }
        
        function renderExercises(){
            const q = (document.getElementById('exerciseSearch').value || '').toLowerCase();
            const list = document.getElementById('exercisesList');
            let items = availableExercises.filter(e => e.name.toLowerCase().includes(q));
            
            // Aplicar filtros de grupo muscular
            if (exerciseFilters.muscleGroups.length > 0) {
                items = items.filter(e => exerciseFilters.muscleGroups.includes(e.muscle));
            }
            
            // Aplicar ordenação
            switch(exerciseFilters.sortBy) {
                case 'name':
                    items.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                // ... (outros casos de ordenação)
            }
            
            // Verificar se não há exercícios
            if (availableExercises.length === 0) {
                list.innerHTML = '<div class="card">Sem exercícios ainda.</div>';
                return;
            }
            
            // Verificar se a pesquisa não encontrou resultados
            if (items.length === 0) {
                list.innerHTML = '<div class="card">Nenhum exercício encontrado.</div>';
                return;
            }
            
            list.innerHTML = items.map(e => {
                // Carregar mídia para obter a miniatura
                const mediaData = loadExerciseMediaData();
                const exerciseMedia = mediaData[e.name] || {};
                const hasImage = exerciseMedia && exerciseMedia.image;
                
                return `
                    <div class="exercise-list-item">
                        ${hasImage ? 
                            `<img src="${exerciseMedia.image}" class="exercise-thumbnail" alt="${e.name}">` : 
                            `<div class="exercise-thumbnail"><i class="bi bi-activity"></i></div>`
                        }
                        <div>
                            <div class="title">${e.name}</div>
                            <div class="subtitle">${e.muscle}</div>
                        </div>
                        <button class="kebab" onclick="openExerciseDetail('${e.name.replace(/'/g,"&#39;")}')">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        // Funções auxiliares para ordenação de exercícios
        function getExercisePerformanceCount(exerciseName) {
            const exercisesData = getExercisesData();
            if (exercisesData[exerciseName] && exercisesData[exerciseName].history) {
                return exercisesData[exerciseName].history.length;
            }
            return 0;
        }
        
        function getExerciseLastPerformedDate(exerciseName) {
            const exercisesData = getExercisesData();
            if (exercisesData[exerciseName] && exercisesData[exerciseName].history && exercisesData[exerciseName].history.length > 0) {
                const sortedHistory = exercisesData[exerciseName].history.sort((a, b) => new Date(b.date) - new Date(a.date));
                return sortedHistory[0].date;
            }
            return '1970-01-01'; // Data muito antiga para exercícios nunca realizados
        }
        
        // MODAL: Adicionar exercício (substitui o prompt)
        function openAddExerciseModal(dayIndex){
            currentDayForExercise = dayIndex;
            const sel = document.getElementById('exerciseSelect');
            sel.innerHTML = '<option value="">Selecione um exercício</option>' + availableExercises.map(e=>`<option value="${e.name}">${e.name}</option>`).join('');
            document.getElementById('exerciseSets').value = '';
            document.getElementById('exerciseReps').value = '';
            document.getElementById('exerciseWeight').value = '';
            document.getElementById('addExerciseModal').style.display='block';
        }
        
        function closeAddExerciseModal(){
            document.getElementById('addExerciseModal').style.display='none';
        }
        
        function saveNewExercise() {
            const name = document.getElementById('newExerciseName').value.trim();
            const muscle = document.getElementById('newExerciseMuscle').value;
            
            if (!name) {
                alert('Por favor, insira um nome para o exercício.');
                return;
            }
            
            // Verificar se já existe
            if (availableExercises.some(e => e.name.toLowerCase() === name.toLowerCase())) {
                alert('Já existe a exercício com esse nome.');
                return;
            }
            
            availableExercises.push({ name, muscle, type: muscle.toLowerCase() });
            saveAvailableExercises(availableExercises); // Salvar no localStorage
            
            const data = loadExercisesData();
            if (!data[name]) {
                data[name] = { notes: '', sets: [], history: [] };
            }
            saveExercisesData(data);
            
            renderExercises();
            closeAddExerciseModal();
            showToast('Exercício adicionado.');
        }

        // Detalhe exercício
        function openExerciseDetail(name){ 
            currentExercise=name; 
            showPage('exerciseDetailPage'); 
            document.getElementById('exerciseDetailTitle').textContent=name; 
            loadExerciseDetail(name);
            loadExerciseMedia(name);
        }
        
        function closeExerciseDetail(){ showPage('exercisesPage'); }
        
        function loadExerciseDetail(name){
            const data = getExercisesData()[name] || { notes: '', history: [] };
            document.getElementById('exerciseNotes').value = data.notes || '';
            
            updateExerciseStats(data.history || []);

            // Atualizar o gráfico para mostrar a média de peso por repetição
            const ctx = document.getElementById('exerciseChart');
            if (exerciseChart) exerciseChart.destroy();
            
            if (data.history && data.history.length > 0) {
                // Preparar dados para o gráfico
                const labels = data.history.map(h => new Date(h.startTime).toLocaleDateString('pt-PT'));
                const avgData = data.history.map(h => h.averageWeightPerRep || 0);
                const maxData = data.history.map(h => h.maxWeight || 0);
                
                exerciseChart = new Chart(ctx, { 
                    type: 'line', 
                    data: { 
                        labels: labels,
                        datasets: [
                            { 
                                label: 'Média de Peso por Repetição (kg)', 
                                data: avgData,
                                borderColor: '#4f46e5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Peso Máximo (kg)',
                                data: maxData,
                                borderColor: '#2e7d32',
                                backgroundColor: 'rgba(46, 125, 50, 0.1)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    }, 
                    options: { 
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Kg'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Data'
                                }
                            }
                        }
                    } 
                });
            } else {
                // Gráfico vazio
                exerciseChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Média de Peso por Repetição (kg)',
                                data: [],
                                borderColor: '#4f46e5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Peso Máximo (kg)',
                                data: [],
                                borderColor: '#2e7d32',
                                backgroundColor: 'rgba(46, 125, 50, 0.1)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: { 
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Kg'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Data'
                                }
                            }
                        }
                    }
                });
            }
            
            // Carregar o histórico de exercícios
            loadExerciseHistoryList(data.history || []);
        }

        function updateExerciseStats(history) {
            if (!history || history.length === 0) {
                // Se não há histórico, definir valores padrão
                document.getElementById('statMaxWeight').textContent = '0 kg';
                document.getElementById('statMaxWeightDate').textContent = '—';
                document.getElementById('statTotalSessions').textContent = '0';
                document.getElementById('statAvgWeight').textContent = '0 kg';
                document.getElementById('statTotalVolume').textContent = '0 kg';
                return;
            }
            
            // Calcular estatísticas
            let maxWeight = 0;
            let maxWeightDate = '';
            let totalSessions = history.length;
            let totalReps = 0;
            let totalVolume = 0;
            let totalWeight = 0;
            let weightCount = 0;
            
            history.forEach(workout => {
                // Encontrar o peso máximo neste treino
                let workoutMaxWeight = 0;
                
                if (workout.sets) {
                    workout.sets.forEach(set => {
                        const weight = parseFloat(set.weight) || 0;
                        const reps = parseInt(set.repetitions) || 0;
                        
                        // Verificar peso máximo
                        if (weight > maxWeight) {
                            maxWeight = weight;
                            maxWeightDate = new Date(workout.startTime).toLocaleDateString('pt-PT');
                        }
                        
                        // Calcular totais
                        if (weight > 0) {
                            totalReps += reps;
                            totalVolume += weight * reps;
                            totalWeight += weight;
                            weightCount++;
                            
                            // Também verificar o máximo neste treino
                            if (weight > workoutMaxWeight) {
                                workoutMaxWeight = weight;
                            }
                        }
                    });
                }
                
                // Se não encontramos peso nos sets, verificar nas propriedades do workout
                if (workoutMaxWeight === 0 && workout.maxWeight) {
                    const weight = parseFloat(workout.maxWeight) || 0;
                    if (weight > maxWeight) {
                        maxWeight = weight;
                        maxWeightDate = new Date(workout.startTime).toLocaleDateString('pt-PT');
                    }
                }
            });
            
            // Calcular média de peso
            const avgWeight = weightCount > 0 ? totalWeight / weightCount : 0;
            
            // Atualizar a interface
            document.getElementById('statMaxWeight').textContent = `${maxWeight} kg`;
            document.getElementById('statMaxWeightDate').textContent = maxWeightDate || '—';
            document.getElementById('statTotalSessions').textContent = totalSessions;
            document.getElementById('statAvgWeight').textContent = `${avgWeight.toFixed(1)} kg`;
            document.getElementById('statTotalVolume').textContent = `${totalVolume.toFixed(0)} kg`;
        }
        
        // Função para carregar o histórico de exercícios na página de detalhes
        function loadExerciseHistoryList(history) {
            const container = document.getElementById('exerciseHistoryList');
            container.innerHTML = '';
            
            if (!history || history.length === 0) {
                container.innerHTML = '<div class="exercise-history-item">Nenhum treino registado ainda</div>';
                return;
            }
            
            history.sort((a, b) => new Date(b.startTime || b.date) - new Date(a.startTime || a.date));
            
            history.forEach((workout, index) => {
                const item = document.createElement('div');
                item.className = 'exercise-history-item';
                item.id = `exercise-history-${index}`;
                
                let setsHTML = '';
                if (workout.sets && workout.sets.length) {
                    setsHTML = workout.sets.map((set, i) => `
                        <div class="exercise-history-set">
                            <span>Série ${i + 1}:</span>
                            <span>${set.repetitions || 0} reps × ${set.weight || 0} kg</span>
                        </div>
                    `).join('');
                }
                
                item.innerHTML = `
                    <div class="exercise-history-header" onclick="toggleExerciseHistoryDetails(${index})">
                        <div class="exercise-history-date">${new Date(workout.startTime).toLocaleDateString('pt-PT')}</div>
                        <div class="exercise-history-avg">${workout.averageWeightPerRep ? workout.averageWeightPerRep.toFixed(2) + ' kg/rep' : 'N/A'}</div>
                    </div>
                    <div class="exercise-history-details">
                        <div class="exercise-history-detail-item">
                            <span class="exercise-history-detail-label">Séries</span>
                            <span class="exercise-history-detail-value">${workout.sets ? workout.sets.length : 0}</span>
                        </div>
                        <div class="exercise-history-detail-item">
                            <span class="exercise-history-detail-label">Reps Totais</span>
                            <span class="exercise-history-detail-value">${workout.totalReps || 0}</span>
                        </div>
                        <div class="exercise-history-detail-item">
                            <span class="exercise-history-detail-label">Volume Total</span>
                            <span class="exercise-history-detail-value">${workout.totalVolume ? workout.totalVolume.toFixed(2) + ' kg' : 'N/A'}</span>
                        </div>
                    </div>
                    <div class="exercise-history-sets" id="history-sets-${index}">
                        ${setsHTML}
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        function toggleExerciseHistoryDetails(index) {
            const setsElement = document.getElementById(`history-sets-${index}`);
            if (setsElement) {
                setsElement.classList.toggle('expanded');
            }
        }
        
        function saveExerciseNotes(){ const data=loadExercisesData(); if(!data[currentExercise]) data[currentExercise]={notes:'',history:[]}; data[currentExercise].notes=document.getElementById('exerciseNotes').value; saveExercisesData(data); showToast('Notas guardadas.'); }
        
        // MODAL: Editar nome do exercício (substitui o prompt)
        function openEditExerciseNameModal(){
            document.getElementById('editExerciseName').value = currentExercise;
            document.getElementById('editExerciseNameModal').style.display='block';
        }
        
        function closeEditExerciseNameModal(){
            document.getElementById('editExerciseNameModal').style.display='none';
        }
        
        function saveExerciseName(){
            const newName = document.getElementById('editExerciseName').value.trim();
            
            if (!newName) {
                alert('Por favor, insira um nome para o exercício.');
                return;
            }
            
            if (newName === currentExercise) {
                closeEditExerciseNameModal();
                return;
            }
            
            // Verificar se já existe
            if (availableExercises.some(e => e.name.toLowerCase() === newName.toLowerCase())) {
                alert('Já existe um exercício com esse nome.');
                return;
            }
            
            // Atualizar nos exercícios disponíveis
            const index = availableExercises.findIndex(e => e.name === currentExercise);
            if (index !== -1) {
                availableExercises[index].name = newName;
                saveAvailableExercises(availableExercises);
            }
            
            // Atualizar nos dados dos exercícios
            const data = loadExercisesData();
            if (data[currentExercise]) {
                data[newName] = data[currentExercise];
                delete data[currentExercise];
                saveExercisesData(data);
            }
            
            // Atualizar nos planos
            const plans = loadPlansData();
            let updatedPlans = false;
            plans.forEach(plan => {
                plan.days.forEach(day => {
                    day.exercises.forEach(exercise => {
                        if (exercise.name === currentExercise) {
                            exercise.name = newName;
                            updatedPlans = true;
                        }
                    });
                });
            });
            if (updatedPlans) {
                savePlansData(plans);
            }
            
            // Atualizar nos treinos
            const workouts = loadWorkoutsData();
            let updatedWorkouts = false;
            workouts.forEach(workout => {
                workout.exercises.forEach(exercise => {
                    if (exercise.name === currentExercise) {
                        exercise.name = newName;
                        updatedWorkouts = true;
                    }
                });
            });
            if (updatedWorkouts) {
                saveWorkoutsData(workouts);
            }
            
            // Atualizar mídia
            const mediaData = loadExerciseMediaData();
            if (mediaData[currentExercise]) {
                mediaData[newName] = mediaData[currentExercise];
                delete mediaData[currentExercise];
                saveExerciseMediaData(mediaData);
            }
            
            currentExercise = newName;
            document.getElementById('exerciseDetailTitle').textContent = newName;
            
            renderExercises();
            closeEditExerciseNameModal();
            showToast('Nome do exercício alterado.');
        }
        
        // MODAL: Confirmar remoção do exercício
        function openDeleteExerciseModal(){
            document.getElementById('exerciseNameToDelete').textContent = currentExercise;
            document.getElementById('deleteExerciseModal').style.display='block';
        }
        
        function closeDeleteExerciseModal(){
            document.getElementById('deleteExerciseModal').style.display='none';
        }
        
        function deleteExercise(){
            // Remover dos exercícios disponíveis
            const index = availableExercises.findIndex(e => e.name === currentExercise);
            if (index !== -1) {
                availableExercises.splice(index, 1);
                saveAvailableExercises(availableExercises);
            }
            
            // Remover dos dados dos exercícios
            const data = loadExercisesData();
            if (data[currentExercise]) {
                delete data[currentExercise];
                saveExercisesData(data);
            }
            
            // Remover dos planos
            const plans = loadPlansData();
            let updatedPlans = false;
            plans.forEach(plan => {
                plan.days.forEach(day => {
                    const originalLength = day.exercises.length;
                    day.exercises = day.exercises.filter(exercise => exercise.name !== currentExercise);
                    if (day.exercises.length !== originalLength) {
                        updatedPlans = true;
                    }
                });
            });
            if (updatedPlans) {
                savePlansData(plans);
            }
            
            // Remover dos treinos
            const workouts = loadWorkoutsData();
            let updatedWorkouts = false;
            workouts.forEach(workout => {
                const originalLength = workout.exercises.length;
                workout.exercises = workout.exercises.filter(exercise => exercise.name !== currentExercise);
                if (workout.exercises.length !== originalLength) {
                    updatedWorkouts = true;
                }
            });
            if (updatedWorkouts) {
                saveWorkoutsData(workouts);
            }
            
            // Remover mídia
            const mediaData = loadExerciseMediaData();
            if (mediaData[currentExercise]) {
                delete mediaData[currentExercise];
                saveExerciseMediaData(mediaData);
            }
            
            closeDeleteExerciseModal();
            showToast('Exercício removido.');
            closeExerciseDetail();
        }

        // ===== Funções para a Página de Planos =====
        function renderPlans(){ 
            const list=document.getElementById('plansList'); 
            const plans=loadPlansData(); 
            if(plans.length===0){ list.innerHTML='<div class="card">Sem planos ainda.</div>'; return; } 
            
            list.innerHTML=plans.map(p=>`
                <div class="list-item" data-plan-id="${p.id}">
                    <div><i class="bi bi-calendar-week"></i></div>
                    <div>
                        <div class="title">${p.name}</div>
                        <div class="subtitle">${p.days.length} dias</div>
                    </div>
                    <button class="kebab" data-plan-id="${p.id}"><i class="bi bi-three-dots-vertical"></i></button>
                </div>
            `).join(''); 
            
            // Adicionar event listeners após renderizar
            setTimeout(() => {
                // Clique no item do plano
                document.querySelectorAll('.list-item[data-plan-id]').forEach(item => {
                    item.addEventListener('click', function(e) {
                        // Não abrir se o clique foi no botão de opções
                        if (!e.target.closest('.kebab')) {
                            const planId = this.getAttribute('data-plan-id');
                            openPlanDetail(planId);
                        }
                    });
                });
                
                // Clique no botão de opções
                document.querySelectorAll('.kebab[data-plan-id]').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const planId = this.getAttribute('data-plan-id');
                        openPlanDetail(planId);
                    });
                });
            }, 0);
        }
        
        function openPlanOptions(planId, event) {
            event.stopPropagation();
            
            // Fechar menus abertos anteriormente
            closeAllPlanOptionsMenus();
            
            const button = event.target;
            const menu = document.createElement('div');
            menu.className = 'plan-options-menu';
            menu.style.cssText = `
                position: absolute;
                background: var(--card);
                border: 1px solid rgba(255,255,255,0.2);
                border-radius: 8px;
                padding: 8px 0;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                min-width: 120px;
            `;
            
            menu.innerHTML = `
                <div class="plan-option" onclick="editPlan('${planId}')" style="padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="bi bi-pencil"></i> Editar
                </div>
                <div class="plan-option" onclick="deletePlan('${planId}')" style="padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--danger);">
                    <i class="bi bi-trash"></i> Eliminar
                </div>
            `;
            
            // Posicionar o menu perto do botão
            const rect = button.getBoundingClientRect();
            menu.style.top = `${rect.bottom + window.scrollY}px`;
            menu.style.left = `${rect.left + window.scrollX - 100}px`;
            
            menu.id = `plan-menu-${planId}`;
            document.body.appendChild(menu);
            
            // Fechar menu ao clicar fora
            setTimeout(() => {
                document.addEventListener('click', closeAllPlanOptionsMenus, { once: true });
            }, 100);
        }

        function closeAllPlanOptionsMenus() {
            const menus = document.querySelectorAll('.plan-options-menu');
            menus.forEach(menu => menu.remove());
        }

        function editPlan(planId) {
            closeAllPlanOptionsMenus();
            openPlanDetail(planId);
            // Aqui você pode adicionar lógica para edição rápida do nome, etc.
        }

        function deletePlan(planId) {
            closeAllPlanOptionsMenus();
            
            // Usar a lógica existente de eliminação de plano
            const plans = loadPlansData();
            const planIndex = plans.findIndex(p => p.id === planId);
            
            if (planIndex !== -1) {
                const planName = plans[planIndex].name;
                if (confirm(`Tem a certeza que deseja eliminar o plano "${planName}"?`)) {
                    plans.splice(planIndex, 1);
                    savePlansData(plans);
                    
                    // Se era o plano selecionado, limpar seleção
                    if (selectedPlanId === planId) {
                        selectedPlanId = null;
                        localStorage.removeItem(storageKeys.SELECTED_PLAN);
                        document.getElementById('selectedPlanLabel').textContent = '—';
                        document.getElementById('selectedPlanDays').innerHTML = '';
                    }
                    
                    renderPlans();
                    showToast('Plano eliminado.');
                }
            }
        }

        function openPlanDetail(id){ 
            const plans=loadPlansData(); 
            const plan=plans.find(p=>p.id===id); 
            if(!plan) {
                showToast('Plano não encontrado');
                return;
            } 
            
            // Garantir que o plano tem a estrutura correta
            if (!plan.days) {
                plan.days = [];
            }
            
            currentPlanDetail=plan; 
            document.getElementById('planDetailTitle').textContent=plan.name; 
            renderPlanDaysDetail(plan.days); 
            showPage('planDetailPage'); 
        }
        
        function closePlanDetail(){ showPage('plansPage'); }
        
        function renderPlanDaysDetail(days){ 
            const list=document.getElementById('planDaysDetail'); 
            if(days.length===0){ list.innerHTML='<div class="card">Sem dias ainda.</div>'; return; } 
            list.innerHTML=days.map((day, index)=>`
                <div class="plan-day-item">
                    <div class="plan-day-info">
                        <div class="plan-day-name">${day.name}</div>
                        <div class="plan-day-exercises-count">${day.exercises ? day.exercises.length : 0} exercícios</div>
                    </div>
                    <div>
                        <button class="plan-day-options" onclick="openDayManagementPage(${index})"><i class="bi bi-three-dots-vertical"></i></button>
                    </div>
                </div>
            `).join(''); 
        }
        
        // MODAL: Gestão do Dia (NOVA)
        function openDayManagementPage(dayIndex) {
            // Verificar se currentPlanDetail e days existem
            if (!currentPlanDetail || !currentPlanDetail.days || !currentPlanDetail.days[dayIndex]) {
                console.error('Erro: Plano ou dia não encontrado');
                showToast('Erro ao abrir gestão do dia');
                return;
            }
            
            // Recarregar o plano atual para garantir que temos os dados mais recentes
            const plans = loadPlansData();
            const updatedPlan = plans.find(p => p.id === currentPlanDetail.id);
            if (updatedPlan) {
                currentPlanDetail = updatedPlan;
            }
            
            currentDayManagementIndex = dayIndex;
            const day = currentPlanDetail.days[dayIndex];
            document.getElementById('dayManagementPageTitle').textContent = day.name;
            renderDayManagementPageExerciseList(day.exercises || []);
            showPage('dayManagementPage');
        }
        
        function closeDayManagementPage() {
            // Recarregar os dados do plano antes de voltar
            const plans = loadPlansData();
            const updatedPlan = plans.find(p => p.id === currentPlanDetail.id);
            if (updatedPlan) {
                currentPlanDetail = updatedPlan;
                renderPlanDaysDetail(currentPlanDetail.days);
            }
            showPage('planDetailPage');
        }
        
        function renderDayManagementPageExerciseList(exercises) {
            const list = document.getElementById('dayManagementPageExerciseList');
            if (!exercises || exercises.length === 0) {
                list.innerHTML = '<div class="card">Sem exercícios ainda.</div>';
                return;
            }
            
            list.innerHTML = exercises.map((exercise, index) => `
                <div class="day-management-page-exercise-item" draggable="true" ondragstart="dragExerciseStart(event, ${index})" ondragover="dragExerciseOver(event)" ondrop="dragExerciseDrop(event, ${index})">
                    <div class="day-management-page-exercise-info">
                        <div class="day-management-page-exercise-name">${exercise.name}</div>
                        <div class="day-management-page-exercise-details">${exercise.sets} séries × ${exercise.reps} reps ${exercise.weight ? `@ ${exercise.weight} kg` : ''}</div>
                    </div>
                    <div>
                        <button class="day-management-page-exercise-edit" onclick="openEditExerciseModalFromPage(${index})"><i class="bi bi-pencil"></i></button>
                        <button class="day-management-page-exercise-remove" onclick="openDeleteExerciseConfirmModalFromPage(${index})"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }
        
        function openAddExerciseToDayModalFromPage() {
            // Abrir o modal correto para adicionar exercício ao dia
            document.getElementById('addExerciseToDayModal').style.display = 'block';
            
            // Preencher o select com exercícios disponíveis
            const exerciseSelect = document.getElementById('exerciseSelect');
            exerciseSelect.innerHTML = '<option value="">Selecione um exercício</option>' + 
                availableExercises.map(e => `<option value="${e.name}">${e.name}</option>`).join('');
        }
        
        function openEditExerciseModalFromPage(exerciseIndex) {
            openEditExerciseModal(currentDayManagementIndex, exerciseIndex);
        }
        
        function openDeleteExerciseConfirmModalFromPage(exerciseIndex) {
            openDeleteExerciseConfirmModal(currentDayManagementIndex, exerciseIndex);
        }
        
        // Funções de drag and drop para reordenar exercícios
        let draggedExerciseIndex = null;
        
        function dragExerciseStart(event, index) {
            draggedExerciseIndex = index;
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', index);
            event.currentTarget.style.opacity = '0.4';
        }
        
        function dragExerciseOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
        
        function dragExerciseDrop(event, targetIndex) {
            event.preventDefault();
            event.currentTarget.style.opacity = '1';
            
            if (draggedExerciseIndex === null || draggedExerciseIndex === targetIndex) return;
            
            const day = currentPlanDetail.days[currentDayManagementIndex];
            const exercises = day.exercises;
            
            // Reordenar os exercícios
            const draggedExercise = exercises[draggedExerciseIndex];
            exercises.splice(draggedExerciseIndex, 1);
            exercises.splice(targetIndex, 0, draggedExercise);
            
            // Atualizar a lista
            renderDayManagementPageExerciseList(exercises);
            
            // Salvar as alterações
            savePlanChanges();
            
            draggedExerciseIndex = null;
        }

        function closeEditDayNameModal() {
            document.getElementById('editDayNameModal').style.display = 'none';
        }
        
        // MODAL: Editar nome do dia (NOVA)
        function openEditDayNameModalFromPage() {
            const day = currentPlanDetail.days[currentDayManagementIndex];
            document.getElementById('editDayNameInput').value = day.name;
            document.getElementById('editDayNameModal').style.display = 'block';
        }
        
        function saveDayName() {
            const newName = document.getElementById('editDayNameInput').value.trim();
            if (!newName) {
                alert('Por favor, insira um nome para o dia.');
                return;
            }
            
            currentPlanDetail.days[currentDayManagementIndex].name = newName;
            document.getElementById('dayManagementPageTitle').textContent = newName;
            
            // Atualizar também na página de detalhes do plano
            const dayItems = document.querySelectorAll('.plan-day-name');
            if (dayItems[currentDayManagementIndex]) {
                dayItems[currentDayManagementIndex].textContent = newName;
            }
            
            savePlanChanges();
            closeEditDayNameModal();
            showToast('Nome do dia alterado.');
        }
        
        function openPlanSelection(){ 
            const list=document.getElementById('planSelectionList'); 
            const plans=loadPlansData(); 
            if(plans.length===0){ list.innerHTML='<div class="card">Sem planos ainda.</div>'; return; } 
            list.innerHTML=plans.map(p=>`
                <div class="plan-selection-item" onclick="selectPlan('${p.id}')">
                    <div class="title">${p.name}</div>
                    <div class="subtitle">${p.days.length} dias</div>
                </div>
            `).join(''); 
            document.getElementById('planSelectionModal').style.display='block'; 
        }
        
        function closePlanSelection(){ document.getElementById('planSelectionModal').style.display='none'; }
        
        function selectPlan(id){ 
            const plans=loadPlansData(); 
            const plan=plans.find(p=>p.id===id); 
            if(!plan) return; 
            
            selectedPlanId=id; 
            localStorage.setItem(storageKeys.SELECTED_PLAN, id); 
            document.getElementById('selectedPlanLabel').textContent=plan.name; 
            
            // Garantir que os dias existem
            if (!plan.days) {
                plan.days = [];
            }
            
            renderSelectedPlanDays(plan.days); 
            closePlanSelection(); 
            showToast('Plano selecionado.'); 
        }
        
        function renderSelectedPlanDays(days){ 
            const container=document.getElementById('selectedPlanDays'); 
            
            // Limpar o container primeiro
            container.innerHTML = '';
            
            if(!days || days.length===0){ 
                container.innerHTML='<div class="card">Este plano não tem dias.</div>'; 
                return; 
            } 
            
            container.innerHTML=days.map((day, index)=>`
                <div class="day-card">
                    <div class="day-number-box">
                        <div>DIA</div>
                        <div>${index + 1}</div>
                    </div>
                    <div style="flex:1;">
                        <h5>${day.name}</h5>
                        <small>${day.exercises ? day.exercises.length : 0} exercícios</small>
                    </div>
                    <button class="start-workout-btn-home" onclick="openDayDetail('${day.name}')">Iniciar</button>
                </div>
            `).join(''); 
        }
        
        function openDayDetail(dayName){ 
            if(!selectedPlanId) return; 
            const plans=loadPlansData(); 
            const plan=plans.find(p=>p.id===selectedPlanId); 
            if(!plan || !plan.days) return; 
            const day=plan.days.find(d=>d.name===dayName); 
            if(!day) return; 
            currentDayDetail=day; 
            document.getElementById('dayDetailTitle').textContent=day.name; 
            renderDayExercises(day.exercises || []); 
            showPage('dayDetailPage'); 
        }
        
        function closeDayDetail(){ showPage('mainPage'); }
        
        function renderDayExercises(exercises){ 
            const list=document.getElementById('dayExercisesList'); 
            if(exercises.length===0){ list.innerHTML='<div class="card">Sem exercícios ainda.</div>'; return; } 
            list.innerHTML=exercises.map(e=>`
                <div class="day-detail-exercise">
                    <div class="day-detail-exercise-header">
                        <div class="day-detail-exercise-name">${e.name}</div>
                    </div>
                    <div class="day-detail-exercise-details">
                        <div class="day-detail-exercise-sets">${e.sets} séries</div>
                        <div class="day-detail-exercise-weight">${e.reps} reps ${e.weight ? `@ ${e.weight} kg` : ''}</div>
                    </div>
                </div>
            `).join(''); 
        }
        
        // MODAL: Criar plano
        function openPlanModal(){ document.getElementById('modalPlanTitle').textContent='Criar Plano de Treino'; document.getElementById('planNameInput').value=''; document.getElementById('planModal').style.display='block'; }
        
        function closePlanModal(){ document.getElementById('planModal').style.display='none'; }
        
        function savePlan(){ 
            const name=document.getElementById('planNameInput').value.trim(); 
            if(!name) {
                showToast('Por favor, insira um nome para o plano');
                return;
            } 
            
            const plans=loadPlansData(); 
            const newPlan={ 
                id:Date.now().toString(), 
                name, 
                days:[] // Garantir que o array de dias é inicializado
            }; 
            plans.push(newPlan); 
            savePlansData(plans); 
            renderPlans(); 
            closePlanModal(); 
            showToast('Plano criado!'); 
        }
        
        // MODAL: Adicionar dia
        function openAddDayModal(){ document.getElementById('dayNameInput').value=''; document.getElementById('addDayModal').style.display='block'; }
        
        function closeAddDayModal(){ document.getElementById('addDayModal').style.display='none'; }
        
        function saveDay(){ 
            const name=document.getElementById('dayNameInput').value.trim(); 
            if(!name) {
                showToast('Por favor, insira um nome para o dia');
                return;
            } 
            
            if(!currentPlanDetail) {
                showToast('Erro: Nenhum plano selecionado');
                return;
            } 
            
            // Garantir que o array days existe
            if (!currentPlanDetail.days) {
                currentPlanDetail.days = [];
            }
            
            currentPlanDetail.days.push({ name, exercises: [] }); 
            
            // Guardar automaticamente
            savePlanChanges();
            
            closeAddDayModal(); 
            showToast('Dia adicionado!'); 
        }
        
        // MODAL: Editar nome do plano
        function openEditPlanNameModal(){ document.getElementById('editPlanNameInput').value=currentPlanDetail.name; document.getElementById('editPlanNameModal').style.display='block'; }
        
        function closeEditPlanNameModal(){ document.getElementById('editPlanNameModal').style.display='none'; }
        
        function savePlanName(){ 
            const name=document.getElementById('editPlanNameInput').value.trim(); 
            if(!name) return; 
            currentPlanDetail.name=name; 
            document.getElementById('planDetailTitle').textContent=name; 
            closeEditPlanNameModal(); 
            showToast('Nome do plano alterado.'); 
        }
        
        // MODAL: Opções do dia (apenas remover)
        function openDayOptionsModal(dayIndex){ 
            const day=currentPlanDetail.days[dayIndex]; 
            document.getElementById('dayNameToDelete').textContent=day.name; 
            document.getElementById('dayOptionsModal').style.display='block'; 
        }
        
        function closeDayOptionsModal(){ document.getElementById('dayOptionsModal').style.display='none'; }
        
        function removeDay(){ 
            if(!currentPlanDetail) return; 
            currentPlanDetail.days.splice(currentDayManagementIndex, 1); 
            renderPlanDaysDetail(currentPlanDetail.days); 
            closeDayOptionsModal(); 
            showToast('Dia removido.'); 
            closeDayManagementPage();
        }
        
        // MODAL: Adicionar exercício ao dia (já existe)
        function openAddExerciseToDayModalFromManagement(){ openAddExerciseModal(currentDayManagementIndex); }
        
        function saveExerciseToDay(){ 
            const ex=document.getElementById('exerciseSelect').value; 
            const sets=parseInt(document.getElementById('exerciseSets').value)||1; 
            const reps=parseInt(document.getElementById('exerciseReps').value)||1; 
            const weight=parseFloat(document.getElementById('exerciseWeight').value)||0; 
            
            if(!ex) return; 
            
            let targetDay;
            if (currentDayForExercise !== null && currentDayForExercise !== undefined) {
                // Estamos na gestão do dia
                targetDay = currentPlanDetail.days[currentDayForExercise];
            } else {
                // Estamos no modal normal
                targetDay = currentPlanDetail.days[currentDayManagementIndex];
            }
            
            if(!targetDay) return; 
            
            targetDay.exercises.push({ name: ex, sets, reps, weight }); 
            
            // GUARDAR AUTOMATICAMENTE
            savePlanChanges();
            
            // Atualizar a visualização
            if (currentPage === 'dayManagementPage') {
                renderDayManagementPageExerciseList(targetDay.exercises);
            } else {
                renderPlanDaysDetail(currentPlanDetail.days);
            }
            
            closeAddExerciseToDayModal(); 
            showToast('Exercício adicionado!'); 
        }
        
        function closeAddExerciseToDayModal(){ 
            document.getElementById('addExerciseToDayModal').style.display='none'; 
            currentDayForExercise = null;
        }
        
        // MODAL: Editar exercício do dia (MODIFICADO)
        function openEditExerciseModal(dayIndex, exerciseIndex){ 
            const day=currentPlanDetail.days[dayIndex]; 
            const ex=day.exercises[exerciseIndex]; 
            document.getElementById('editExerciseNameStatic').textContent=ex.name; 
            document.getElementById('editExerciseSets').value=ex.sets; 
            document.getElementById('editExerciseReps').value=ex.reps; 
            document.getElementById('editExerciseWeight').value=ex.weight||''; 
            exerciseToRemoveIndex=exerciseIndex; 
            document.getElementById('editExerciseModal').style.display='block'; 
        }
        
        function closeEditExerciseModal(){ document.getElementById('editExerciseModal').style.display='none'; }
        
        function saveEditedExercise(){ 
            const sets=parseInt(document.getElementById('editExerciseSets').value)||1; 
            const reps=parseInt(document.getElementById('editExerciseReps').value)||1; 
            const weight=parseFloat(document.getElementById('editExerciseWeight').value)||0; 
            
            if(!currentPlanDetail) return; 
            const day=currentPlanDetail.days[currentDayManagementIndex]; 
            if(!day) return; 
            
            day.exercises[exerciseToRemoveIndex].sets=sets; 
            day.exercises[exerciseToRemoveIndex].reps=reps; 
            day.exercises[exerciseToRemoveIndex].weight=weight; 
            
            // Atualizar a visualização
            if (currentPage === 'dayManagementPage') {
                renderDayManagementPageExerciseList(day.exercises);
            } else {
                renderPlanDaysDetail(currentPlanDetail.days);
            }
            
            closeEditExerciseModal(); 
            showToast('Exercício atualizado!'); 
        }
        
        // MODAL: Confirmar remoção de exercício do plano
        function openDeleteExerciseConfirmModal(dayIndex, exerciseIndex){ 
            exerciseToRemoveIndex=exerciseIndex; 
            document.getElementById('deleteExerciseConfirmModal').style.display='block'; 
        }
        
        function closeDeleteExerciseConfirmModal(){ document.getElementById('deleteExerciseConfirmModal').style.display='none'; }
        
        function confirmRemoveExerciseFromDay(){ 
            if(!currentPlanDetail) return; 
            const day=currentPlanDetail.days[currentDayManagementIndex]; 
            if(!day) return; 
            
            day.exercises.splice(exerciseToRemoveIndex, 1); 
            
            // Atualizar a visualização
            if (currentPage === 'dayManagementPage') {
                renderDayManagementPageExerciseList(day.exercises);
            } else {
                renderPlanDaysDetail(currentPlanDetail.days);
            }
            
            closeDeleteExerciseConfirmModal(); 
            showToast('Exercício removido do dia.'); 
        }
        
        // MODAL: Confirmar remoção do plano
        function removePlan(){ document.getElementById('deletePlanConfirmModal').style.display='block'; }
        
        function closeDeletePlanConfirmModal(){ document.getElementById('deletePlanConfirmModal').style.display='none'; }
        
        function confirmRemovePlan(){ 
            if(!currentPlanDetail) return; 
            const plans=loadPlansData(); 
            const index=plans.findIndex(p=>p.id===currentPlanDetail.id); 
            if(index!==-1){ 
                plans.splice(index,1); 
                savePlansData(plans); 
            } 
            closeDeletePlanConfirmModal(); 
            showToast('Plano removido.'); 
            closePlanDetail(); 
        }
        
        function savePlanChanges(){ 
            const plans=loadPlansData(); 
            const index=plans.findIndex(p=>p.id===currentPlanDetail.id); 
            if(index!==-1){ 
                plans[index]=currentPlanDetail; 
                savePlansData(plans); 
            } 
            
            // Atualizar TODAS as visualizações relevantes
            if (currentPage === 'planDetailPage') {
                renderPlanDaysDetail(currentPlanDetail.days);
            }
            
            // SEMPRE atualizar a main page se este for o plano selecionado
            if (selectedPlanId === currentPlanDetail.id) {
                renderSelectedPlanDays(currentPlanDetail.days);
            }
            
            // Atualizar também a página de planos
            renderPlans();
            
            showToast('Plano guardado!'); 
        }
        
        // ===== Funções para a Página de Treinos (Histórico) =====
        function renderWorkouts(){ 
            const q = (document.getElementById('workoutSearch').value || '').toLowerCase();
            const list = document.getElementById('workoutsList'); 
            const workouts = loadWorkoutsData(); 
            
            // Aplicar filtros
            let filteredWorkouts = workouts.filter(w => 
                w.dayName.toLowerCase().includes(q) || 
                (w.planName && w.planName.toLowerCase().includes(q))
            );
            
            // Aplicar filtro de data
            if (workoutFilters.dateStart) {
                filteredWorkouts = filteredWorkouts.filter(w => new Date(w.startTime) >= new Date(workoutFilters.dateStart));
            }
            if (workoutFilters.dateEnd) {
                // Adicionar um dia para incluir o dia final
                const endDate = new Date(workoutFilters.dateEnd);
                endDate.setDate(endDate.getDate() + 1);
                filteredWorkouts = filteredWorkouts.filter(w => new Date(w.startTime) < endDate);
            }
            
            // Aplicar filtro de plano
            if (workoutFilters.plan) {
                filteredWorkouts = filteredWorkouts.filter(w => w.planId === workoutFilters.plan);
            }
            
            // Ordenar por data (mais recente primeiro)
            filteredWorkouts.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
            
            if (filteredWorkouts.length === 0) { 
                list.innerHTML = '<div class="card">Nenhum treino encontrado.</div>'; 
                return; 
            } 
            
            list.innerHTML = filteredWorkouts.map(w => `
                <div class="workout-item-compact" onclick="openWorkoutDetailModal('${w.startTime}')">
                    <div class="workout-header-compact">
                        <div class="workout-title-compact">${w.dayName}</div>
                        <div class="workout-date-compact">${new Date(w.startTime).toLocaleDateString('pt-PT')}</div>
                    </div>
                    <div class="workout-details-compact">
                        <div class="workout-day-compact">${w.planName || 'Plano'}</div>
                        <div class="workout-duration-compact">${w.duration || 'N/A'}</div>
                    </div>
                </div>
            `).join(''); 
        }
        
        // MODAL: Detalhes do treino
        function openWorkoutDetailModal(startTime) {
            const workouts = loadWorkoutsData();
            const workout = workouts.find(w => w.startTime === startTime);
            if (!workout) return;
            
            currentWorkoutDetail = workout;
            
            // Preencher informações gerais
            document.getElementById('workoutDetailInfo').innerHTML = `
                <div class="workout-detail-info-item">
                    <span class="workout-detail-info-label">Plano:</span>
                    <span class="workout-detail-info-value">${workout.planName || 'N/A'}</span>
                </div>
                <div class="workout-detail-info-item">
                    <span class="workout-detail-info-label">Dia:</span>
                    <span class="workout-detail-info-value">${workout.dayName}</span>
                </div>
                <div class="workout-detail-info-item">
                    <span class="workout-detail-info-label">Data:</span>
                    <span class="workout-detail-info-value">${new Date(workout.startTime).toLocaleDateString('pt-PT')}</span>
                </div>
                <div class="workout-detail-info-item">
                    <span class="workout-detail-info-label">Duração:</span>
                    <span class="workout-detail-info-value">${workout.duration || 'N/A'}</span>
                </div>
            `;
            
            // Preencher exercícios
            const exercisesContainer = document.getElementById('workoutDetailExercises');
            exercisesContainer.innerHTML = workout.exercises.map(exercise => {
                let setsHTML = '';
                if (exercise.results && exercise.results.length > 0) {
                    setsHTML = exercise.results.map((set, i) => `
                        <div class="workout-detail-set">
                            <div>Série ${i + 1}:</div>
                            <div>${set.repetitions || 0} reps</div>
                            <div>${set.weight || 0} kg</div>
                        </div>
                    `).join('');
                }
                
                return `
                    <div class="workout-detail-exercise" onclick="toggleWorkoutExerciseDetails(this)">
                        <div class="workout-detail-exercise-header">
                            <div class="workout-detail-exercise-name">${exercise.name}</div>
                        </div>
                        <div class="workout-detail-exercise-sets">${exercise.sets} séries × ${exercise.reps} reps ${exercise.weight ? `@ ${exercise.weight} kg` : ''}</div>
                        <div class="workout-detail-exercise-details">
                            <div class="workout-detail-set workout-detail-set-header">
                                <div>Série</div>
                                <div>Reps</div>
                                <div>Peso</div>
                            </div>
                            ${setsHTML}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('workoutDetailModal').style.display = 'block';
        }
        
        function closeWorkoutDetailModal() {
            document.getElementById('workoutDetailModal').style.display = 'none';
        }
        
        function toggleWorkoutExerciseDetails(element) {
            element.classList.toggle('expanded');
        }
        
        // MODAL: Eliminar treino
        function deleteWorkout() {
            document.getElementById('deleteWorkoutConfirmModal').style.display = 'block';
        }
        
        function closeDeleteWorkoutConfirmModal() {
            document.getElementById('deleteWorkoutConfirmModal').style.display = 'none';
        }
        
        function confirmDeleteWorkout() {
            if (!currentWorkoutDetail) return;
            
            // Remover o treino do histórico de exercícios
            removeWorkoutFromExerciseHistory(currentWorkoutDetail);
            
            const workouts = loadWorkoutsData();
            const index = workouts.findIndex(w => w.startTime === currentWorkoutDetail.startTime);
            if (index !== -1) {
                workouts.splice(index, 1);
                saveWorkoutsData(workouts);
            }
            
            closeDeleteWorkoutConfirmModal();
            closeWorkoutDetailModal();
            renderWorkouts();
            showToast('Treino eliminado.');
        }

        function removeWorkoutFromExerciseHistory(workout) {
            const exercisesData = loadExercisesData();
            
            workout.exercises.forEach(exercise => {
                if (exercisesData[exercise.name] && exercisesData[exercise.name].history) {
                    // Filtrar o histórico para remover este workout
                    exercisesData[exercise.name].history = exercisesData[exercise.name].history.filter(
                        h => h.startTime !== workout.startTime
                    );
                }
            });
            
            saveExercisesData(exercisesData);
        }
        
        // ===== Funções para Filtros =====
        
        // Filtros de exercícios
        function openExerciseFilterModal() {
            // Preencir checkboxes com os filtros atuais
            const checkboxes = ['Chest', 'Back', 'Legs', 'Shoulders', 'Arms', 'Other'];
            checkboxes.forEach(muscle => {
                const checkbox = document.getElementById(`filter${muscle}`);
                if (checkbox) {
                    checkbox.checked = exerciseFilters.muscleGroups.includes(muscle);
                }
            });
            
            // Definir a ordenação atual
            document.getElementById('exerciseSort').value = exerciseFilters.sortBy;
            
            document.getElementById('exerciseFilterModal').style.display = 'block';
        }
        
        function closeExerciseFilterModal() {
            document.getElementById('exerciseFilterModal').style.display = 'none';
        }
        
        function clearExerciseFilters() {
            exerciseFilters = {
                muscleGroups: [],
                sortBy: 'name'
            };
            
            // Desmarcar todas as checkboxes
            const checkboxes = ['Chest', 'Back', 'Legs', 'Shoulders', 'Arms', 'Other'];
            checkboxes.forEach(muscle => {
                const checkbox = document.getElementById(`filter${muscle}`);
                if (checkbox) {
                    checkbox.checked = false;
                }
            });
            
            // Definir ordenação padrão
            document.getElementById('exerciseSort').value = 'name';
            
            renderExercises();
            closeExerciseFilterModal();
            showToast('Filtros limpos.');
        }
        
        function applyExerciseFilters() {
            // Obter grupos musculares selecionados
            const muscleGroups = [];
            const checkboxes = ['Chest', 'Back', 'Legs', 'Shoulders', 'Arms', 'Other'];
            checkboxes.forEach(muscle => {
                const checkbox = document.getElementById(`filter${muscle}`);
                if (checkbox && checkbox.checked) {
                    muscleGroups.push(muscle);
                }
            });
            
            // Obter ordenação
            const sortBy = document.getElementById('exerciseSort').value;
            
            exerciseFilters = {
                muscleGroups,
                sortBy
            };
            
            renderExercises();
            closeExerciseFilterModal();
            showToast('Filtros aplicados.');
        }
        
        // Filtros de treinos
        function openWorkoutFilterModal() {
            // Preencher o dropdown de planos
            const planSelect = document.getElementById('workoutFilterPlan');
            const plans = loadPlansData();
            planSelect.innerHTML = '<option value="">Todos os planos</option>' + 
                plans.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            
            // Definir valores atuais
            if (workoutFilters.dateStart) {
                document.getElementById('workoutFilterDateStart').value = workoutFilters.dateStart;
            }
            if (workoutFilters.dateEnd) {
                document.getElementById('workoutFilterDateEnd').value = workoutFilters.dateEnd;
            }
            if (workoutFilters.plan) {
                document.getElementById('workoutFilterPlan').value = workoutFilters.plan;
            }
            
            document.getElementById('workoutFilterModal').style.display = 'block';
        }
        
        function closeWorkoutFilterModal() {
            document.getElementById('workoutFilterModal').style.display = 'none';
        }
        
        function clearWorkoutFilters() {
            workoutFilters = {
                dateStart: null,
                dateEnd: null,
                plan: null
            };
            
            document.getElementById('workoutFilterDateStart').value = '';
            document.getElementById('workoutFilterDateEnd').value = '';
            document.getElementById('workoutFilterPlan').value = '';
            
            renderWorkouts();
            closeWorkoutFilterModal();
            showToast('Filtros limpos.');
        }
        
        function applyWorkoutFilters() {
            const dateStart = document.getElementById('workoutFilterDateStart').value;
            const dateEnd = document.getElementById('workoutFilterDateEnd').value;
            const plan = document.getElementById('workoutFilterPlan').value;
            
            workoutFilters = {
                dateStart: dateStart || null,
                dateEnd: dateEnd || null,
                plan: plan || null
            };
            
            renderWorkouts();
            closeWorkoutFilterModal();
            showToast('Filtros aplicados.');
        }

        // ===== Funções para Mídia de Exercícios =====
        function loadExerciseMediaData() {
            return JSON.parse(localStorage.getItem(storageKeys.EXERCISE_MEDIA)) || {};
        }
        
        function saveExerciseMediaData(data) {
            localStorage.setItem(storageKeys.EXERCISE_MEDIA, JSON.stringify(data));
        }
        
        function loadExerciseMedia(exerciseName) {
            const mediaData = loadExerciseMediaData();
            const media = mediaData[exerciseName] || {};
            
            const imageBox = document.getElementById('exerciseImageBox');
            const gifBox = document.getElementById('exerciseGifBox');
            
            // Limpar conteúdo anterior
            imageBox.innerHTML = '<span class="exercise-media-label">Imagem</span><button class="exercise-media-menu" onclick="openExerciseMediaMenu(\'image\', event)"><i class="bi bi-three-dots-vertical"></i></button><div class="exercise-media-options" id="imageOptions"><div class="exercise-media-option" onclick="changeExerciseMedia(\'image\')">Alterar Imagem</div><div class="exercise-media-option" onclick="removeExerciseMedia(\'image\')">Remover Imagem</div></div>';
            gifBox.innerHTML = '<span class="exercise-media-label">GIF</span><button class="exercise-media-menu" onclick="openExerciseMediaMenu(\'gif\', event)"><i class="bi bi-three-dots-vertical"></i></button><div class="exercise-media-options" id="gifOptions"><div class="exercise-media-option" onclick="changeExerciseMedia(\'gif\')">Alterar GIF</div><div class="exercise-media-option" onclick="removeExerciseMedia(\'gif\')">Remover GIF</div></div>';
            
            // Adicionar imagem se existir
            if (media.image) {
                const img = document.createElement('img');
                img.src = media.image;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                img.style.objectFit = 'contain';
                imageBox.appendChild(img);
            }
            
            // Adicionar GIF se existir
            if (media.gif) {
                const img = document.createElement('img');
                img.src = media.gif;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                img.style.objectFit = 'contain';
                gifBox.appendChild(img);
            }
        }
        
        function openExerciseMediaMenu(type, event) {
            event.stopPropagation();
            const options = document.getElementById(type + 'Options');
            options.style.display = options.style.display === 'block' ? 'none' : 'block';
            
            // Fechar outros menus abertos
            const allOptions = document.querySelectorAll('.exercise-media-options');
            allOptions.forEach(opt => {
                if (opt !== options) {
                    opt.style.display = 'none';
                }
            });
        }
        
        function changeExerciseMedia(type) {
            mediaTypeToChange = type;
            document.getElementById('mediaInput').click();
            
            // Fechar o menu
            const options = document.getElementById(type + 'Options');
            options.style.display = 'none';
        }
        
        function removeExerciseMedia(type) {
            const mediaData = loadExerciseMediaData();
            if (mediaData[currentExercise]) {
                delete mediaData[currentExercise][type];
                saveExerciseMediaData(mediaData);
                loadExerciseMedia(currentExercise);
                showToast(`${type === 'image' ? 'Imagem' : 'GIF'} removida.`);
            }
            
            // Fechar o menu
            const options = document.getElementById(type + 'Options');
            options.style.display = 'none';
        }
        
        // Configurar o input de arquivo para lidar com a seleção de mídia
        document.getElementById('mediaInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const mediaData = loadExerciseMediaData();
                if (!mediaData[currentExercise]) {
                    mediaData[currentExercise] = {};
                }
                mediaData[currentExercise][mediaTypeToChange] = event.target.result;
                saveExerciseMediaData(mediaData);
                loadExerciseMedia(currentExercise);
                showToast(`${mediaTypeToChange === 'image' ? 'Imagem' : 'GIF'} adicionada.`);
            };
            reader.readAsDataURL(file);
            
            // Limpar o input para permitir selecionar o mesmo arquivo novamente
            e.target.value = '';
        });
        
        // Fechar menus de mídia ao clicar fora
        document.addEventListener('click', function() {
            const allOptions = document.querySelectorAll('.exercise-media-options');
            allOptions.forEach(opt => {
                opt.style.display = 'none';
            });
        });

        function loadOngoingWorkout() {
            try {
                const workout = JSON.parse(localStorage.getItem(storageKeys.ONGOING_WORKOUT));
                if (workout) {
                    // Garantir que dayIndex existe no workout carregado
                    if (workout.dayIndex === undefined) {
                        workout.dayIndex = -1;
                    }
                    return workout;
                }
            } catch (e) {
                console.error('Erro ao carregar treino em progresso:', e);
            }
            return null;
        }


        // ===== Funções para o Fluxo de Treino =====
        
        // 1. Iniciar treino a partir da página de detalhes do dia
        function startWorkout() {
            if (!currentDayDetail) return;
            
            // Encontrar o índice do dia no plano atual
            let dayIndex = -1;
            if (currentPlanDetail && currentPlanDetail.days) {
                dayIndex = currentPlanDetail.days.findIndex(d => d.name === currentDayDetail.name);
            }
            
            // Criar um novo objeto de treino
            currentWorkout = {
                dayName: currentDayDetail.name,
                dayIndex: dayIndex, // Adicionar o índice do dia
                planId: selectedPlanId,
                planName: currentPlanDetail ? currentPlanDetail.name : 'Plano Personalizado',
                startTime: new Date().toISOString(),
                exercises: currentDayDetail.exercises ? currentDayDetail.exercises.map(ex => ({
                    name: ex.name,
                    sets: ex.sets,
                    reps: ex.reps,
                    weight: ex.weight,
                    results: []
                })) : [],
                completedExercises: []
            };
            
            // Guardar o treino em progresso
            saveOngoingWorkout(currentWorkout);
            
            // Mostrar a página do treino
            showWorkoutPage();
        }
        
        // 2. Mostrar a página do treino
        function showWorkoutPage() {
            if (!currentWorkout) return;
            
            document.getElementById('workoutTitle').textContent = currentWorkout.dayName;
            const container = document.getElementById('workoutExercisesList');
            container.innerHTML = '';
            
            // Ordenar exercícios: não concluídos primeiro, depois os concluídos
            const sortedExercises = [...currentWorkout.exercises].sort((a, b) => {
                const aIndex = currentWorkout.exercises.indexOf(a);
                const bIndex = currentWorkout.exercises.indexOf(b);
                const aCompleted = currentWorkout.completedExercises.includes(aIndex);
                const bCompleted = currentWorkout.completedExercises.includes(bIndex);
                return aCompleted - bCompleted;
            });
            
            sortedExercises.forEach((exercise, index) => {
                const originalIndex = currentWorkout.exercises.indexOf(exercise);
                const isCompleted = currentWorkout.completedExercises.includes(originalIndex);
                const exerciseEl = document.createElement('div');
                exerciseEl.className = `workout-exercise-item ${isCompleted ? 'workout-exercise-completed' : ''}`;
                exerciseEl.innerHTML = `
                    <div class="workout-exercise-info">
                        <div class='workout-exercise-name'>${exercise.name}</div>
                        <div class='workout-exercise-details'>${exercise.sets} séries × ${exercise.reps} reps ${exercise.weight ? `@ ${exercise.weight} kg` : ''}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        ${isCompleted ? 
                            `<button class='workout-exercise-options-btn' onclick="openExerciseCompletedModal(${originalIndex})"><i class="bi bi-three-dots"></i></button>` :
                            `<button class='workout-exercise-btn' onclick="startExercise(${originalIndex})">Iniciar</button>`
                        }
                    </div>
                `;
                container.appendChild(exerciseEl);
            });
            
            // Mostrar botão de terminar treino sempre visível
            const finishBtn = document.getElementById('finishWorkoutBtn');
            finishBtn.style.display = 'block';
            finishBtn.disabled = false;
            
            showPage('workoutPage');
        }
        
        function closeWorkoutPage() {
            // Verificar se há um treino em progresso
            if (currentWorkout && currentWorkout.exercises.some((ex, index) => 
                !currentWorkout.completedExercises.includes(index) && ex.results && ex.results.length > 0
            )) {
                // Mostrar modal de confirmação para sair do treino
                document.getElementById('confirmExitModal').style.display = 'block';
            } else {
                // Não há progresso, pode sair sem confirmação
                confirmExitWorkout();
            }
        }
        
        function closeConfirmExitModal() {
            document.getElementById('confirmExitModal').style.display = 'none';
        }
        
        function confirmExitWorkout() {
            // Limpar o treino em progresso
            clearOngoingWorkout();
            currentWorkout = null;
            closeConfirmExitModal();
            showPage('mainPage');
        }
        
        // 3. Iniciar um exercício específico
        function startExercise(exerciseIndex) {
            if (!currentWorkout) return;
            
            currentExerciseIndex = exerciseIndex;
            const exercise = currentWorkout.exercises[exerciseIndex];
            
            document.getElementById('exerciseWorkoutTitle').textContent = exercise.name;
            document.getElementById('exerciseWorkoutTarget').textContent = `${exercise.sets} séries × ${exercise.reps} reps ${exercise.weight ? `@ ${exercise.weight} kg` : ''}`;
            
            // Criar os inputs para as séries
            const seriesGrid = document.getElementById('seriesGrid');
            seriesGrid.innerHTML = '';
            
            for (let i = 0; i < exercise.sets; i++) {
                const seriesItem = document.createElement('div');
                seriesItem.className = 'series-item';
                seriesItem.innerHTML = `
                    <div class="series-header">
                        <div class="series-number">Série ${i + 1}</div>
                    </div>
                    <div class="series-inputs">
                        <div class="input-group">
                            <label class="input-label">Repetições</label>
                            <input type="number" id="reps-${i}" class="series-input" min="0" value="${exercise.results[i] ? exercise.results[i].repetitions : ''}" placeholder="0">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Peso (kg)</label>
                            <input type="number" id="weight-${i}" class="series-input" step="0.5" min="0" value="${exercise.results[i] ? exercise.results[i].weight : ''}" placeholder="0">
                        </div>
                    </div>
                `;
                seriesGrid.appendChild(seriesItem);
            }
            
            // Configurar a série de aquecimento se existir
            const warmupCheckbox = document.getElementById('warmupCheckbox');
            const warmupRepsInput = document.getElementById('warmup-reps');
            const warmupWeightInput = document.getElementById('warmup-weight');
            
            if (exercise.warmup) {
                warmupCheckbox.checked = true;
                if (warmupRepsInput) warmupRepsInput.value = exercise.warmup.repetitions || '';
                if (warmupWeightInput) warmupWeightInput.value = exercise.warmup.weight || '';
            } else {
                warmupCheckbox.checked = false;
                if (warmupRepsInput) warmupRepsInput.value = '';
                if (warmupWeightInput) warmupWeightInput.value = '';
            }
            
            // Mostrar botão de terminar exercício sempre clicável
            document.getElementById('finishExerciseBtn').disabled = false;
            
            showPage('exerciseWorkoutPage');
        }
        
        function closeExerciseWorkout() {
            showWorkoutPage();
        }
        
        // 4. Alternar série de aquecimento
        function toggleWarmupSet() {
            const warmupCheckbox = document.getElementById('warmupCheckbox');
            const seriesGrid = document.getElementById('seriesGrid');
            
            if (warmupCheckbox.checked) {
                // Adicionar série de aquecimento
                const warmupItem = document.createElement('div');
                warmupItem.className = 'series-item';
                warmupItem.innerHTML = `
                    <div class="series-header">
                        <div class="series-number">Aquecimento</div>
                    </div>
                    <div class="series-inputs">
                        <div class="input-group">
                            <label class="input-label">Repetições</label>
                            <input type="number" id="warmup-reps" class="series-input" min="0" placeholder="0">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Peso (kg)</label>
                            <input type="number" id="warmup-weight" class="series-input" step="0.5" min="0" placeholder="0">
                        </div>
                    </div>
                `;
                seriesGrid.insertBefore(warmupItem, seriesGrid.firstChild);
            } else {
                // Remover série de aquecimento
                const warmupItem = seriesGrid.querySelector('.series-item:first-child');
                if (warmupItem && warmupItem.querySelector('#warmup-reps')) {
                    seriesGrid.removeChild(warmupItem);
                }
            }
        }
        
        // 5. Terminar exercício
        function finishExercise() {
            if (!currentWorkout) return;
            
            const exercise = currentWorkout.exercises[currentExerciseIndex];
            const results = [];
            let allFilled = true;
            
            // Verificar se todas as séries estão preenchidas
            for (let i = 0; i < exercise.sets; i++) {
                const reps = document.getElementById(`reps-${i}`).value;
                const weight = document.getElementById(`weight-${i}`).value;
                
                if (!reps || !weight) {
                    allFilled = false;
                    break;
                }
            }
            
            if (!allFilled) {
                // Mostrar modal de confirmação para terminar com séries em falta
                openConfirmFinishExerciseModal();
                return;
            }
            
            // Se todas as séries estão preenchidas, prosseguir normalmente
            actuallyFinishExercise();
        }
        
        function openConfirmFinishExerciseModal() {
            document.getElementById('confirmFinishExerciseModal').style.display = 'block';
        }
        
        function closeConfirmFinishExerciseModal() {
            document.getElementById('confirmFinishExerciseModal').style.display = 'none';
        }
        
        function confirmFinishExercise() {
            closeConfirmFinishExerciseModal();
            actuallyFinishExercise(true); // true = preencher séries em falta com 0
        }
        
        function actuallyFinishExercise(fillMissing = false) {
            if (!currentWorkout) return;
            
            const exercise = currentWorkout.exercises[currentExerciseIndex];
            exercise.results = [];
            
            // Processar série de aquecimento se existir
            const warmupCheckbox = document.getElementById('warmupCheckbox');
            if (warmupCheckbox.checked) {
                const warmupReps = document.getElementById('warmup-reps').value;
                const warmupWeight = document.getElementById('warmup-weight').value;
                
                if (warmupReps || warmupWeight) {
                    exercise.warmup = {
                        repetitions: warmupReps,
                        weight: warmupWeight
                    };
                }
            }
            
            // Processar séries normais
            for (let i = 0; i < exercise.sets; i++) {
                let reps = document.getElementById(`reps-${i}`).value;
                let weight = document.getElementById(`weight-${i}`).value;
                
                // Se estamos a preencher séries em falta
                if (fillMissing && (!reps || !weight)) {
                    reps = reps || '0';
                    weight = weight || '0';
                }
                
                if (reps && weight) {
                    exercise.results.push({
                        repetitions: reps,
                        weight: weight
                    });
                }
            }
            
            // Adicionar à lista de exercícios concluídos
            if (!currentWorkout.completedExercises.includes(currentExerciseIndex)) {
                currentWorkout.completedExercises.push(currentExerciseIndex);
                
                // MODIFICAÇÃO SOLICITADA: Atualizar objetivos do plano baseado no desempenho
                updatePlanTargetsBasedOnPerformance(currentWorkout, currentExerciseIndex);
            }
            
            // Guardar o treino em progresso
            saveOngoingWorkout(currentWorkout);
            
            // MODIFICAÇÃO SOLICITADA: Mover o exercício para o fundo da lista
            showWorkoutPage();
            
            showToast('Exercício terminado!');
        }
        
        // 6. Terminar treino
        function finishWorkout() {
            if (!currentWorkout) return;
            
            // Verificar se há exercícios não terminados
            const missingExercises = currentWorkout.exercises.filter((exercise, index) => 
                !currentWorkout.completedExercises.includes(index)
            );
            
            if (missingExercises.length > 0) {
                // Mostrar modal de confirmação para terminar com exercícios em falta
                openConfirmFinishWorkoutModal(missingExercises);
                return;
            }
            
            // Se todos os exercícios estão terminados, prosseguir normalmente
            actuallyFinishWorkout();
        }
        
        function openConfirmFinishWorkoutModal(missingExercises) {
            const list = document.getElementById('missingExercisesList');
            list.innerHTML = '';
            
            missingExercises.forEach(exercise => {
                const item = document.createElement('div');
                item.className = 'missing-exercise-item';
                item.textContent = exercise.name;
                list.appendChild(item);
            });
            
            document.getElementById('confirmFinishWorkoutModal').style.display = 'block';
        }
        
        function closeConfirmFinishWorkoutModal() {
            document.getElementById('confirmFinishWorkoutModal').style.display = 'none';
        }
        
        function confirmFinishWorkout() {
            closeConfirmFinishWorkoutModal();
            
            // Preencher exercícios não terminados com 0
            currentWorkout.exercises.forEach((exercise, index) => {
                if (!currentWorkout.completedExercises.includes(index)) {
                    // Marcar como concluído
                    currentWorkout.completedExercises.push(index);
                    
                    // Preencher séries não preenchidas com 0
                    if (!exercise.results) {
                        exercise.results = [];
                    }
                    
                    for (let i = 0; i < exercise.sets; i++) {
                        if (!exercise.results[i]) {
                            exercise.results[i] = { repetitions: '0', weight: '0' };
                        }
                    }
                }
            });
            
            // Agora terminar o treino normalmente
            actuallyFinishWorkout();
        }
        
        function actuallyFinishWorkout() {
            if (isWorkoutSaved) return;
            
            if (!currentWorkout) return;
            
            isWorkoutSaved = true;
            const finishBtn = document.getElementById('finishWorkoutBtn');
            finishBtn.disabled = true;
            finishBtn.textContent = 'A guardar...';
            
            try {
                // Calcular duração
                const endTime = new Date();
                const durationMs = endTime - new Date(currentWorkout.startTime);
                const minutes = Math.floor(durationMs / 60000);
                const seconds = Math.floor((durationMs % 60000) / 1000);
                
                currentWorkout.endTime = endTime.toISOString();
                currentWorkout.duration = `${minutes}m ${seconds}s`;
                
                // Guardar o treino no histórico
                const workouts = loadWorkoutsData();
                
                // Verificação de duplicados corrigida
                const workoutExists = workouts.some(w => 
                    new Date(w.startTime).getTime() === new Date(currentWorkout.startTime).getTime() && 
                    w.planId === currentWorkout.planId
                );
                
                if (!workoutExists) {
                    workouts.push(currentWorkout);
                    saveWorkoutsData(workouts);
                }
                
                // Atualizar histórico de exercícios
                updateExerciseHistory(currentWorkout);
                
                // Guardar uma referência ao treino atual antes de limpar
                const workoutForSummary = currentWorkout;
                clearOngoingWorkout();
                showWorkoutSummary(workoutForSummary);
                
                // Resetar o estado do botão após um breve delay
                setTimeout(() => {
                    isWorkoutSaved = false;
                    finishBtn.disabled = false;
                    finishBtn.textContent = 'Terminar Treino';
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao terminar treino:', error);
                showToast('Erro ao guardar treino');
                isWorkoutSaved = false;
                finishBtn.disabled = false;
                finishBtn.textContent = 'Terminar Treino';
            }
        }
        
        // 7. Mostrar resumo do treino
        function showWorkoutSummary(workout) {
            document.getElementById('summaryPlanName').textContent = workout.planName;
            document.getElementById('summaryDuration').textContent = workout.duration;

            const exercisesList = document.getElementById('summaryExercisesList');
            exercisesList.innerHTML = '';

            workout.exercises.forEach(exercise => {
                const exerciseEl = document.createElement('div');
                exerciseEl.className = 'summary-exercise';

                let setsHTML = '';
                let totalVolume = 0;
                let maxWeight = 0;
                
                if (exercise.results && exercise.results.length > 0) {
                    setsHTML = '<div style="margin-top: 8px;"><strong>Séries realizadas:</strong><br>';
                    exercise.results.forEach((set, i) => {
                        const reps = parseInt(set.repetitions) || 0;
                        const weight = parseFloat(set.weight) || 0;
                        const volume = reps * weight;
                        totalVolume += volume;
                        if (weight > maxWeight) maxWeight = weight;
                        
                        setsHTML += `Série ${i + 1}: ${reps} reps × ${weight} kg (${volume} kg)<br>`;
                    });
                    setsHTML += `</div><div style="margin-top: 4px;"><strong>Volume total:</strong> ${totalVolume} kg</div>`;
                    if (maxWeight > 0) {
                        setsHTML += `<div><strong>Peso máximo:</strong> ${maxWeight} kg</div>`;
                    }
                }

                // Verificar se o objetivo foi superado
                let objectiveHTML = '';
                const targetReps = parseInt(exercise.reps) || 0;
                const targetWeight = parseFloat(exercise.weight) || 0;
                const targetVolume = targetReps * targetWeight;
                
                if (totalVolume > targetVolume && targetVolume > 0) {
                    objectiveHTML = `<div style="margin-top: 8px; padding: 8px; background: rgba(46,125,50,0.2); border-radius: 8px; border-left: 4px solid var(--primary);">
                        <strong>🎉 Objetivo superado!</strong><br>
                        Objetivo anterior: ${targetReps} reps × ${targetWeight} kg = ${targetVolume} kg<br>
                        Novo recorde: ${totalVolume} kg (+${totalVolume - targetVolume} kg)
                    </div>`;
                } else if (targetVolume > 0) {
                    objectiveHTML = `<div style="margin-top: 8px;"><strong>Objetivo:</strong> ${targetReps} reps × ${targetWeight} kg = ${targetVolume} kg</div>`;
                }

                exerciseEl.innerHTML = `
                    <div class="summary-exercise-name">${exercise.name}</div>
                    <div class="summary-exercise-details">
                        ${objectiveHTML}
                        ${setsHTML}
                    </div>
                `;
                exercisesList.appendChild(exerciseEl);
            });

            showPage('workoutSummaryPage');
        }
        
        function closeWorkoutSummary() {
            showPage('mainPage');
        }
        
        // 8. Funções para o cronómetro
        function startTimer() {
            const timerBtn = document.getElementById('timerBtnSmall');
            
            if (timerInterval) {
                // Parar o cronómetro
                clearInterval(timerInterval);
                timerInterval = null;
                timerBtn.classList.remove('timer-active');
                timerBtn.innerHTML = '<i class="bi bi-stopwatch"></i>';
                timerSeconds = 120; // Reset para 2 minutos
            } else {
                // Iniciar o cronómetro
                timerBtn.classList.add('timer-active');
                updateTimerDisplay();
                
                timerInterval = setInterval(() => {
                    timerSeconds--;
                    updateTimerDisplay();
                    
                    if (timerSeconds <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        timerBtn.classList.remove('timer-active');
                        timerBtn.innerHTML = '<i class="bi bi-stopwatch"></i>';
                        timerSeconds = 120; // Reset para 2 minutos
                        showToast('Tempo esgotado!');
                    }
                }, 1000);
            }
        }
        
        function updateTimerDisplay() {
            const timerBtn = document.getElementById('timerBtnSmall');
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            timerBtn.innerHTML = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }
        
        // 9. Funções para informações do exercício durante o treino
        function showExerciseInfo() {
            let exerciseName;
            let exerciseData;
            
            // Se estamos no contexto de treino (executando um exercício)
            if (currentWorkout && currentExerciseIndex !== null) {
                exerciseName = currentWorkout.exercises[currentExerciseIndex].name;
                exerciseData = getExercisesData()[exerciseName] || { notes: '' };
            } else if (currentExercise) {
                // Se estamos na página de detalhes do exercício
                exerciseName = currentExercise;
                exerciseData = getExercisesData()[exerciseName] || { notes: '' };
            } else {
                return;
            }
            
            document.getElementById('exerciseInfoTitle').textContent = exerciseName;
            document.getElementById('exerciseInfoContent').innerHTML = `
                <p>${exerciseData.notes || 'Sem notas para este exercício.'}</p>
            `;
            
            document.getElementById('exerciseInfoModal').style.display = 'block';
        }
        
        function closeExerciseInfo() {
            document.getElementById('exerciseInfoModal').style.display = 'none';
        }
        
        // 10. Funções para o modal de detalhes do exercício concluído
        function openExerciseCompletedModal(exerciseIndex) {
            if (!currentWorkout || !currentWorkout.exercises || !currentWorkout.exercises[exerciseIndex]) {
                console.error('Exercício não encontrado no treino atual');
                return;
            }
            
            const exercise = currentWorkout.exercises[exerciseIndex];
            document.getElementById('completedExerciseTitle').textContent = exercise.name;
            
            let content = `
                <div class="exercise-completed-details">
                    <h3 style="margin-bottom: 8px;">Séries realizadas:</h3>
                    <div>
            `;
            
            if (exercise.results && exercise.results.length > 0) {
                exercise.results.forEach((set, index) => {
                    content += `<div class="exercise-completed-set">Série ${index+1}: ${set.repetitions} reps × ${set.weight} kg</div>`;
                });
            } else {
                content += `<div class="exercise-completed-set">Nenhuma série registada</div>`;
            }
            
            content += `</div>`;
            
            // Verificar se existe um plano associado para mostrar objetivos
            if (currentWorkout.planId) {
                const plans = loadPlansData();
                const plan = plans.find(p => p.id === currentWorkout.planId);
                
                if (plan && currentWorkout.dayIndex !== undefined && plan.days && plan.days[currentWorkout.dayIndex]) {
                    const day = plan.days[currentWorkout.dayIndex];
                    const planExercise = day.exercises.find(e => e.name === exercise.name);
                    
                    if (planExercise) {
                        const oldTarget = `${planExercise.sets}x${planExercise.reps} ${planExercise.weight}kg`;
                        
                        content += `<div class="exercise-completed-target">
                            <strong>Objetivo:</strong> ${oldTarget}
                        </div>`;
                    }
                }
            }
            
            content += `</div>`;
            document.getElementById('completedExerciseContent').innerHTML = content;
            document.getElementById('exerciseCompletedModal').style.display = 'block';
        }
        
        function closeExerciseCompletedModal() {
            document.getElementById('exerciseCompletedModal').style.display = 'none';
        }
        
        // 11. Funções para atualizar objetivos do plano
        function updatePlanTargetsBasedOnPerformance(workout, exerciseIndex) {
            if (!workout || !workout.exercises || !workout.exercises[exerciseIndex]) {
                console.error('Dados do workout ou exercício inválidos');
                return false;
            }
            
            const plans = loadPlansData();
            const planIndex = plans.findIndex(p => p.id === workout.planId);
            
            if (planIndex === -1) {
                console.error('Plano não encontrado');
                return false;
            }

            const plan = plans[planIndex];
            
            // Verificar se dayIndex existe e é válido
            if (workout.dayIndex === undefined || workout.dayIndex === null) {
                console.error('dayIndex não definido no workout');
                return false;
            }
            
            if (!plan.days || !plan.days[workout.dayIndex]) {
                console.error('Dia não encontrado no plano');
                return false;
            }
            
            const day = plan.days[workout.dayIndex];
            let updated = false;
            
            const workoutExercise = workout.exercises[exerciseIndex];
            
            // Verificar se o dia tem exercícios
            if (!day.exercises) {
                console.error('Dia não tem exercícios definidos');
                return false;
            }
            
            const planExercise = day.exercises.find(e => e.name === workoutExercise.name);
            
            if (!planExercise || !workoutExercise.results) {
                return false;
            }

            const planReps = parseInt(planExercise.reps) || 0;
            const planWeight = parseFloat(planExercise.weight) || 0;
            const planTotalLoad = planReps * planWeight;
            
            // Encontrar a série com a maior carga total
            let bestTotalLoad = 0;
            let bestReps = 0;
            let bestWeight = 0;
            
            workoutExercise.results.forEach(set => {
                const reps = parseInt(set.repetitions) || 0;
                const weight = parseFloat(set.weight) || 0;
                const totalLoad = reps * weight;
                
                if (totalLoad > bestTotalLoad) {
                    bestTotalLoad = totalLoad;
                    bestReps = reps;
                    bestWeight = weight;
                }
            });
            
            // Verificar se a carga total foi melhor e atualizar se necessário
            if (bestTotalLoad > planTotalLoad) {
                // Atualizar ambos - repetições e peso - para os valores da melhor série
                planExercise.reps = bestReps.toString();
                planExercise.weight = bestWeight.toString();
                
                showToast(`Objetivo atualizado: ${workoutExercise.name} - ${bestReps} reps × ${bestWeight} kg`);
                updated = true;
            }
            
            if (updated) {
                plans[planIndex] = plan;
                savePlansData(plans);
                
                // Atualizar a visualização se estivermos na página de detalhes do plano
                if (currentPage === 'planDetailPage' && currentPlanDetail && currentPlanDetail.id === plan.id) {
                    renderPlanDaysDetail(plan.days);
                }
                
                return true;
            }
            
            return false;
        }
        
        // ===== Funções para o Histórico de Exercícios =====
        function updateExerciseHistory(workout) {
            const data = loadExercisesData();
            
            workout.exercises.forEach(exercise => {
                if (!exercise.results || exercise.results.length === 0) return;
                
                if (!data[exercise.name]) {
                    data[exercise.name] = { notes: '', history: [] };
                }
                
                // Calcular estatísticas para este exercício neste treino
                let totalReps = 0;
                let totalVolume = 0;
                let maxWeight = 0;
                let weightCount = 0;
                let totalWeight = 0;
                
                exercise.results.forEach(set => {
                    const reps = parseInt(set.repetitions) || 0;
                    const weight = parseFloat(set.weight) || 0;
                    
                    totalReps += reps;
                    totalVolume += reps * weight;
                    
                    if (weight > maxWeight) {
                        maxWeight = weight;
                    }
                    
                    if (weight > 0) {
                        totalWeight += weight;
                        weightCount++;
                    }
                });
                
                const averageWeightPerRep = totalReps > 0 ? totalVolume / totalReps : 0;
                const averageWeight = weightCount > 0 ? totalWeight / weightCount : 0;
                
                // Adicionar ao histórico
                data[exercise.name].history.push({
                    startTime: workout.startTime,
                    endTime: workout.endTime,
                    sets: exercise.results,
                    totalReps,
                    totalVolume,
                    maxWeight,
                    averageWeight,
                    averageWeightPerRep
                });
            });
            
            saveExercisesData(data);
        }
        
        // ===== Funções para Gerir Treino em Progresso =====
        function saveOngoingWorkout(workout) {
            try {
                localStorage.setItem(storageKeys.ONGOING_WORKOUT, JSON.stringify(workout));
                ongoingWorkout = workout;
                updateResumeWorkoutCard();
            } catch (e) {
                console.error('Erro ao guardar treino em progresso:', e);
            }
        }
        
        function clearOngoingWorkout() {
            localStorage.removeItem(storageKeys.ONGOING_WORKOUT);
            ongoingWorkout = null;
            currentWorkout = null;
            
            // Atualizar o card de retomar treino na página principal
            updateResumeWorkoutCard();
        }
        
        function updateResumeWorkoutCard() {
            const resumeCard = document.getElementById('resumeWorkoutCard');
            const resumeDetails = document.getElementById('resumeWorkoutDetails');
            
            if (ongoingWorkout) {
                const completedCount = ongoingWorkout.completedExercises.length;
                const totalCount = ongoingWorkout.exercises.length;
                
                resumeDetails.textContent = `${completedCount}/${totalCount} exercícios concluídos`;
                resumeCard.style.display = 'flex';
            } else {
                resumeCard.style.display = 'none';
            }
        }
        
        function resumeWorkout() {
            if (!ongoingWorkout) return;
            
            currentWorkout = ongoingWorkout;
            showWorkoutPage();
        }
        
        // ===== Funções Auxiliares =====
        function showPage(pageId){ 
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); 
            document.getElementById(pageId).classList.add('active'); 
            currentPage = pageId;
            
            // Atualizar a navbar
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const navMap = {
                'mainPage': 0,
                'exercisesPage': 1,
                'plansPage': 2,
                'workoutsPage': 3,
                'weightPage': 4
            };
            if (navMap[pageId] !== undefined) {
                document.querySelectorAll('.nav-item')[navMap[pageId]].classList.add('active');
            }
            
            // Atualizar conteúdo específico da página
            if (pageId === 'mainPage') {
                updateResumeWorkoutCard();
            } else if (pageId === 'exercisesPage') {
                renderExercises();
            } else if (pageId === 'plansPage') {
                renderPlans();
            } else if (pageId === 'workoutsPage') {
                renderWorkouts();
            } else if (pageId === 'weightPage') {
                initWeight();
            }
        }
        
        function showToast(msg){ 
            const t=document.getElementById('toast'); 
            t.textContent=msg; 
            t.classList.add('show'); 
            setTimeout(()=>{ 
                t.classList.remove('show'); 
                // Mover o toast para fora do ecrã após a animação
                setTimeout(() => {
                    t.style.top = '-100px';
                }, 300);
            }, 3000); 
        }
        
        // Funções de armazenamento
        function loadWeightHistory(){ return JSON.parse(localStorage.getItem(storageKeys.WEIGHT_HISTORY))||[]; }
        function saveWeightHistory(h){ localStorage.setItem(storageKeys.WEIGHT_HISTORY,JSON.stringify(h)); }
        function loadExercisesData(){ return JSON.parse(localStorage.getItem(storageKeys.EXERCISES))||{}; }
        function saveExercisesData(d){ localStorage.setItem(storageKeys.EXERCISES,JSON.stringify(d)); }
        function loadPlansData(){ return JSON.parse(localStorage.getItem(storageKeys.PLANS))||[]; }
        function savePlansData(p){ localStorage.setItem(storageKeys.PLANS,JSON.stringify(p)); }
        function loadWorkoutsData(){ return JSON.parse(localStorage.getItem(storageKeys.WORKOUTS))||[]; }
        function saveWorkoutsData(w){ localStorage.setItem(storageKeys.WORKOUTS,JSON.stringify(w)); }

        // Inicialização
        function init(){
            // Inicializar peso
            initWeight();
            
            // Carregar plano selecionado
            selectedPlanId = localStorage.getItem(storageKeys.SELECTED_PLAN);
            if(selectedPlanId){
                const plans=loadPlansData();
                const plan=plans.find(p=>p.id===selectedPlanId);
                if(plan){
                    document.getElementById('selectedPlanLabel').textContent=plan.name;
                    
                    // Garantir que os dias existem
                    if (!plan.days) {
                        plan.days = [];
                    }
                    
                    renderSelectedPlanDays(plan.days);
                }
            }
            
            // Renderizar páginas iniciais
            renderExercises();
            renderPlans();
            renderWorkouts();
            
            // Atualizar card de retomar treino
            updateResumeWorkoutCard();
            
            // Mostrar página inicial
            showPage('mainPage');
        }

        // Iniciar a aplicação
        init();
    </script>
</body>
</html>
